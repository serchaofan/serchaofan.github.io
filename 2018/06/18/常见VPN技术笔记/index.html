<!DOCTYPE html>






  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/mylogo-apple.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/mylogo-32x32.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/mylogo-16x16.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="华三网络学习笔记（理论） 本篇包含以下知识点  VPN概述 GRE-VPN L2TP-VPN IPSEC-VPN GRE-OVER-IPSEC IPSEC-OVER-GRE   MPLS BGP-MPLS-VPN SSL-VPN">
<meta name="keywords" content="网络,vpn">
<meta property="og:type" content="article">
<meta property="og:title" content="常见VPN技术笔记">
<meta property="og:url" content="https://github.com/serchaofan/serchaofan.github.io/2018/06/18/常见VPN技术笔记/index.html">
<meta property="og:site_name" content="tdLaogu的小站">
<meta property="og:description" content="华三网络学习笔记（理论） 本篇包含以下知识点  VPN概述 GRE-VPN L2TP-VPN IPSEC-VPN GRE-OVER-IPSEC IPSEC-OVER-GRE   MPLS BGP-MPLS-VPN SSL-VPN">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/1.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/2.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/3.jpg">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/4.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/5.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/6.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/7.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/8.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/13.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/14.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/9.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/10.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/11.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/12.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/15.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/16.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/17.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/18.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/20.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/21.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/22.png">
<meta property="og:image" content="https://github.com/2018/06/18/常见VPN技术笔记/23.png">
<meta property="og:updated_time" content="2018-09-04T10:51:09.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="常见VPN技术笔记">
<meta name="twitter:description" content="华三网络学习笔记（理论） 本篇包含以下知识点  VPN概述 GRE-VPN L2TP-VPN IPSEC-VPN GRE-OVER-IPSEC IPSEC-OVER-GRE   MPLS BGP-MPLS-VPN SSL-VPN">
<meta name="twitter:image" content="https://github.com/2018/06/18/常见VPN技术笔记/1.png">






  <link rel="canonical" href="https://github.com/serchaofan/serchaofan.github.io/2018/06/18/常见VPN技术笔记/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>常见VPN技术笔记 | tdLaogu的小站</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">tdLaogu的小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签<span class="badge">114</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档<span class="badge">74</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/serchaofan/serchaofan.github.io/2018/06/18/常见VPN技术笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tdLaogu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tdLaogu的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">常见VPN技术笔记
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-06-18 09:00:37" itemprop="dateCreated datePublished" datetime="2018-06-18T09:00:37+08:00">2018-06-18</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-09-04 18:51:09" itemprop="dateModified" datetime="2018-09-04T18:51:09+08:00">2018-09-04</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><strong>华三网络学习笔记（理论）</strong></p>
<p>本篇包含以下知识点</p>
<ul>
<li><a href="#VPN概述">VPN概述</a></li>
<li><a href="#GRE-VPN">GRE-VPN</a></li>
<li><a href="#L2TP-VPN">L2TP-VPN</a></li>
<li><a href="#IPSEC-VPN">IPSEC-VPN</a><ul>
<li><a href="#GRE-OVER-IPSEC">GRE-OVER-IPSEC</a></li>
<li><a href="#IPSEC-OVER-GRE">IPSEC-OVER-GRE</a></li>
</ul>
</li>
<li><a href="#MPLS">MPLS</a></li>
<li><a href="#BGP-MPLS-VPN">BGP-MPLS-VPN</a></li>
<li><a href="#SSL-VPN">SSL-VPN</a><a id="more"></a>
</li>
</ul>
<h2 id="VPN概述"><a href="#VPN概述" class="headerlink" title="VPN概述"></a>VPN概述</h2><p>Virtual Private Network虚拟私有网，利用共享公共网络仿真WAN设施，构建私有的专用网络。基于IP的VPN体系的核心是使用Tunnel隧道技术。</p>
<p><strong>VPN的优势</strong></p>
<ul>
<li>快速构建，降低部署周期</li>
<li>与私有网络一样的安全性、可靠性与可管理性</li>
<li>提高了基础资源的利用率</li>
<li>简化了用户端的配置和维护工作</li>
</ul>
<img src="/2018/06/18/常见VPN技术笔记/1.png">
<p><strong>概念术语</strong></p>
<ul>
<li>承载协议：在公网传输时使用的协议</li>
<li>封装协议：用于标识承载协议中封装的数据包，放置在承载协议头与载荷协议头间</li>
<li>载荷协议：最初封装数据包的协议</li>
<li>隧道协议：决定如何实现隧道的协议</li>
</ul>
<img src="/2018/06/18/常见VPN技术笔记/2.png">
<p><strong>主要VPN技术</strong><br>L2 VPN技术</p>
<ul>
<li>L2TP VPN：二层隧道协议，可实现拨号VPN与专线VPN</li>
<li>PPTP VPN：点到点隧道协议，支持PPP在IP网络上的隧道封装，使用增强GRE技术为传输的PPP报文提供流控与拥塞控制的封装</li>
<li>MPLS L2 VPN：多协议标签交换<br>L3 VPN技术</li>
<li>GRE VPN：通用路由封装，可在任意协议中封装任意协议的封装方法</li>
<li>IPSEC VPN：IP安全，并不是单个协议，而是一系列协议组成的数据安全体系，包括AH、ESP、IKE等，实现对数据私密性、完整性保护与源校验</li>
<li>BGP/MPLS VPN：多协议BGP，利用MPLS与MP-BGP技术</li>
<li>SSL VPN：安全套接字层，使用SSL协议实现远程VPN</li>
</ul>
<h2 id="GRE-VPN"><a href="#GRE-VPN" class="headerlink" title="GRE-VPN"></a>GRE-VPN</h2><p>Generic Routing Encapsulation通用路由封装，是一种能在任意协议中封装任意协议的封装方法，可以直接使用GRE封装建立GRE隧道，为IP协议，协议号47。以下为<br>GRE封装包的格式。</p>
<img src="/2018/06/18/常见VPN技术笔记/3.jpg">
<p>GRE头包含了2字节的<code>Protocol Type</code>，用于指示载荷协议类型，<code>IP</code>协议为<code>0x0800</code>。此外还有扩展GRE头，增加了<code>Key</code>和<code>Sequence Number</code>，具备标识数据流和分组次序的能力。<br>IP协议使用协议号47标识GRE头，说明IP头后跟着GRE头。而GRE头中protocol type若为0x0800，说明GRE头后跟着IP头。</p>
<img src="/2018/06/18/常见VPN技术笔记/4.png">
<p>双方通过Tunnel接口（逻辑接口）建立隧道，再通过实际物理接口进行转发。tunnel口为载荷协议服务，物理口为承载协议服务。<br><img src="/2018/06/18/常见VPN技术笔记/5.png"></p>
<p>GRE隧道通信过程：</p>
<ol>
<li>隧道起点路由查找：隧道两端的路由器必须是私网边界路由器。收到数据包时查找ip路由表</li>
<li>加封装：查找路由表确认下一跳为tunnel口，则进行GRE封装。</li>
<li>承载协议路由转发：对封装后的包进行公网路由查询。</li>
<li>中途转发：即公网转发</li>
<li>解封装：到达对端私网边界路由器后，该路由器检查IP地址，若是自己则解开IP头，发现有GRE头，就交给目标Tunnel口，tunnel口解开GRE头</li>
<li>隧道终点路由转发：解开GRE头后，发现私网IP目的地址，然后查表转发。</li>
</ol>
<p>每个运行GRE的路由器只有一个路由表，公网和私网之间只能通过不同的路由加以区分，因此公网私网IP地址能重复，且公网私网必须采用不同策略。</p>
<ul>
<li>连接到私网的物理接口和Tunnel口属于私网路由AS，采用一致的私网路由策略。</li>
<li>连接到公网的物理接口属于公网路由AS，必须和公网采用一致的路由策略。</li>
</ul>
<p>优点：</p>
<ol>
<li>支持多种协议  </li>
<li>支持IP路由协议和组播 </li>
</ol>
<p>缺点：</p>
<ol>
<li>点对点隧道  </li>
<li>静态配置隧道  </li>
<li>缺乏安全性  </li>
<li>不可分配地址空间  </li>
<li>部署复杂</li>
</ol>
<p>静态路由配置：配置到达目的IP的私网网段路由，下一跳为对端Tunnel口的地址。<br>动态路由配置：将隧道和私网作为一个AS看待，动态路由需要将Tunnel口和私网都包括。</p>
<p>Tunnel口虚假状态：GRE本身不对隧道状态维护，系统默认根据接口状态设置Tunnel状态，即若物理链路中出现故障，物理口仍为UP，则隧道口也为UP，而此时隧道却不通。只存在于静态配置时。<br>解决：tunnel口keepalive机制：允许路由器探测隧道口的实际状态。路由器会从tunnel口周期发keepalive消息，默认周期10s，若连续3次未收到，则认为隧道不通，会自动删除该tunnel口为出接口的静态路由。</p>
<h2 id="L2TP-VPN"><a href="#L2TP-VPN" class="headerlink" title="L2TP-VPN"></a>L2TP-VPN</h2><p>对PPP协议链路提供隧道，允许二层链路端点和PPP会话点驻留在不同设备上，并采用分组交换技术进行信息交互。使用PSTN/ISDN拨号、xDSL直接连接到ISP位于本地的POP（存在点），或直接连接到Internet获得IP通信服务，然后ISP设备或用户设备建立L2TP通道连接对端。</p>
<p>L2TP特点：</p>
<ul>
<li>L2TP支持对用户和隧道的验证，和对客户端的动态地址分配。可使用PPP验证，也可使用LAC提供的AAA验证</li>
<li>具备点到网络特性。适合单个或少量接入</li>
<li>不提供加密，但可结合IPSec等加密</li>
<li>面向连接，为信息提供一定的可靠性</li>
</ul>
<p>L2TP组件：</p>
<ul>
<li>LAC：L2TP访问集中器，隧道就在LAC和LNS间建立</li>
<li>LNS：L2TP网络服务器</li>
<li>NAS：网络访问服务器，抽象概念，是远程访问的接入点，可以是LAC或LNS</li>
</ul>
<p>两种拓扑方式：</p>
<ol>
<li>独立LAC：ISP提供LAC，不依赖IP接入点。<br>条件：ISP支持L2TP，验证系统支持VPDN属性<br>特点：终端用户不需要配置VPN拨号软件，只需要执行普通拨号，登录一次就可以接入企业网。</li>
<li>客户LAC：远程系统安装VPDN客户端，直接对LNS发起连接请求。不依赖LAC，验证只能由LNS执行<br>条件：远程系统必须接入Internet，远程系统需要安装专用客户端软件并配置<br>特点：只需配置VPN软件即可与企业网建立VPN连接。对用户的验证只能由LNS端执行。</li>
</ol>
<p>L2TP封装：<br>L2TP以UDP/IP为承载协议，UDP端口号为1701。<br><img src="/2018/06/18/常见VPN技术笔记/6.png"><br>L2TP头中<code>Type</code>字段标识消息类型，若为1表示控制消息，若为0表示数据消息。<br><code>Tunnel ID</code>字段标识L2TP控制连接，即隧道标识符，是在隧道建立时通过<code>Assigned Tunnel ID AVP</code>交换的。<br><code>Session ID</code>字段用于标识一个隧道中的各个会话，是在隧道建立时通过<code>Assigned Session ID AVP</code>交换的。</p>
<blockquote>
<p>控制连接：在L2TP隧道内部，建立维护和释放会话与隧道<br>控制消息：LAC与LNS间交换的隧道内消息，用于对隧道操作。包含AVP（属性值对，通过发送AVP对隧道建立维护或释放，即管理隧道和会话）</p>
</blockquote>
<p>L2TP协议操作：</p>
<ol>
<li>建立控制连接：由PPP触发<br>（1）LAC使用任意UDP端口向LNS的UDP1701端口发起连接（<code>SCCRQ</code>打开控制连接请求）<br>（2）LNS将连接重定向到一个随机UDP端口并回应（<code>SCCRP</code>打开控制连接应答）<br>（3）LAC收到后返回确认（<code>SCCCN</code>打开控制连接已确认）<br>（4）LNS收到后再确认，隧道建立（<code>ZLB</code>零长度体）<br>若要执行隧道验证，可在<code>SCCRQ</code>或<code>SCCRP</code>中加上<code>Challenge AVP</code>（挑战AVP）发起验证，接收方要在回应中加上<code>Challenge Response AVP</code>（挑战响应AVP）。</li>
<li>建立会话：前提为控制连接的建立。由PPP模块触发<br>LAC发起：<br>（1）LAC向LNS发送<code>ICRQ</code>（入呼叫请求）发起会话建立<br>（2）LNS收到请求后返回<code>ICRP</code>（入呼叫应答）<br>（3）LAC收到应答后返回<code>ICCN</code>（入连接已连接）<br>（4）LNS再回应<code>ZLB</code>，会话建立<br>LNS发起：<br>（1）LNS发送<code>OCRQ</code>（出呼叫请求）发起会话建立<br>（2）LAC收到后返回<code>OCRP</code>（出呼叫应答）<br>（3）LAC执行呼叫，返回<code>OCCN</code>（出呼叫已连接）<br>（4）LNS收到后回应<code>ZLB</code>，会话建立<br>会使用<code>Tunnel ID</code>和<code>Session ID</code>区分不同隧道和会话</li>
<li>隧道状态维护<br>LAC与LNS互发<code>Hello</code>消息维持会话，默认周期60s，若三次未收到对方的Hello消息，则认为隧道断开。</li>
<li>关闭会话与控制链接<br>关闭会话：<br>（1）LAC发送<code>CDN</code>（呼叫断开通知），通知LNS关闭会话<br>（2）LNS收到后返回<code>ZLB</code>，并关闭会话<br>关闭控制连接：<br>（1）LAC发送<code>StopCCN</code>（停止控制连接通知），通知LNS关闭控制连接<br>（2）LNS收到后回应<code>ZLB</code>，并关闭控制连接</li>
<li>L2TP验证<br>1.对拨入的远程系统PPP验证<br>2.LAC与LNS间隧道验证<br>3.LNS对远程系统再次PPP验证。方式分为三种：<br> 1）代理验证：LAC将从远程系统得到的验证信息和自身的验证信息都发给LNS<br> 2）强制CHAP验证：LNS直接对远程系统进行CHAP验证<br> 3）LCP重协商：LNS与远程系统重新进行LCP协商，采用相应虚拟模板接口上配置的验证方式进行验证</li>
</ol>
<p>LAC端对远程系统用户的AAA验证包括：</p>
<ul>
<li>本地验证：需要LAC端配置本地用户名、密码、服务类型等信息，与用户输入的通过对比进行验证。</li>
<li>远程验证：需要与RADIUS或TACACS服务器协同验证，需要在RADIUS或TACACS服务器上配置用户验证信息，LAC将用户输入的信息发送给验证服务器进行验证。</li>
</ul>
<p><center>下图为：独立LAC隧道会话建立</center><br><img src="/2018/06/18/常见VPN技术笔记/7.png"></p>
<p><center>下图为：客户LAC隧道会话建立</center><br><img src="/2018/06/18/常见VPN技术笔记/8.png"></p>
<h2 id="IPSEC-VPN"><a href="#IPSEC-VPN" class="headerlink" title="IPSEC-VPN"></a>IPSEC-VPN</h2><p>一种网络层安全保障机制。可实现访问控制、机密性、完整性校验、数据源校验、拒绝重播报文等。IPSec是可扩展的体系，不受限于任何一种特定算法，可引入多种验证算法、加密算法、密钥管理机制。<br>缺点：复杂，消耗大量资源、数据延迟、点对点、不支持组播</p>
<h3 id="IPSec-SA"><a href="#IPSec-SA" class="headerlink" title="IPSec SA"></a>IPSec SA</h3><p>IPSec SA：IPSec安全联盟，安全服务通过SA实现。<br>SA是双方的安全协定，包括协议、算法、密钥。SA是单向的，入站和出站数据流分别由入站SA和出站SA处理。</p>
<p>SA的三元组：</p>
<ol>
<li>SPI：安全参数索引，32位数值</li>
<li>IP目的地址：对方IP地址</li>
<li>安全协议标识符：标识AH或ESP</li>
</ol>
<p>SA建立方式：</p>
<ol>
<li>手工配置：两端手动设置参数</li>
<li>自动协商：双方通过IKE生成维护</li>
</ol>
<p>SA具有生存时间，有两种方式：</p>
<ol>
<li>时间：每隔定时长更新SA</li>
<li>流量：每传输一定流量更新SA</li>
</ol>
<p>SA协商信息存放在SPD（安全策略数据库），SPD的项指向SAD（安全联盟数据库）相应项</p>
<h3 id="IKE"><a href="#IKE" class="headerlink" title="IKE"></a>IKE</h3><p>IKE：因特网密钥交换。基于UDP协议，端口号500，为IPSec提供自动协商交换密钥、建立SA服务，实际提供安全服务的是IPSec，采用DH算法交换密钥（精髓）。且可以定时更新密钥和SA，提供了完善的前向安全性。可以为IPSec自动重新建立SA，允许IPSec提供抗重播服务（通过SPI值）。</p>
<p>采用ISAKMP的密钥交换框架体系<br><strong>IKE安全机制：</strong></p>
<ol>
<li>身份验证：预共享密钥（默认）、RSA数字签名、DES数字签名</li>
<li>DH密钥交换</li>
<li>PFS完善前向安全性：通过在第二阶段再进行一次DH交换，使IKE SA密钥与IPSec SA密钥无派生关系</li>
</ol>
<p><strong>协商两个阶段：</strong></p>
<ul>
<li>阶段1：建立一个IKE SA，为阶段2提供保护<br>分为主模式main和野蛮模式aggressive</li>
</ul>
<p>主模式：强制实现的阶段1交换模式。共三步，六条消息</p>
<ol>
<li>策略协商：A向B发送本地IKE策略，B查找匹配的策略，并确认<br>其中协商属性包括：加密算法，散列算法（MD5、SHA等），验证方法（预共享密钥、DSS、RSA），DH组信息（默认MODP 768），DH公共值，IKE生存时间，身份信息</li>
<li>DH交换：A向B发起密钥生成信息，B生成密钥并回应。</li>
<li>ID交换验证：A向B发送身份和验证数据，B回应身份验证。<img src="/2018/06/18/常见VPN技术笔记/13.png">
</li>
</ol>
<p>野蛮模式：远程拨号时，由于拨号用户IP无法确定，可以使用野蛮模式</p>
<ol>
<li>A向B发送本地IKE策略，开始DH交换</li>
<li>B查找匹配策略，回应验证信息</li>
<li>A接收确认信息并验证，生成密钥，向B发送验证载荷</li>
<li>B验证<img src="/2018/06/18/常见VPN技术笔记/14.png">
</li>
</ol>
<ul>
<li>阶段2：在IKE SA的保护下完成IPSec SA的协商。采用快速模式</li>
</ul>
<blockquote>
<p>野蛮模式安全性差于主模式，但过程简单快速。<br>在不知道对端IP且需要使用预共享密钥的情况下，必须用野蛮模式。</p>
</blockquote>
<h3 id="IPSec包处理流程"><a href="#IPSec包处理流程" class="headerlink" title="IPSec包处理流程"></a>IPSec包处理流程</h3><p><strong>出站包处理：</strong></p>
<ol>
<li>查找SPD，三种结果：丢弃、旁路安全服务：直接转发、提供安全服务：查找IPSec SA</li>
<li>若第一步结果是提供安全服务，就在SAD中找IPsec SA，若找到就根据参数提供安全服务，若找不到就查找IKE SA</li>
<li>若找到IKE SA，就只要创建IPSec SA，若找不到IKE SA，就要先创建IKE SA，再创建IPSec SA。</li>
</ol>
<p><strong>入站包处理：</strong></p>
<ol>
<li>检查目的地址是否本地，若是则检查数据包是否被IPSec保护</li>
<li>若被IPSec保护，则查找IPSec SA，若不被IPSec 保护，则交给上层</li>
<li>若找到IPSec SA，则解封装，若未找到则丢弃</li>
</ol>
<h3 id="安全协议"><a href="#安全协议" class="headerlink" title="安全协议"></a>安全协议</h3><ul>
<li>AH：验证头，提供完整性保护、数据源验证、抗重播服务。不支持机密性保护。IP协议，协议号51。<br>AH头格式：<br>  <code>Next Header</code>：8位，指示AH头后的载荷协议类型<br>  <code>Payload Length</code>：8位，指示AH的长度并减2，单位为32位<br>  <code>SPI</code>：32位任意数值，用于和目的IP地址和安全协议标识结合，唯一标示一个SA<br>  <code>Sequence Number</code>：32位无符号整数，SA建立时为0，随着数据包发送而增大，接收方通过该值确定数据包的序列<br>  <code>Authentication Data</code>：包含该数据包的完整性校验值<code>ICV</code>（使用HMAC算法对IP头+AH头+载荷+共享密钥加密计算），变长且必须是32位的整数倍。AH强制实现<code>HMAC-MD5-96</code>和<code>HMAC-SHA-1-96</code>两种验证算法</li>
<li>ESP：封装安全载荷，有AH所有功能且支持加密。包含ESP头和ESP尾。IP协议，协议号50。<br>ESP头格式：<br>  <code>Next Header</code>：同上。强制包含。<br>  <code>SPI</code>：同上<br>  <code>Sequence Number</code>：同上<br>  <code>Payload Data</code>：<code>Next Header</code>描述的数据，即载荷数据，长度为字节的整数倍。若加密，ESP强制实现了基础加密算法DES-CBC。强制包含。<br>  <code>Padding</code>：填充，使载荷数据达到指定长度。<br>  <code>Pad Length</code>：填充长度，范围为0到255。强制包含。<br>  <code>Authentication Data</code>：ICV，长度由验证算法决定。可选，验证服务开启时才包含。同样强制实现<code>HMAC-MD5-96</code>和<code>HMAC-SHA-1-96</code><br>ESP尾格式：<code>Padding</code>、<code>Pad Length</code>、<code>Next Header</code></li>
</ul>
<p>IPSec有两种工作模式：</p>
<ul>
<li>传输模式：保护端到端安全，两个终端间直接运行IPSec，所有加解密、协商都是<strong>端系统</strong>完成，网络设备完全不参与IPSec，只进行正常路由转发。</li>
<li>隧道模式：保护站点到站点安全，两个<strong>安全网关</strong>间运行IPSec，整个数据包都计算AH或ESP头，AH或ESP头加上数据都被封装在一个新的IP包中。所有加解密、协商都是安全网关完成，终端主机不参与。</li>
</ul>
<p>因此AH和ESP对两种工作模式分别有封装的方式：</p>
<ul>
<li><p><strong>AH</strong></p>
<ul>
<li><p><strong>传输模式</strong><br>原IP包、AH头与密钥通过散列函数（如RSA）生成校验值。<br>将校验值封装在AH头中，再由TCP和原IP头封装。</p>
<img src="/2018/06/18/常见VPN技术笔记/9.png">
</li>
<li><p><strong>隧道模式</strong><br>新IP头（根据隧道起点终点建立隧道IP头）、AH头与原IP包生成校验值。<br>将校验值封装在AH头中，封装原IP包，再用新IP头封装。</p>
<img src="/2018/06/18/常见VPN技术笔记/10.png">
</li>
</ul>
</li>
<li><p><strong>ESP</strong></p>
<ul>
<li><p><strong>传输模式</strong><br>原IP包（不包括原IP头）、ESP尾与密钥加密（通过DES等算法）生成密文。<br>将生成的密文与ESP头和验证密钥通过数字签名算法（通过RSA）生成校验值。<br>最后将用ESP头和原IP头封装密文和校验值。</p>
<img src="/2018/06/18/常见VPN技术笔记/11.png">
</li>
<li><p><strong>隧道模式</strong><br>将整个原IP包、ESP尾、加密密钥通过加密算法（如DES）生成密文。<br>将密文与ESP头和验证密钥通过散列函数（如RSA）生成校验值。<br>用ESP头和新IP头封装密文和校验值。</p>
<img src="/2018/06/18/常见VPN技术笔记/12.png">
</li>
</ul>
</li>
</ul>
<h3 id="GRE-OVER-IPSEC"><a href="#GRE-OVER-IPSEC" class="headerlink" title="GRE-OVER-IPSEC"></a>GRE-OVER-IPSEC</h3><p>使用<code>Gre Over IPsec</code>的原因：GRE不保证数据机密性与完整性，不能数据源验证。</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>GRE</th>
<th>IPSec</th>
</tr>
</thead>
<tbody>
<tr>
<td>多协议</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>虚接口</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>组播</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>路由协议</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>IP协议族</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>机密性</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>完整性</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>数据源验证</td>
<td>不支持</td>
<td>支持</td>
</tr>
</tbody>
</table>
<p>封装：原始IP包被封装在GRE隧道包中。GRE隧道包被封装在IPSec包中。</p>
<img src="/2018/06/18/常见VPN技术笔记/15.png">
<h3 id="IPSEC-OVER-GRE"><a href="#IPSEC-OVER-GRE" class="headerlink" title="IPSEC-OVER-GRE"></a>IPSEC-OVER-GRE</h3><h2 id="MPLS"><a href="#MPLS" class="headerlink" title="MPLS"></a>MPLS</h2><p>Multi Protocol Labal Switching：多协议标签交换<br>MPLS使用定长标签封装网络层分组。标签位于数据链路层和网络层之间，称为2.5层。<br>多协议指：MPLS被多种二层协议封装，也可封装多种三层协议</p>
<p>两种工作模式：</p>
<ol>
<li>帧模式：用于PPP、以太网、帧中继  </li>
<li>信元模式：作用于ATM</li>
</ol>
<p>组成：</p>
<ol>
<li>LSR：位于MPLS内部的核心交换机或路由器，提供标签交换和分发  </li>
<li>LER：位于MPLS网络边缘，提供标签映射、移除和分发</li>
</ol>
<p>FEC：转发等价类，转发过程中以等价方式处理的一组数据分组，可根据IP地址、隧道、COS标识创建FEC<br>LSP：标签交换通道，属于同一个FEC的数据流在每个节点赋予一个确定的标签，按照一个确定的标签转发表项进行转发，每个FEC流会有固定的转发路径，该路径就成为该FEC的LSP</p>
<p>MPLS标签：4个字节。分为四个字段</p>
<ol>
<li>Label：标签值，20位，标签转发表的关键索引</li>
<li>EXP：标识QoS优先级，3位</li>
<li>S：栈底标识，1位，若为1说明是最后一个标签，若为0说明后面还有MPLS标签。可实现多层MPLS标签嵌套</li>
<li>TTL：存活时间，8位，每经过一台LSR，TTL就减1<img src="/2018/06/18/常见VPN技术笔记/16.png">
</li>
</ol>
<p>链路层协议为MPLS分配的标识：</p>
<ol>
<li>PPP：0x0281</li>
<li>以太网或HDLC：0x8847</li>
<li>帧中继：0x0080</li>
</ol>
<p>标签分配协议：用于在LSR间分配标签，建立LSP。有以下四种：</p>
<ol>
<li>LDP标签分发协议：最通用</li>
<li>CR-LDP基于路由受限的标签分发协议：可进行路由约束、QoS，用于流量工程</li>
<li>RSVP-TE基于流量工程扩展的资源预留协议：用于流量工程中MPLS标签分配</li>
<li>MP-BGP多协议扩展BGP协议：为BGP路由分配MPLS标签</li>
</ol>
<p>LDP消息类型：</p>
<ol>
<li>发现<code>Discover</code>消息：LDP邻居的发现维护</li>
<li>会话<code>Session</code>消息：LDP邻居会话的建立维持与终止</li>
<li>通告<code>Advertisement</code>消息：向LDP邻居宣告Label、地址等信息</li>
<li>通知<code>Notification</code>消息：向LDP邻居通知事件或错误</li>
</ol>
<blockquote>
<p>所有LDP消息都采用TLV结构，具有扩展性（TLV：Type-Length-Value 类型-长度-值）</p>
</blockquote>
<p>LDP会话建立维护：</p>
<ol>
<li>邻居发现：互发<code>Hello</code>消息，组播地址<code>224.0.0.2</code>，UDP端口646</li>
<li>TCP连接：LSR-ID大的，即IP地址大的一方主动发起，TCP端口646</li>
<li>会话建立：Master发出初始化Initialization消息，携带协商参数。协商成功Session建立</li>
<li>会话维持：互发Keepalive消息维持会话。LSR之间发送Label mapping消息，形成标签转发表。期间若收到任何差错消息都会关闭会话，断开TCP连接。</li>
</ol>
<p>LDP邻居状态机：<br><strong>两台LDP邻居间建立<code>LDP Session</code>后，状态会维持在<code>Operational</code></strong><br><img src="/2018/06/18/常见VPN技术笔记/17.png"></p>
<p>标签分配过程：<br>上下游根据数据转发方向而定。<code>LDP Session</code>建立后路由器根据路由表分配标签，生成MPLS标签转发表<br>标签转发表包含：入标签<code>IN</code>，出标签<code>OUT</code>，出接口<code>next-hop</code><br>标签为随机生成，16以下系统保留</p>
<p>标签分配模式：</p>
<ol>
<li>DOD下游按需标记分配：上游LSR向下游LSR发送标签请求信息。下游LSR为此FEC分配标签，通过标签映射消息反馈给上游LSR。原则：下游设备需要收到上游的标签请求才能分配标签</li>
<li>DU下游自主标记分配：下游LSR在LDP会话建立后主动向上游LSR发布标签映射消息，不需等待上游请求</li>
</ol>
<p>标签控制模式：</p>
<ol>
<li>有序：只有最下游设备能分发标签，上游设备只有收到了下游的标签映射消息，才能再向上游发送标签映射信息。使得MPLS的转发是端到端的</li>
<li>独立：不管是不是最下游，不管是否收到下游的标签映射信息，都向上游发送标签映射信息。任何的数据流经过MPLS网络都可进行MPLS转发</li>
</ol>
<p>标签保持方式：收到下游的标签映射后，是否记录标签信息的原则</p>
<ol>
<li>保守：只保留下一跳邻居的标签，丢弃所有非下一跳邻居发来的标签<br>优点：节约空间<br>缺点：当网络故障时，LSP收敛较慢</li>
<li>自由：保留来自邻居的所有标签。<br>优点：网络故障后，路由切换时收敛快<br>缺点：消耗空间</li>
</ol>
<blockquote>
<p>常用组合：DU + 有序 + 自由</p>
</blockquote>
<p><strong>MPLS转发：</strong><br>第一阶段：标签PUSH：报文进入MPLS网络，LER设备发现报文目的IP地址有关联的标签，对报文进行压标签。该报文就变为了MPLS报文<br>第二阶段：标签SWAP：报文在MPLS网络内进行标签交换。<br>第三阶段：标签POP：报文转出MPLS网络时，在最后一跳弹出标签。倒数第二跳的设备上标签表的出标签为3，说明此为倒数第二跳。一旦包查找到出标签为3，就直接弹出标签。</p>
<h2 id="BGP-MPLS-VPN"><a href="#BGP-MPLS-VPN" class="headerlink" title="BGP-MPLS-VPN"></a>BGP-MPLS-VPN</h2><p>解决了传统VPN的问题：1.实现隧道动态建立  2.解决本地地址冲突问题  3.VPN私网路由易于控制</p>
<h3 id="多VPF组网"><a href="#多VPF组网" class="headerlink" title="多VPF组网"></a>多VPF组网</h3><p>多VRF技术用于解决同一台设备（PE）上地址冲突问题。<br>存在以下路由器角色：</p>
<ul>
<li>CE：直接与ISP相连的用户设备</li>
<li>PE：公网边缘路由器，与CE相连，负责VPN接入</li>
<li>P：公网核心路由器，负责路由与快速转发</li>
</ul>
<p>实现：将一台路由器划分为多个VRF，每个VRF相互独立，拥有各自的路由表、端口、协议，每个VRF类似一台虚拟路由器。未划分VRF的路由在公网路由表中。各个VRF与各自的网络运行一个实例，该实例学到的路由只能加入该VPN路由表。实例与所属VPN进行绑定。并且，端口与VPN绑定，与VRF绑定的接口只会出现在该VRF对应的路由表中，当报文从该接口进入路由器后只能查询该VRF对应的路由表。确保了不同VRF数据间不会冲突。<br><img src="/2018/06/18/常见VPN技术笔记/18.png"></p>
<p>多VRF与路由协议多实例：各VRF与各自用户网络之间运行一个路由实验，该路由实例学习到的路由只能加入该VPN的路由表。各个路由实例与所属VPN绑定，互相独立，只能学到各自的邻居信息。</p>
<h3 id="MP-BGP"><a href="#MP-BGP" class="headerlink" title="MP-BGP"></a>MP-BGP</h3><p>MP-BGP（Multi　Protocol BGP，多协议BGP）是对BGP根据特性（TCP连接、TLV扩展属性位）进行扩展的协议。<br>MP-BGP相对于BGP的新增特性：</p>
<ul>
<li>普通BGP只能传递IPv4信息，MP-BGP能承载多个协议路由信息。</li>
<li>新增了<code>MP_REACH_NLRI</code>和<code>MP_UNREACH_NLRI</code>两个属性，并新增了扩展团体属性（Extended_Communities）。</li>
<li>MP-BGP可传递BGP MPLS VPN、L2VPN、6PE等路由信息。</li>
</ul>
<blockquote>
<p><code>MP_REACH_NLRI</code>和<code>MP_UNREACH_NLRI</code>两个属性都是路由更新消息属性。<br><code>MP_REACH_NLRI</code>代替了原BGP更新消息中的<code>NLRI</code>和<code>Next-hop</code>。增加了地址族的描述Address-Family、私网Label和RD，包含原有的Next-hop。<br>若地址族描述为VPNv4，则NLRI包含两个部分，一个是私网标签（一个MPLS标签），第二部分是VPNv4地址（RD+IPv4地址）<br><code>MP_UNREACH_NLRI</code>代替了原BGP更新消息中的<code>Withdrawn Routes</code>。可撤销通过<code>MP_REACH_NLRI</code>发布的各种地址族的路由。包含<code>Address-Family</code>和<code>Withdrawn Routes</code>。</p>
</blockquote>
<p><strong>VPNv4地址族主要用于PE路由器间传递VPN路由，并只存在于MP-BGP路由信息和PE设备的私网路由表中，即只出现在路由的发布学习过程中，在穿越ISP公网时，数据包头是没有VPNv4地址的。</strong></p>
<p><center>下图为MP_REACH_NLRI属性</center><br><img src="/2018/06/18/常见VPN技术笔记/20.png"></p>
<p><center>下图为MP_UNREACH_NLRI属性</center><br><img src="/2018/06/18/常见VPN技术笔记/21.png"></p>
<p>BGP的扩展团体属性：RT（Route Target）路由目标。本质是每个VPN实例表达自己的路由取舍方式。<br>RT的格式有三种，都表示RT。<br><img src="/2018/06/18/常见VPN技术笔记/22.png"></p>
<ul>
<li><code>0x0002</code>：2字节的AS号，加上4字节的用户自定义数字，如<code>100:1</code>、<code>200:1</code></li>
<li><code>0x0102</code>：4字节的IP地址，加上2字节的用户自定义数字，如<code>192.168.1.1:1</code>、<code>10.1.1.1:2</code></li>
<li><code>0x0202</code>：4字节的AS号，加上2字节的用户自定义数字</li>
</ul>
<blockquote>
<p>　通常设置为冒号后的数字设置为VPN实例编号。</p>
</blockquote>
<p>RT由两个部分组成：<code>Export Target</code>和<code>Import Target</code>。MP-BGP在PE间交互私网路由时，需要遵循以下规则：</p>
<ul>
<li>在PE设备上，发送某一个VPN用户的私网路由给BGP邻居时，需要在扩展团体属性区域中增加该VPN的<code>Export Target</code>属性。</li>
<li>在PE设备上，需要将收到的MP-BGP路由的扩展团体属性中携带的RT值与本地每个VPN的<code>Import Target</code>对比，若存在交集，则可以将该路由添加进实例的路由表。</li>
</ul>
<p>通过对RT的操作可实现两种模式：<code>Hub-Spoke</code>和<code>Extranet</code>。<br><code>Hub-Spoke</code>模式：用户总部可与每个分布互通，但每个VPN分布之间禁止互通。<br><code>Extranet</code>模式：使指定的节点可以与其他节点互通。<br><img src="/2018/06/18/常见VPN技术笔记/23.png"></p>
<p>RD（Route Distinguisher）路由区分。本质就是用于私网路由的撤销，因为在撤销路由时是不能携带属性值的（包括RT），PE在删除路由时无法判断撤销哪个VPN的路由。长度6字节。<br>RD有两种格式：</p>
<ul>
<li>2字节的AS号，加上4字节用户自定义数，如<code>100:1</code></li>
<li>4字节的IP地址，加上2字节用户自定义数，如<code>192.168.1.1:1</code></li>
</ul>
<p>只要保证存在相同地址的两个VPN实例的RD不同即可，但最好为每个VPN实例配置一个RD。若两个VPN实例中存在相同IP地址，则这两个实例一定不能互访，间接互访也不行。</p>
<p>私网标签Label，用于帮助PE判断该报文前往的VPN，是通过MPLS的多标签嵌套实现的。</p>
<p>BGP MPLS VPN实现分为以下步骤：</p>
<ul>
<li>公网隧道建立：公网IGP协议开启，PE间互通。</li>
<li>本地VPN建立：PE上设置本地VPN并设置RD、RT属性，然后将VPN与接口绑定，即配置VRF。</li>
<li>私网路由的学习：PE与CE间运行路由协议多实例，各VPN实例进行路由学习。PE间建立MP-BGP邻居，下游LSR分配标签，建立标签转发表。并会生成一条MP-BGP更新消息，包含VPNv4路由前缀（即IP地址）、下一跳地址、RT属性、私网标签。PE设备会对比RT值，若通过就会记录该路由信息并发布给本地VPN。</li>
<li>私网数据转发：数据会根据标签转发表进行转发。</li>
</ul>

      
    </div>

    
      


    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/网络/" rel="tag"># 网络</a>
          
            <a href="/tags/vpn/" rel="tag"># vpn</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/06/FTP笔记/" rel="next" title="FTP笔记">
                <i class="fa fa-chevron-left"></i> FTP笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/07/06/Docker存储学习笔记/" rel="prev" title="Docker存储学习笔记-1">
                Docker存储学习笔记-1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">tdLaogu</p>
              <p class="site-description motion-element" itemprop="description">要抓紧时间赶快生活，因为一场莫名其妙的疾病，或者一个意外的悲惨事件，都会使生命中断。</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">74</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">114</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/serchaofan" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i></a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:624261309@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i></a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://geekchen.top/" title="SuperChen" target="_blank">SuperChen</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://geekfan.top/" title="Geekfan" target="_blank">Geekfan</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#VPN概述"><span class="nav-number">1.</span> <span class="nav-text">VPN概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GRE-VPN"><span class="nav-number">2.</span> <span class="nav-text">GRE-VPN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#L2TP-VPN"><span class="nav-number">3.</span> <span class="nav-text">L2TP-VPN</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IPSEC-VPN"><span class="nav-number">4.</span> <span class="nav-text">IPSEC-VPN</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#IPSec-SA"><span class="nav-number">4.1.</span> <span class="nav-text">IPSec SA</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IKE"><span class="nav-number">4.2.</span> <span class="nav-text">IKE</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPSec包处理流程"><span class="nav-number">4.3.</span> <span class="nav-text">IPSec包处理流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安全协议"><span class="nav-number">4.4.</span> <span class="nav-text">安全协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GRE-OVER-IPSEC"><span class="nav-number">4.5.</span> <span class="nav-text">GRE-OVER-IPSEC</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IPSEC-OVER-GRE"><span class="nav-number">4.6.</span> <span class="nav-text">IPSEC-OVER-GRE</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MPLS"><span class="nav-number">5.</span> <span class="nav-text">MPLS</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BGP-MPLS-VPN"><span class="nav-number">6.</span> <span class="nav-text">BGP-MPLS-VPN</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#多VPF组网"><span class="nav-number">6.1.</span> <span class="nav-text">多VPF组网</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MP-BGP"><span class="nav-number">6.2.</span> <span class="nav-text">MP-BGP</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tdLaogu</span>

  

  
</div>











        








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.2.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.2.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.2.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  
  

  


  
  

  

  

  

  

  

</body>
</html>
