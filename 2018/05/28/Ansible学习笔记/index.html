<!DOCTYPE html>






  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.2.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/mylogo-apple.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/mylogo-32x32.png?v=6.2.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/mylogo-16x16.png?v=6.2.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.2.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.2.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="本篇包含以下内容  Ansible结构 Ansible安装 Inventory Ansible常见模块 Playbook">
<meta name="keywords" content="ansible,运维,监控,自动化">
<meta property="og:type" content="article">
<meta property="og:title" content="Ansible基础学习笔记">
<meta property="og:url" content="https://github.com/serchaofan/serchaofan.github.io/2018/05/28/Ansible学习笔记/index.html">
<meta property="og:site_name" content="tdLaogu的小站">
<meta property="og:description" content="本篇包含以下内容  Ansible结构 Ansible安装 Inventory Ansible常见模块 Playbook">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://github.com/2018/05/28/Ansible学习笔记/0.png">
<meta property="og:image" content="https://github.com/2018/05/28/Ansible学习笔记/jiegou.png">
<meta property="og:image" content="https://github.com/2018/05/28/Ansible学习笔记/liucheng.png">
<meta property="og:updated_time" content="2018-11-01T12:34:59.899Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ansible基础学习笔记">
<meta name="twitter:description" content="本篇包含以下内容  Ansible结构 Ansible安装 Inventory Ansible常见模块 Playbook">
<meta name="twitter:image" content="https://github.com/2018/05/28/Ansible学习笔记/0.png">






  <link rel="canonical" href="https://github.com/serchaofan/serchaofan.github.io/2018/05/28/Ansible学习笔记/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Ansible基础学习笔记 | tdLaogu的小站</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">tdLaogu的小站</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签<span class="badge">90</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档<span class="badge">62</span></a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>
  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://github.com/serchaofan/serchaofan.github.io/2018/05/28/Ansible学习笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="tdLaogu">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="tdLaogu的小站">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Ansible基础学习笔记
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-05-28 00:01:18" itemprop="dateCreated datePublished" datetime="2018-05-28T00:01:18+08:00">2018-05-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2018-11-01 20:34:59" itemprop="dateModified" datetime="2018-11-01T20:34:59+08:00">2018-11-01</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>本篇包含以下内容</p>
<ul>
<li><a href="#Ansible结构">Ansible结构</a></li>
<li><a href="#Ansible安装">Ansible安装</a></li>
<li><a href="#Inventory">Inventory</a></li>
<li><a href="#Ansible常见模块">Ansible常见模块</a></li>
<li><a href="#Playbook">Playbook</a><a id="more"></a></li>
<li><a href="#Ansible变量">Ansible变量</a></li>
<li><a href="#Jinja2过滤器">Jinja2过滤器</a></li>
</ul>
<p>Ansible是一个部署一群远程主机的工具，使用SSH实现管理节点和远程节点间的通信，实现批量自动化操作。</p>
<img src="/2018/05/28/Ansible学习笔记/0.png">
<p>Ansible有企业版本的收费软件Ansible Tower，中心化的Ansible管理节点，向管理员提供web接口。实现：1. 管理员在Ansible Tower上使用分享主机的SSH密钥，但不能查看和复制私钥  2. Ansible的web上的所有管理员都可共享Playbook脚本  3. Ansible Tower可收集展示所有主机的Playbook执行情况。</p>
<p>Ansible Tower提供了一个数据库来存储inventory配置信息，这个数据库可以通过web访问，或通过REST访问。Tower与所有使用的Ansible动态inventory源保持同步，并提供了一个图形化的inventory编辑器。 </p>
<h1 id="Ansible结构"><a href="#Ansible结构" class="headerlink" title="Ansible结构"></a>Ansible结构</h1><p>Ansible具有以下核心组件：</p>
<ul>
<li>ansible core：ansible核心程序</li>
<li>Host Inventory：主机信息文件</li>
<li>Playbooks：剧本，用于简便管理主机</li>
<li>Core Modules：核心模块，Ansible通过模块进行管理</li>
<li>Custom Modules：自定义模块，补充核心模块的功能</li>
<li>Connection Plugins：连接插件，用于Ansible和主机的通信</li>
<li>Plugins：其他各种插件，提供连接或功能接口</li>
</ul>
<img src="/2018/05/28/Ansible学习笔记/jiegou.png">
<p>Ansible特性：</p>
<ul>
<li>基于Python实现，有三个关键模块：Paramiko（ssh连接插件）、PyYAML（YAML语言）、jinja2（定义模板，即Playbook）</li>
<li>部署简单，轻量级，无需在客户端安装agent，去中心化</li>
<li>默认使用SSH。1.基于密钥 2.在inventory文件指定密码</li>
<li>支持自定义模块，支持各种编程语言</li>
<li>主从模式master和slave</li>
<li>使用playbook进行主机管理</li>
<li>幂等性：一种操作重复多次结果相同，只需运行一次playbook就可将需要配置的机器都置为期望状态，同一台机器多次执行一个playbook是安全的</li>
<li>Ansible是模块化的，通过调用模块来实现管理</li>
<li>支持多层部署，可通过VM和容器为多层应用程序的部署配置提供支持</li>
<li>为架构的多个层次带来一致性，借助Ansible可通过编程操作计算架构中从基础设施到应用程序的每一层</li>
<li>Ansible支持异构IT环境，支持Windows和Linux及多个硬件平台和云平台</li>
</ul>
<img src="/2018/05/28/Ansible学习笔记/liucheng.png">
<p><strong>实验系统CentOS-7</strong><br><strong>主节点服务器：192.168.163.102</strong><br><strong>从节点服务器：192.168.163.103</strong></p>
<h1 id="Ansible安装"><a href="#Ansible安装" class="headerlink" title="Ansible安装"></a>Ansible安装</h1><p>首先安装epel-release，能够获得更多的Ansible包资源。  <code>yum install epel-release</code><br>然后安装Ansible  <code>yum install ansible</code></p>
<p>Ansible有以下配置文件：</p>
<ul>
<li><code>/etc/ansible/ansible.cfg</code>  主配置文件</li>
<li><code>/etc/ansible/hosts</code>  Inventory配置文件</li>
</ul>
<p>Ansible配置以ini格式存储数据，Ansible几乎所有配置都可通过Playbook或环境变量重新赋值。当运行Ansible命令时，会按照以下顺序查找并读取配置文件。</p>
<ol>
<li><code>ANSIBLE_CONFIG</code>：环境变量指定的路径</li>
<li><code>./ansible.cfg</code>：当前目录的ansible.cfg配置文件</li>
<li><code>~/ansible.cfg</code>：家目录的ansible.cfg配置文件</li>
<li><code>/etc/ansible/ansible.cfg</code>：ansible主配置文件</li>
</ol>
<p>Ansible主配置文件中的几个重要参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">inventory = /root/ansible/hosts   # inventory文件的位置</span><br><span class="line">library = /usr/share/my_modules/  # ansible模块位置</span><br><span class="line">forks = 5           # 默认情况下Ansible最多能有多少个进程同时工作，默认5个进程并行处理。</span><br><span class="line">                    # 可以根据控制端性能和被管理节点的数量来确定</span><br><span class="line">sudo_user = root    # 默认执行命令的用户</span><br><span class="line">remote_port = 22    # 指定连接被管理节点的管理端口，默认是22</span><br><span class="line">host_key_checking = False  # 是否检查SSH主机的密钥</span><br><span class="line">timeout = 20        # SSH连接的超时间隔，单位：秒</span><br><span class="line">log_path = /var/log/ansible.log   # Ansible默认不记录日志</span><br><span class="line"># 若开启了日志，则要通过该参数设置日志文件路径</span><br><span class="line"># 模块将会调用被管节点的rsyslog来记录，执行Ansible的用户需要有写入日志的权限</span><br><span class="line">remote_tmp     = ~/.ansible/tmp     # 远程主机的临时文件存放位置</span><br><span class="line">local_tmp      = ~/.ansible/tmp     # 本机的临时文件存放位置</span><br></pre></td></tr></table></figure></p>
<p>Ansible提供文档命令可查看指定的用法说明<br><code>ansible-doc</code>命令用于查看Ansible帮助文档<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-h 查看帮助</span><br><span class="line">-l 列出所有Ansible模块</span><br><span class="line">-s &lt;module&gt; 查找指定模块的用法</span><br></pre></td></tr></table></figure></p>
<p><strong>公钥认证</strong><br>Ansible默认开启公钥认证，Ansible主节点应该与所有要管理的节点进行ssh验证。主要使用以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen  创建密钥对</span><br><span class="line">ssh-copy-id -i ~/.ssh/id_rsa.pub root@&lt;节点IP地址&gt;</span><br></pre></td></tr></table></figure></p>
<p>然后在<code>/etc/ansible/hosts</code>添加该节点的IP地址</p>
<p>如果有个主机重新安装并在<code>/home/.ssh/known_hosts</code>文件中中有了不同的key，就会一直提示错误。<br>若节点主机未进行公钥认证，即没有在该文件中初始化，则每次使用ansible命令时都会要求确认key信息。</p>
<p>若要禁用ansible确认密钥的行为，可在主配置文件中参数<code>host_key_checking = False</code>设置，也可以通过环境变量<code>ANSIBLE_HOST_KEY_CHECKING=False</code>设置。</p>
<p><strong>ansible主命令</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible  &lt;host-pattern&gt; [options]</span><br><span class="line">	# host-pattern可填inventory的组名，ip地址，all（所有主机）</span><br><span class="line">	# 一些简单常用参数</span><br><span class="line">	-f 设置一次处理的主机个数，即并行执行</span><br><span class="line">	-m 设置使用的模块</span><br><span class="line">	-a 模块的参数</span><br><span class="line">	-i 指定inventory文件</span><br></pre></td></tr></table></figure></p>
<h1 id="Inventory"><a href="#Inventory" class="headerlink" title="Inventory"></a>Inventory</h1><p>Ansible可同时操作属于一个组的多台主机,组和主机之间的关系通过inventory文件配置，默认的文件路径为<code>/etc/ansible/hosts</code>。<br>inventory文件遵循INI文件风格，方括号[]中是组名,用于对系统进行分类,便于对不同系统进行个别的管理。一个系统可以属于不同的组，属于两个组的变量都可以为这台主机所用。组名可自定义。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># 可以直接写要管理的主机IP地址或域名</span><br><span class="line">192.168.163.103</span><br><span class="line"></span><br><span class="line">#也可设置管理组</span><br><span class="line">[test]</span><br><span class="line">192.168.163.103</span><br><span class="line">system[1:5].example.com</span><br><span class="line"># 数字简写模式，表示system1--sysetm5</span><br><span class="line"># 也支持字母简写，system[a:f].example.com</span><br><span class="line"></span><br><span class="line"># 可对每个服务器设置连接类型和连接用户名</span><br><span class="line">localhost  ansible_connection=local</span><br><span class="line">system3.example.com  ansible_connection=ssh  ansible_ssh_user=ansible</span><br><span class="line"></span><br><span class="line"># 可定义变量，可使用变量定义的配置主机变量</span><br><span class="line">host1  http_port=80  maxRequestsPerChild=808</span><br><span class="line"># 也可定义组变量</span><br><span class="line">[test:vars]</span><br><span class="line">ntp_server=ntp.example.com</span><br><span class="line"></span><br><span class="line"># 还可组嵌套，即在其他组中引用一个组</span><br><span class="line"># 这些变量可以给ansible-playbook使用,但不能给ansible使用。</span><br><span class="line">[team1]</span><br><span class="line">host1</span><br><span class="line">[team2]</span><br><span class="line">host2</span><br><span class="line">[test:hosts]</span><br><span class="line">team1</span><br><span class="line">team2</span><br></pre></td></tr></table></figure>
<p>当Inventory中存在有效主机时，ansible就默认隐式地可以使用<code>localhost</code>作为本机，但inventory中没有任何主机时是不允许使用它的，且<code>all</code>或<code>*</code>所代表的所有主机也不会包含localhost。</p>
<p>一些常见的Inventory参数：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ansible_ssh_host    # ansible使用ssh要连接的主机</span><br><span class="line">ansible_ssh_port    # ssh的端口。默认为22</span><br><span class="line">ansible_ssh_user    # ssh登录的用户名。默认为root</span><br><span class="line">ansible_ssh_pass    # ssh登录远程用户时的认证密码</span><br><span class="line">	# 不安全，最好使用 --ask-pass</span><br><span class="line">ansible_sudo_pass   # sudo命令输入的root密码（当使用非root用户操作时）</span><br><span class="line">	# 不安全，最好使用 --ask-sudo-pass</span><br><span class="line">ansible_connection   # 连接远程主机使用的模式，默认为smart智能模式</span><br><span class="line">	# smart：若本地ssh支持持久连接时采用ssh连接，否则采用python的paramiko ssh连接</span><br><span class="line">	# paramiko：python的ssh连接库</span><br><span class="line">ansible_ssh_private_key_file   # ssh登录远程用户时的认证私钥文件</span><br><span class="line">ansible_ssh_common_args      # 指定ssh、scp等命令的参数</span><br><span class="line">ansible_shell_type  # 指定远程主机执行命令时的shell解析器，默认为sh</span><br><span class="line">ansible_python_interpreter   # 远程主机上的python解释器路径。默认为/usr/bin/python</span><br></pre></td></tr></table></figure></p>
<p><strong>Inventory配置文件可以有多个，且可以通过Dynamic Inventory来动态生成</strong><br>只需在ansible的主配置文件中将<code>inventory</code>参数设置为对应的文件或目录即可，如果是目录，那么此目录下的所有文件都是inventory文件。</p>
<p>可创建多个独立文件用于保存变量，然后在主文件中引用<br><strong>注：这些独立文件的格式为YAML</strong><br>在独立文件<code>/etc/ansible/group_vars/servers</code>中添加</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">ntp_server: ntp.example.com</span><br><span class="line">database_server: system2.example.com</span><br></pre></td></tr></table></figure>
<p>然后在inventory文件中指定该文件<code>/etc/ansible/group_vars/servers</code><br>可以为一个主机，或一个组，创建一个目录，目录名就是主机名或组名。目录中的可以创建多个文件，文件中的变量都会被读取为主机或组的变量。</p>
<h1 id="Ansible常见模块"><a href="#Ansible常见模块" class="headerlink" title="Ansible常见模块"></a>Ansible常见模块</h1><h3 id="cron"><a href="#cron" class="headerlink" title="cron"></a>cron</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cron 计划任务模块</span><br><span class="line">	month         # 指定月份</span><br><span class="line">	minute        # 指定分钟</span><br><span class="line">	job           # 指定任务（需要state=present）</span><br><span class="line">	day           # 指定小时</span><br><span class="line">	hour          # 指定小时</span><br><span class="line">	weekday       # 周几</span><br><span class="line">	name          # 指定名称（默认为*）</span><br><span class="line">	user          # 使用的用户身份去执行</span><br><span class="line">	special_time  # 指定执行的时间</span><br><span class="line">	reboot        # 重启时</span><br><span class="line">	yearly        # 每年</span><br><span class="line">	# 还有annually  monthly  weekly  daily  hourly</span><br><span class="line">	state         # 添加或删除</span><br><span class="line">	present       # 安装</span><br><span class="line">	absent        # 移除</span><br><span class="line">	backup        # 对远程主机上原有任务计划做备份</span><br><span class="line">	cron_file     # 使用指定文件替换远程主机上/etc/cron.d/中的任务计划</span><br><span class="line"></span><br><span class="line">	例：ansible webserver -m cron -a &apos; minute=&quot;*/10&quot; job=&quot;/bin/echo hello&quot; name=&quot;test&quot; state=present &apos;</span><br></pre></td></tr></table></figure>
<h3 id="user"><a href="#user" class="headerlink" title="user"></a>user</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">user 用户账号管理</span><br><span class="line">	name         # 用户名</span><br><span class="line">	uid          # UID</span><br><span class="line">	state        # 状态</span><br><span class="line">		present      # 添加</span><br><span class="line">		absent       # 移除</span><br><span class="line">	password     # 设置密码</span><br><span class="line">	group        # 所属组</span><br><span class="line">	groups       # 附加组（用逗号分隔）</span><br><span class="line">	home         # 家目录</span><br><span class="line">	createhome   # 是否创建家目录</span><br><span class="line">	comment      # 注释</span><br><span class="line">	system       # 是否设为系统用户</span><br><span class="line">	generate_ssh_key=yes        # 是否加密密码</span><br><span class="line">	ssh_key_bits=2048           # 加密密钥长度</span><br><span class="line">	ssh_key_file=.ssh/id_rsa    # 密码文件</span><br><span class="line">	注：指定password参数时，不能使用后面这一串密码会被直接传送到被管理主机的/etc/shadow文件中，所以需要先将密码字符串进行加密处理。然后将得到的字符串放到password中即可。</span><br><span class="line">	默认加密方式是根据/etc/login.defs的ENCRYPT_METHOD指定，默认为SHA512</span><br></pre></td></tr></table></figure>
<h3 id="group"><a href="#group" class="headerlink" title="group"></a>group</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">group 组管理</span><br><span class="line">	gid      # GID</span><br><span class="line">	name     # 组名</span><br><span class="line">	state    # 状态</span><br><span class="line">	system   # 是否是系统组</span><br></pre></td></tr></table></figure>
<h3 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">copy 复制文件，类似scp，需要关闭所有机器的selinux，否则会报错</span><br><span class="line">	src      # 本地源路径</span><br><span class="line">	dest     # 远程主机目标路径</span><br><span class="line">	owner    # 指定拥有者</span><br><span class="line">	group    # 指定所属组</span><br><span class="line">	mode     # 设置权限</span><br><span class="line">	content  # 取代src=，表示直接用此处信息生成文件内容</span><br><span class="line">	backup   # 在覆盖前备份原文件，两个选项（yes | no）</span><br><span class="line">	directory_mode    # 递归设置目录权限，默认为系统默认权限</span><br><span class="line">	force  # 用于设置当目标主机包含该文件，但内容不同时的操作</span><br><span class="line">	       # 若设置为yes，则强制覆盖，若为no，则只有当目标主机的目标位置不存在该文件时，才复制。</span><br><span class="line">	       # 默认为yes</span><br><span class="line"># 所有的file模块里的选项都可以在这里使用</span><br><span class="line"># 若出现了有关selinux的报错，可在被控机上安装libselinux-python解决</span><br><span class="line"># ansible all -m yum</span><br></pre></td></tr></table></figure>
<h3 id="template"><a href="#template" class="headerlink" title="template"></a>template</h3><p>用法和copy模块用法基本一致，主要用于复制模板。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">template</span><br><span class="line">    backup    # 拷贝的同时也创建一个包含时间戳信息的备份文件，默认为no</span><br><span class="line">    dest=     # 目标路径</span><br><span class="line">    force     # 设置为yes (默认)时，将覆盖远程同名文件。设置为no时，忽略同名文件的拷贝</span><br><span class="line">    group     # 设置远程文件的所属组</span><br><span class="line">    owner     # 设置远程文件的所有者</span><br><span class="line">    mode      # 设置远程文件的权限。使用数值表示时不能省略第一位，如0644。</span><br><span class="line">              # 也可以使用&apos;u+rwx&apos;或&apos;u=rw,g=r,o=r&apos;等方式设置</span><br><span class="line">    src=      # ansible控制器上Jinja2格式的模板所在位置，可以是相对或绝对路径</span><br><span class="line">    validate  # 在复制到目标主机后但放到目标位置之前，执行此选项指定的命令。</span><br><span class="line">              # 一般用于检查配置文件语法，语法正确则保存到目标位置。</span><br><span class="line">              # 如果要引用目标文件名，则使用%s，下面的示例中的s%即表示目标机器上的/etc/nginx/nginx.conf。</span><br></pre></td></tr></table></figure></p>
<h3 id="file"><a href="#file" class="headerlink" title="file"></a>file</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">file 设置文件属性</span><br><span class="line">	path         # 设置文件路径（必填）</span><br><span class="line">	dest         # 设置目的路径</span><br><span class="line">	name         # 设置文件名</span><br><span class="line">	owner        # 指定拥有者</span><br><span class="line">	group        # 指定所属组</span><br><span class="line">	mode         # 设置权限</span><br><span class="line">	recurse      # 递归设置目录属性</span><br><span class="line">	state        # 文件状态</span><br><span class="line">	file         # 文件不存在就不会被创建</span><br><span class="line">	dictionary   # 若目录不存在，就自动创建</span><br><span class="line">	link         # 创建软连接</span><br><span class="line">	hard         # 创建硬链接</span><br><span class="line">	touch        # 若不存在就自动创建</span><br><span class="line">	absent       # 删除文件或目录</span><br><span class="line">	src          # 指定源文件，只应用于state=link的情况</span><br><span class="line">	force        # 强制创建软链接。</span><br><span class="line">	             # 两种情况：1.当源文件不存在，但之后会建立</span><br><span class="line">	                        2.要先取消已创建的软链接，再重新创</span><br></pre></td></tr></table></figure>
<h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">service 管理服务运行状态</span><br><span class="line">	enabled      # 是否开机自启（yes| no）</span><br><span class="line">	name         # 指定服务名（必填）</span><br><span class="line">	state        # 指定服务状态</span><br><span class="line">		started      # 启动</span><br><span class="line">		stoped       # 停止</span><br><span class="line">		restarted    # 重启</span><br><span class="line">		reloaded     # 重新加载</span><br><span class="line">	arguments    # 服务参数</span><br><span class="line">	pattern      # 设置模式</span><br><span class="line">	# 通过status指令来查看服务的状态时</span><br><span class="line">	# 若没有响应，就会通过ps指令在进程中根据该模式进行查找</span><br><span class="line">	# 如果匹配到，则认为该服务依然在运行</span><br><span class="line">	runlevel     # 运行级别</span><br><span class="line">	sleep        # 若执行restarted，则在stop和start键沉睡几秒</span><br></pre></td></tr></table></figure>
<h3 id="command"><a href="#command" class="headerlink" title="command"></a>command</h3><p>若不指定模块，则默认使用command模块。command模块不能解析变量(如$HOME)和某些操作符(“&lt;”, “&gt;”, “|“, “;”以及”&amp;”)，若需要使用以上符号，就要用shell模块。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">command</span><br><span class="line">    chdir        # 在执行定义的命令前进入指定目录</span><br><span class="line">    creates      # 创建文件，参数为一个文件或一个glob表达式，若已经存在就不会执行</span><br><span class="line">    removes:     # 删除文件，参数为一个文件或一个glob表达式，若不存在就不会执行</span><br><span class="line">    stdin:       # 可要求输入读取指定值</span><br></pre></td></tr></table></figure></p>
<h3 id="shell"><a href="#shell" class="headerlink" title="shell"></a>shell</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">shell 在远程主机上运行命令，一般要使用管道符语法时，会使用shell模块。与raw模块类似</span><br><span class="line">	例：ansible all -m shell -a &apos;echo hello&apos;</span><br></pre></td></tr></table></figure>
<h3 id="script"><a href="#script" class="headerlink" title="script"></a>script</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">script 将本地脚本复制到远程主机并运行 </span><br><span class="line">	例：ansible  all -m script -a &apos;/tmp/a.sh&apos;</span><br></pre></td></tr></table></figure>
<h3 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">yum 安装程序包</span><br><span class="line">    config_file         # yum的配置文件</span><br><span class="line">    disable_gpg_check   # 关闭gpg_check</span><br><span class="line">    disablerepo         # 不启用某个源</span><br><span class="line">    enablerepo          # 启用某个源</span><br><span class="line">    name                # 程序包名</span><br><span class="line">    state               # 设置状态</span><br><span class="line">        present         # 安装</span><br><span class="line">        latest          # 安装</span><br><span class="line">        absent          # 卸载</span><br></pre></td></tr></table></figure>
<p>注：yum模块是基于python2，若要基于python3安装，需要模块dnf。否则会以下报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   192.168.163.103 | FAILED! =&gt; &#123;</span><br><span class="line">   &quot;changed&quot;: false,</span><br><span class="line">   &quot;msg&quot;: &quot;The Python 2 bindings for rpm are needed for this module. If you require Python 3 support use the `dnf` Ansible module instead.. The Python 2 yum module is needed for this module. If you require Python 3 support use the `dnf` Ansible module instead.&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>也可通过command模块直接安装：<code>ansible 主机 -m command -a &#39;yum -y install 软件&#39;</code></p>
<h3 id="dnf"><a href="#dnf" class="headerlink" title="dnf"></a>dnf</h3><p>类似yum，但由于yum基于python2，若有依赖于python3的软件包则会报错，因此可用dnf代替，并且dnf的安装速度都有提升。常用参数与yum一致。</p>
<h3 id="setup"><a href="#setup" class="headerlink" title="setup"></a>setup</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">setup 收集远程主机的facts，获取主机信息</span><br><span class="line">    # 每个被管理节点在接受并运行管理命令前，会将自己主机相关信息（如操作系统信息，IP地址等报告给ansible）</span><br><span class="line">    filter     # 过滤器（正则表达式）</span><br><span class="line">    例：ansible 192.168.163.103 -m setup -a &apos;filter=ansible_eth[0-2]&apos;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: group1</span><br><span class="line">  remote_user: root</span><br><span class="line">  tasks:</span><br><span class="line">    - name: get system info</span><br><span class="line">      debug: msg=&quot;system = &#123;&#123; ansible_os_family &#125;&#125; kernel = &#123;&#123; ansible_kernel &#125;&#125; ip_addr = &#123;&#123; ansible_all_ipv4_addresses &#125;&#125;&quot;</span><br><span class="line"># 用ansible XXX -m setup就能看到所有变量名</span><br></pre></td></tr></table></figure>
<p>收集Facts会消耗额外的时间，若不需要，可以在playbook中关闭</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- hosts: group1</span><br><span class="line">  gather_facts: no</span><br></pre></td></tr></table></figure>
<h3 id="synchronize"><a href="#synchronize" class="headerlink" title="synchronize"></a>synchronize</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">synchronize 使用rsync同步文件</span><br><span class="line">    archive       # 归档，相当于同时开启recursive(递归)、links、perms、times、owner、group、-D选项都为yes ，默认该项为开启</span><br><span class="line">    checksum      # 跳过检测sum值，默认关闭</span><br><span class="line">    compress      # 是否开启压缩，默认yes</span><br><span class="line">    copy_links    # 复制链接文件，默认为no ，注意后面还有一个links参数</span><br><span class="line">    delete        # 删除不存在的文件，默认no</span><br><span class="line">    dest          # 目录路径</span><br><span class="line">    dest_port     # 默认目录主机上的端口 ，默认是22，走的ssh协议</span><br><span class="line">    dirs          # 传速目录不进行递归，默认为no，即进行目录递归</span><br><span class="line">    rsync_opts    # rsync参数部分</span><br><span class="line">    set_remote_user    # 主要用于/etc/ansible/hosts中定义或默认使用的用户-与rsync使用的用户不同的情况</span><br><span class="line">    mode          # push或pull 模块</span><br><span class="line">        # push模式一般用于从本机向远程主机上传文件</span><br><span class="line">        # pull 模式用于从远程主机上取文件</span><br></pre></td></tr></table></figure>
<h3 id="mount"><a href="#mount" class="headerlink" title="mount"></a>mount</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mount 设置挂载点</span><br><span class="line">    dump</span><br><span class="line">    fstype     # 必选项，挂载文件的类型</span><br><span class="line">    name       # 必选项，挂载点</span><br><span class="line">    opts       # 传递给mount命令的参数</span><br><span class="line">    src        # 必选项，要挂载的文件</span><br><span class="line">    state      # 必选项present：只处理fstab中的配置</span><br><span class="line">    present    # 只处理fstab中的配置</span><br><span class="line">    absent     # 删除挂载点</span><br><span class="line">    mounted    # 自动创建挂载点并挂载</span><br><span class="line">    umounted   # 卸载</span><br></pre></td></tr></table></figure>
<h3 id="get-url"><a href="#get-url" class="headerlink" title="get_url"></a>get_url</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">get_url    用于从http、ftp、https服务器上下载文件（类似于wget）</span><br><span class="line">	sha256sum   # 下载完成后进行sha256 check；</span><br><span class="line">	timeout     # 下载超时时间，默认10s</span><br><span class="line">	url         # 下载的URL</span><br><span class="line">	dest        # 本地存放路径</span><br><span class="line">	url_password/url_username    # 主要用于需要用户名密码进行验证的情况</span><br><span class="line">	use_proxy   # 使用代理，代理需事先在环境变更中定义</span><br></pre></td></tr></table></figure>
<p><strong>查看模块用法信息<code>ansible-doc 模块名</code></strong></p>
<h1 id="Playbook"><a href="#Playbook" class="headerlink" title="Playbook"></a>Playbook</h1><p>一个简单的配置管理和多主机部署系统。Playbook是由一个或多个“Plays”组成的列表。将事先归为一组的主机装扮为通过Ansible的任务Task定义好的角色。任务也就是调用Ansible的模块将多个“play”组织到一个playbook中。playbook的模板使用Python的jinja2模块处理。</p>
<p>Playbook的组成：</p>
<ol>
<li>Inventory</li>
<li>Modules</li>
<li>Ad Hoc Commands</li>
<li>Playbooks，包含以下部分<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Tasks：任务，即调用模块完成的某操作。这是Playbook的核心，定义顺序执行的Action，每个Action调用一个Ansible模块</span><br><span class="line">Variables：变量</span><br><span class="line">Template：模板</span><br><span class="line">Handlers：处理器，由某事件触发执行的操作</span><br><span class="line">Roles：角色</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>playbook基本组件</strong><br>play的主体部分是task list，task list中各个任务按次序逐个在hosts指定的主机上运行，即在所有主机上完成第一个任务后再按顺序完成第二个，若中途某个主机出现错误，则所有执行的任务都可能回滚。</p>
<p>建议每个任务都定义一个name标签，且每个task执行一个模块<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">test</span>          <span class="comment"># 指定主机组，也可指定单个主机</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span>    <span class="comment"># 指定远程主机上执行任务的用户（也可用于各个task中）</span></span><br><span class="line"><span class="attr">  sudo:</span> <span class="literal">yes</span>            <span class="comment"># sudo执行命令，也可在task中添加</span></span><br><span class="line"><span class="attr">  sudo_user:</span>           <span class="comment"># sudo身份</span></span><br><span class="line"><span class="attr">  tasks:</span>               <span class="comment"># 任务列表</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">install</span> <span class="string">latest</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      yum:</span> <span class="string">name=httpd</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">run</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span>   <span class="comment"># 运行service模块，后面跟上参数选项</span></span><br></pre></td></tr></table></figure></p>
<h2 id="命令解析"><a href="#命令解析" class="headerlink" title="命令解析"></a>命令解析</h2><p><code>ansible-playbook</code>对yaml文件进行执行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook [选项] yml文件</span><br><span class="line">  -f                     # 指定并行进程数，默认为5</span><br><span class="line">  -i 或 --inventory      # 指定Inventory文件</span><br><span class="line">  -e 或 --extra-vars=    # 设置额外的环境变量</span><br><span class="line">  --flush-cache          # 清空收集到的facts缓存</span><br><span class="line">  --list-tasks           # 列出所有将被执行的tasks</span><br><span class="line">  --list-tags            # 列出所有可获得的tags</span><br><span class="line">  --step                 # 每执行一步都进行交互式确认</span><br><span class="line">  --syntax-check         # 检查playbook语法 </span><br><span class="line">  --list-hosts           # 列出执行该playbook会影响的主机</span><br><span class="line">  -v 或 --verbose        # 查看详细输出</span><br></pre></td></tr></table></figure>
<p><code>ansible-pull</code>拉取指定主机的配置</p>
<h2 id="变量引用"><a href="#变量引用" class="headerlink" title="变量引用"></a>变量引用</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">    vars:</span> </span><br><span class="line"><span class="attr">      service:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">      package:</span> <span class="string">httpd</span></span><br><span class="line">    <span class="comment"># 或直接在本地创建变量文件，然后在playbook中通过vars_files调用</span></span><br><span class="line"><span class="attr">    vars_files:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">XXX/XXX.yml</span></span><br><span class="line"><span class="attr">    tasks:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">install</span> <span class="string">latest</span> <span class="string">apache</span></span><br><span class="line">      <span class="comment"># 若要通过上面定义的变量引用，则需要两对大括号调用</span></span><br><span class="line"><span class="attr">        yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">package</span> <span class="string">&#125;&#125;</span> <span class="string">state=latest</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">run</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">        service:</span> <span class="string">name=&#123;&#123;</span> <span class="string">service</span> <span class="string">&#125;&#125;</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 若定义的是一个对象，可直接用中括号或点调用子属性</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">group1</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    foo:</span></span><br><span class="line"><span class="attr">      field1:</span> <span class="string">one</span></span><br><span class="line"><span class="attr">      field2:</span> <span class="string">two</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">echo</span> <span class="string">foo.field1</span></span><br><span class="line">      <span class="comment">#  de<span class="doctag">bug:</span> msg="echo &#123;&#123;foo.field1&#125;&#125;"</span></span><br><span class="line"><span class="attr">      debug:</span> <span class="string">msg="echo</span> <span class="string">&#123;&#123;foo['field1']&#125;&#125;"</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">echo</span> <span class="string">foo.field2</span></span><br><span class="line"><span class="attr">      debug:</span> <span class="string">msg="echo</span> <span class="string">&#123;&#123;foo.field2&#125;&#125;"</span></span><br><span class="line"></span><br><span class="line"><span class="string">结果：</span></span><br><span class="line"><span class="string">TASK</span> <span class="string">[echo</span> <span class="string">foo.field1]</span> <span class="string">*********************************************************</span></span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"echo one"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">TASK</span> <span class="string">[echo</span> <span class="string">foo.field2]</span> <span class="string">*********************************************************</span></span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"echo two"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<p>简单试验分析：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">创建test.yml</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">system3</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">echo</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">'echo hello'</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line"><span class="attr">      user:</span> <span class="string">name=apache</span> <span class="string">password=redhat</span> <span class="string">state=present</span> <span class="string">uid=1003</span></span><br><span class="line"></span><br><span class="line"><span class="string">root@system2</span> <span class="string">~</span> <span class="string">&gt; ansible-playbook test.yml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">PLAY [system3] *****************************************************************</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">TASK [Gathering Facts] *********************************************************</span></span><br><span class="line"><span class="string"></span><span class="attr">ok:</span> <span class="string">[192.168.163.103]</span></span><br><span class="line"></span><br><span class="line"><span class="string">TASK</span> <span class="string">[echo</span> <span class="string">hello]</span> <span class="string">**************************************************************</span></span><br><span class="line"><span class="attr">changed:</span> <span class="string">[192.168.163.103]</span></span><br><span class="line"></span><br><span class="line"><span class="string">TASK</span> <span class="string">[create</span> <span class="string">user]</span> <span class="string">*************************************************************</span></span><br><span class="line"><span class="attr">changed:</span> <span class="string">[192.168.163.103]</span></span><br><span class="line"></span><br><span class="line"><span class="string">PLAY</span> <span class="string">RECAP</span> <span class="string">*********************************************************************</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.163</span><span class="number">.103</span>            <span class="string">:</span> <span class="string">ok=3</span>    <span class="string">changed=2</span>    <span class="string">unreachable=0</span>    <span class="string">failed=0</span>  </span><br><span class="line"></span><br><span class="line"><span class="comment"># changed说明发生了改变。</span></span><br><span class="line"><span class="comment"># 若再次执行一遍，会出现以下改变</span></span><br><span class="line"></span><br><span class="line"><span class="string">TASK</span> <span class="string">[echo</span> <span class="string">hello]</span> <span class="string">**************************************************************</span></span><br><span class="line"><span class="attr">changed:</span> <span class="string">[192.168.163.103]</span></span><br><span class="line"></span><br><span class="line"><span class="string">TASK</span> <span class="string">[create</span> <span class="string">user]</span> <span class="string">*************************************************************</span></span><br><span class="line"><span class="attr">ok:</span> <span class="string">[192.168.163.103]</span></span><br><span class="line"></span><br><span class="line"><span class="string">PLAY</span> <span class="string">RECAP</span> <span class="string">*********************************************************************</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.163</span><span class="number">.103</span>            <span class="string">:</span> <span class="string">ok=3</span>    <span class="string">changed=1</span>    <span class="string">unreachable=0</span>    <span class="string">failed=0</span>  </span><br><span class="line"><span class="comment"># 创建用户不再是changed，而是ok，而输出打印hello仍然为changed。</span></span><br><span class="line"><span class="comment"># 因为用户已创建了，就不会再创建，这体现了playbook的幂等性。而打印文字并不符合只需要执行一遍的特性。</span></span><br></pre></td></tr></table></figure>
<h2 id="register"><a href="#register" class="headerlink" title="register"></a>register</h2><p>register为注册变量，即：将任务执行的结果当做一个变量的值，待后面的任务使用。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">group1</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - shell:</span> <span class="string">ls</span></span><br><span class="line"><span class="attr">      register:</span> <span class="string">result</span></span><br><span class="line"><span class="attr">    - debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">result.stdout</span> <span class="string">&#125;&#125;"</span></span><br><span class="line"><span class="comment"># 就能输出在对端主机ls得到的结果</span></span><br><span class="line"><span class="string">结果：</span></span><br><span class="line"><span class="string">TASK</span> <span class="string">[debug]</span> <span class="string">*******************************************************************</span></span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"anaconda-ks.cfg"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="命令行传参"><a href="#命令行传参" class="headerlink" title="命令行传参"></a>命令行传参</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">'<span class="template-variable">&#123;&#123;group&#125;&#125;</span>'</span>    <span class="comment"># 一定要加引号（无论是单引号还是双引号），否则会产生YAML陷阱，报错</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">'<span class="template-variable">&#123;&#123;user&#125;&#125;</span>'</span></span><br><span class="line">  <span class="string">.....</span></span><br></pre></td></tr></table></figure>
<p>在执行ansible-playbook时添加参数<code>--extra-vars &quot;group=group1 user=root&quot;</code></p>
<h2 id="notify与handler"><a href="#notify与handler" class="headerlink" title="notify与handler"></a>notify与handler</h2><p>当远端发生改动时，playbooks本身可以识别这种改动,并且有一个基本的事件系统,可以响应这种改动。<br>notify会在playbook的每一个task结束时触发,即使有多个不同的task通知发生了改动（changed），notify只会被触发一次。<br>Handlers也是task的列表，若notify有定义，则handlers一定要有对应的处理方法。handlers主要用在重启服务，或系统重启。</p>
<p>一个handler最多只执行一次，并且<strong>在所有task都执行完后再执行</strong>，即handler是按照定义的顺序执行的，并不是按照task的调用顺序执行的。如果有多个任务调用同一个handler，则也只执行一次。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- hosts: test</span><br><span class="line">    tasks:</span><br><span class="line">      - name: install apache</span><br><span class="line">        yum: name=httpd state=latest</span><br><span class="line">        notify: yum error    # 关注可能发生的错误（不一定是错误），类似抛出异常</span><br><span class="line">        # 若notify有多个，可通过列表定义</span><br><span class="line">          - yum error</span><br><span class="line">          - httpd error  # 定义了多个，则handler也要有对应处理</span><br><span class="line">    handlers:            # 当关注的资源发生变化时采取的措施</span><br><span class="line">      - name: yum error  # 当有notify抛出，也要有对应的解决方案，name要与对应的notify的名字一致。</span><br><span class="line">        service: name=httpd state=restarted</span><br></pre></td></tr></table></figure>
<h2 id="逻辑控制"><a href="#逻辑控制" class="headerlink" title="逻辑控制"></a>逻辑控制</h2><p>三种逻辑控制语句：</p>
<ul>
<li><code>when</code>：条件判断，类似if</li>
<li><code>loop</code>：（迭代）循环，类似while</li>
<li><code>block</code>：将几个任务组成一个代码块，以便针对一组操作的异常进行处理</li>
</ul>
<h3 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h3><p>当需要根据变量等信息判断是否需要执行某task时，则需要条件判断</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">echo</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">echo</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">    when:</span> <span class="string">ansible_fqdn</span> <span class="string">==</span> <span class="string">'system3.example.com'</span></span><br><span class="line"><span class="comment"># 在task后添加when子句即可进行条件测试，when语句支持jinja2语法</span></span><br><span class="line"><span class="comment"># when语句中还能使用Jinja2的很多'filter'</span></span><br><span class="line"></span><br><span class="line"><span class="string">执行结果：</span></span><br><span class="line"><span class="string">TASK</span> <span class="string">[echo</span> <span class="string">hello]</span> <span class="string">**************************************************************</span></span><br><span class="line"><span class="attr">skipping:</span> <span class="string">[192.168.163.104]</span></span><br><span class="line"><span class="attr">changed:</span> <span class="string">[192.168.163.103]</span></span><br><span class="line"></span><br><span class="line"><span class="string">PLAY</span> <span class="string">RECAP</span> <span class="string">*********************************************************************</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.163</span><span class="number">.103</span>            <span class="string">:</span> <span class="string">ok=2</span>    <span class="string">changed=1</span>    <span class="string">unreachable=0</span>    <span class="string">failed=0</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.163</span><span class="number">.104</span>            <span class="string">:</span> <span class="string">ok=1</span>    <span class="string">changed=0</span>    <span class="string">unreachable=0</span>    <span class="string">failed=0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 经过判断system4不满足when条件，所以skipping跳过，而system3满足，所以changed</span></span><br><span class="line"></span><br><span class="line"><span class="string">可使用and、or、not进行逻辑连接或判断，==、!=、&gt;、&lt;、&gt;=、&lt;=进行算数比较</span></span><br><span class="line"></span><br><span class="line"><span class="string">可使用is</span> <span class="string">exists或is</span> <span class="string">not</span> <span class="string">exists判断指定的文件是否存在，且可通过not取反</span></span><br><span class="line"><span class="string">即not</span> <span class="string">XXX</span> <span class="string">is</span> <span class="string">exists</span> <span class="string">等于</span> <span class="string">XXX</span> <span class="string">is</span> <span class="string">not</span> <span class="string">exists</span></span><br><span class="line"></span><br><span class="line"><span class="string">可使用defined、undefined、none判断变量是否已定义，以及变量是否为空</span></span><br><span class="line"></span><br><span class="line"><span class="string">可使用success或succeeded、failure或failed、change或changed、skip或skipped分别判断任务返回状态是否为成功、任务返回状态是否为失败、任务返回状态是否为改变、任务返回状态是否为跳过</span></span><br><span class="line"></span><br><span class="line"><span class="string">可使用file、directory、link、mount判断路径是否为一个文件、目录、链接、挂载点</span></span><br><span class="line"></span><br><span class="line"><span class="string">可使用lower、upper判断字符串是否为纯小写、纯大写</span></span><br><span class="line"></span><br><span class="line"><span class="string">可使用even、odd判断数值是否为偶数、奇数，可用divisibleby(num)判断是否可以整除数值num</span></span><br><span class="line"></span><br><span class="line"><span class="string">可用version(version值,'算数比较符')比较版本与指定值的大小</span></span><br><span class="line"></span><br><span class="line"><span class="string">可用string、number分别判断值是否为字符串或数字</span></span><br><span class="line"></span><br><span class="line"><span class="string">可用subset、superset（版本2.5及以上）|issubset、issuperset（版本2.5以下）判断一个list是否是另一个list的子集或父集</span></span><br></pre></td></tr></table></figure>
<h3 id="迭代（循环）"><a href="#迭代（循环）" class="headerlink" title="迭代（循环）"></a>迭代（循环）</h3><p>重复同类的task时使用。item定义迭代，with_items定义循环列表。<br>with_items中的列表值可以使字典，若是字典，引用时要使用item.键名</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">列表形式</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">apache</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">php</span></span><br><span class="line"><span class="string">字典形式</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&#123;name:</span> <span class="string">apache,</span> <span class="attr">conf:</span> <span class="string">/etc/httpd.conf&#125;</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">&#123;name:</span> <span class="string">php,</span> <span class="attr">conf:</span> <span class="string">/etc/php.ini&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">试验：</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">create</span> <span class="string">user</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=&#123;&#123;item&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  with_items:</span> </span><br><span class="line"><span class="bullet">    -</span> <span class="string">zhangsan</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">lisi</span></span><br><span class="line"><span class="string">就相当于</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=zhangsan</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  user:</span> <span class="string">name=lisi</span> <span class="string">state=present</span></span><br><span class="line"></span><br><span class="line"><span class="string">或者在vars中定义列表，然后使用with_items调用</span></span><br><span class="line"><span class="attr">vars:</span> </span><br><span class="line">  <span class="string">user_list=['zhangsan',</span> <span class="string">'lisi'</span><span class="string">]</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">  - user:</span> <span class="string">name=&#123;&#123;item&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">    with_items:</span> <span class="string">"<span class="template-variable">&#123;&#123; user_list &#125;&#125;</span>"</span></span><br><span class="line">    </span><br><span class="line"><span class="string">嵌套循环</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">    - debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">item.0</span> <span class="string">&#125;&#125;</span> <span class="string">&#123;&#123;</span> <span class="string">item.1</span> <span class="string">&#125;&#125;"</span></span><br><span class="line"><span class="comment">#或 -de<span class="doctag">bug:</span> msg="layer1: &#123;&#123;item[0]&#125;&#125; layer2: &#123;&#123;item[2]&#125;&#125;"</span></span><br><span class="line"><span class="attr">      with_nested:</span>      <span class="comment"># 使用with_nested进行嵌套循环</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">['1',</span> <span class="string">'2'</span><span class="string">]</span>    <span class="comment"># 这个循环用item.0表示</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">['4',</span> <span class="string">'5'</span><span class="string">]</span>    <span class="comment"># 这个循环用item.1表示</span></span><br><span class="line"><span class="string">结果：</span></span><br><span class="line"><span class="string">TASK</span> <span class="string">[debug]</span> <span class="string">*******************************************************************</span></span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">(item=[u'1',</span> <span class="string">u'4'])</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"1 4"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">(item=[u'1',</span> <span class="string">u'5'])</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"1 5"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">(item=[u'2',</span> <span class="string">u'4'])</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"2 4"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">(item=[u'2',</span> <span class="string">u'5'])</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"2 5"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">文件列表循环</span></span><br><span class="line"><span class="string">在当前目录下创建demo目录，并在其中创建httpd_1.conf和httpd_2.conf，编写Playbook</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - debug:</span> <span class="string">msg="&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;"</span> </span><br><span class="line"><span class="attr">      with_fileglob:</span>     <span class="comment"># 使用with_fileglob进行文件列表循环</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">./demo/*</span>       <span class="comment"># 要循环的文件路径</span></span><br><span class="line"><span class="string">结果：</span></span><br><span class="line"><span class="string">TASK</span> <span class="string">[debug]</span> <span class="string">*******************************************************************</span></span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">(item=/root/./demo/httpd_1.conf)</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "item":</span> <span class="string">"/root/./demo/httpd_1.conf"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"/root/./demo/httpd_1.conf"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">(item=/root/./demo/httpd_2.conf)</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "item":</span> <span class="string">"/root/./demo/httpd_2.conf"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"/root/./demo/httpd_2.conf"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="Block块"><a href="#Block块" class="headerlink" title="Block块"></a>Block块</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">多个Action组成block块，可进行一个块的执行</span></span><br><span class="line"><span class="attr">  tasks:</span> </span><br><span class="line"><span class="attr">  - debug:</span></span><br><span class="line"><span class="attr">      msg:</span> <span class="string">"task1 not in block"</span></span><br><span class="line"><span class="attr">  - block:</span></span><br><span class="line"><span class="attr">      - debug:</span></span><br><span class="line"><span class="attr">          msg:</span> <span class="string">"task2 in block"</span></span><br><span class="line"><span class="attr">      - debug:</span></span><br><span class="line"><span class="attr">          msg:</span> <span class="string">"task3 in block"</span></span><br><span class="line"><span class="attr">    when:</span> <span class="number">2</span> <span class="string">&gt; 1</span></span><br><span class="line"><span class="string">	# block块中的when是用于判断block块是否执行的条件</span></span><br></pre></td></tr></table></figure>
<p>但Block块更常见的用法是“错误处理”。当某任务出错时，能够执行指定的其他任务。作用与<code>when XXX is failed</code>一致。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">  tasks:</span> </span><br><span class="line"><span class="attr">    - block:</span> </span><br><span class="line"><span class="attr">        - shell:</span> <span class="string">"ls ./aaa"</span>        <span class="comment"># 该目录不存在，会出错</span></span><br><span class="line"><span class="attr">      rescue:</span>       <span class="comment"># 一旦出错就会调用rescue任务，类似except，处理异常</span></span><br><span class="line"><span class="attr">        - debug:</span> </span><br><span class="line"><span class="attr">            msg:</span> <span class="string">"caught an error"</span>  </span><br><span class="line"><span class="attr">      always:</span>       <span class="comment"># 总是会执行的语句，类似finally</span></span><br><span class="line"><span class="attr">        - debug:</span></span><br><span class="line"><span class="attr">            msg:</span> <span class="string">"this always executes"</span></span><br><span class="line"><span class="string">结果：</span></span><br><span class="line"><span class="string">TASK</span> <span class="string">[command]</span> </span><br><span class="line"><span class="attr">fatal:</span> <span class="string">......</span></span><br><span class="line"><span class="string">TASK</span> <span class="string">[debug]</span> </span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"caught an error"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">TASK</span> <span class="string">[debug]</span> </span><br><span class="line"><span class="attr">ok:</span> <span class="string">[172.16.246.133]</span> <span class="string">=&gt;</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "msg":</span> <span class="string">"this always executes"</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h3><p>通过配置模板，可将配置文件中的参数按照inventory文件中变量以及ansible facts中变量动态赋值，使得每个指定的主机的配置都是定制的。<br>首先要创建一个templates目录。<code>mkdir /etc/ansible/templates</code><br>将配置文件放入该目录，并最好改名为<code>xxx.conf.j2</code><br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">以httpd为例，修改配置文件/etc/ansible/templates/httpd.conf.j2</span></span><br><span class="line"><span class="string">Listen</span> <span class="string">&#123;&#123;</span> <span class="string">http_port</span> <span class="string">&#125;&#125;</span>    <span class="comment"># 使用inventory定义变量</span></span><br><span class="line"><span class="string">User</span> <span class="string">&#123;&#123;</span> <span class="string">username</span> <span class="string">&#125;&#125;</span>       <span class="comment"># 同上</span></span><br><span class="line"><span class="string">Group</span> <span class="string">&#123;&#123;</span> <span class="string">groupname</span> <span class="string">&#125;&#125;</span>     <span class="comment"># 同上</span></span><br><span class="line"><span class="string">ServerName</span> <span class="string">&#123;&#123;</span> <span class="string">ansible_fqdn</span> <span class="string">&#125;&#125;</span>    <span class="comment"># 使用facts变量</span></span><br><span class="line"></span><br><span class="line"><span class="string">然后修改/etc/ansible/hosts文件</span></span><br><span class="line"><span class="string">[test]</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.163</span><span class="number">.103</span> <span class="string">http_port=8081</span> <span class="string">username=system3</span> <span class="string">groupname=system3</span> </span><br><span class="line"><span class="number">192.168</span><span class="number">.163</span><span class="number">.104</span> <span class="string">http_port=8082</span> <span class="string">username=system4</span> <span class="string">groupname=system4</span> </span><br><span class="line"></span><br><span class="line"><span class="string">然后在playbook中将本地的配置文件复制到远端，以下是完整试验</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">alter</span> <span class="string">config</span></span><br><span class="line"><span class="attr">    template:</span> <span class="string">src=/etc/ansible/templates/httpd.conf.j2</span> <span class="string">dest=/etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="attr">    notify:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">start</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=&#123;&#123;</span> <span class="string">service</span> <span class="string">&#125;&#125;</span> <span class="string">enabled=true</span> <span class="string">state=started</span> </span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">    service:</span> <span class="string">name=&#123;&#123;</span> <span class="string">service</span> <span class="string">&#125;&#125;</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"><span class="string">执行ansible-playbook</span> <span class="string">test.yml。之后查看103和104主机的httpd配置文件</span></span><br><span class="line"><span class="string">system3和system4上，httpd配置文件都更改成功。以下为system3上的配置</span></span><br><span class="line"><span class="string">Listen</span> <span class="number">8081</span></span><br><span class="line"><span class="string">Include</span> <span class="string">conf.modules.d/*.conf</span></span><br><span class="line"><span class="string">User</span> <span class="string">system3</span></span><br><span class="line"><span class="string">Group</span> <span class="string">system3</span></span><br><span class="line"><span class="string">ServerAdmin</span> <span class="string">root@localhost</span></span><br><span class="line"><span class="string">ServerName</span> <span class="string">system3.example.com</span></span><br></pre></td></tr></table></figure></p>
<h3 id="tags标签"><a href="#tags标签" class="headerlink" title="tags标签"></a>tags标签</h3><p>可以为playbook中的每个任务都打上标签，标签的主要作用是可以在ansible-playbook中设置只执行被打上tag的任务或忽略被打上tag的任务。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">  yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  tags:</span> <span class="string">apache</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">mysql</span></span><br><span class="line"><span class="attr">  yum:</span> <span class="string">name=mysql-server</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">  tags:</span> <span class="string">mysql</span></span><br><span class="line"><span class="string">当执行playbook时，可通过--tags=</span> <span class="string">运行打上指定tag的task</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">test.yml</span> <span class="bullet">--tags="apache"</span> <span class="string">则只运行安装打上apache标签的task</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">test.yml</span> <span class="bullet">--skip-tags="apache"则会跳过执行apache标签的task</span></span><br><span class="line"><span class="attr">  tags:</span> <span class="string">always</span></span><br><span class="line"><span class="string">打上always标签的task总会被执行，不管是否指定了--tags="XXX"</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-tags</span> <span class="string">tagged</span>    <span class="comment"># 会执行所有打上tag的task，不管打上的是什么标签</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-tags</span> <span class="string">untagged</span>  <span class="comment"># 会执行所有没有打标签的task</span></span><br><span class="line"><span class="bullet">-</span><span class="bullet">-tags</span> <span class="string">all</span>       <span class="comment"># 执行所有任务，无论是否打标签</span></span><br></pre></td></tr></table></figure></p>
<h3 id="include和roles"><a href="#include和roles" class="headerlink" title="include和roles"></a>include和roles</h3><p>如果把所有play都写在一个playbook中，会导致文件不易阅读。ansible可以将多个不同任务分别写在不同的playbook中，然后使用include将其包含进去，实现Playbook的重用。roles也是一种整合playbook的方式。include的维护成本较高，重用能力有限，而role更加灵活，且可以重用一组文件。</p>
<h4 id="include"><a href="#include" class="headerlink" title="include"></a>include</h4><p>使用include语句引用task文件的方法，可允许你将一个配置策略分解到更小的文件中，将tasks从其他文件拉取过来（handlers也是tasks）。即include可以导入两种文件：导入task、导入playbook。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">导入task：</span></span><br><span class="line"><span class="string">创建一个单独的yml配置文件，a.yml</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">echo</span> <span class="string">hello</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">echo</span> <span class="string">'hello'</span></span><br><span class="line"><span class="attr">  - name:</span> <span class="string">echo</span> <span class="string">value</span></span><br><span class="line"><span class="attr">    command:</span> <span class="string">echo</span> <span class="string">&#123;&#123;value&#125;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">在主playbook中便可通过include引用该文件</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line"><span class="attr">    - include:</span> <span class="string">a.yml</span> <span class="string">value='hello'</span></span><br><span class="line">       <span class="comment"># 可以直接在文件名后传参数</span></span><br><span class="line">       <span class="comment"># 也可以通过vars传参</span></span><br><span class="line"><span class="attr">  tasks:</span> </span><br><span class="line"><span class="attr">    - include:</span> <span class="string">a.yml</span></span><br><span class="line"><span class="attr">      vars:</span> </span><br><span class="line"><span class="attr">        value:</span> <span class="string">hello</span></span><br><span class="line"></span><br><span class="line"><span class="string">导入playbook：</span></span><br><span class="line"><span class="string">并不在task中通过include调用yml了，而是直接在最外层导入playbook</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">test</span></span><br><span class="line"><span class="string">.....</span></span><br><span class="line"><span class="attr">- include:</span> <span class="string">test1.yml</span></span><br><span class="line"><span class="attr">- include:</span> <span class="string">apache.yml</span> <span class="string">http_port=8000</span>  <span class="comment"># 传参方式与上面一样</span></span><br><span class="line"></span><br><span class="line"><span class="string">在include中使用tags</span></span><br><span class="line"><span class="attr">- include:</span> <span class="string">test1.yml</span></span><br><span class="line"><span class="attr">  tags:</span> <span class="string">[aaa,</span> <span class="string">bbb]</span></span><br></pre></td></tr></table></figure></p>
<h4 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h4><p>角色，封装playbook，实现复用性，能够根据层次型结构自动加载变量文件、tasks以及handlers等。<br>roles就是通过分别将变量、文件、任务、模板以及处理器放置于单独的目录中，然后通过include调用的一种机制。roles一般用于基于主机构建服务的场景中，也可以使用于构建守护进程的场景中。</p>
<p>创建role的步骤：</p>
<ol>
<li>在playbooks目录中创建roles目录</li>
<li>在roles目录中创建角色名的目录</li>
<li>在每个角色命令的目录中创建files、handlers、meta、tasks、templates、vars目录。若用不到的目录也可不创</li>
<li>在playbook中调用各角色</li>
</ol>
<p>roles中各目录：</p>
<ul>
<li><code>tasks</code>目录：至少包含一个main.yml，其定义了此角色的任务列表，此文件可用include包含其他task目录</li>
<li><code>files</code>目录：存放有copy或script等模块调用的文件</li>
<li><code>templates</code>目录：template模块会自动在此文件中寻找jinja2模板</li>
<li><code>handlers</code>目录：此目录中应包含一个main.yml，定义此角色用到的handler</li>
<li><code>yml</code>文件：用于定义此角色用到的个handler，</li>
<li><code>vars</code>目录：应包含一个main.yml，定义此角色用到的变量</li>
<li><code>meta</code>目录：应包含一个main.yml，定义此角色的特殊设定和依赖关系</li>
<li><code>defaults</code>目录：应包含一个main.yml，为当前角色设定默认变量时使用此目录</li>
</ul>
<p>案例目录结构<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">roles</span><br><span class="line">├── test1</span><br><span class="line">│   ├── files</span><br><span class="line">│   ├── handlers</span><br><span class="line">│   ├── meta</span><br><span class="line">│   ├── tasks</span><br><span class="line">│   ├── templates</span><br><span class="line">│   └── vars</span><br><span class="line">└── test2</span><br><span class="line">    ├── files</span><br><span class="line">    ├── handlers</span><br><span class="line">    ├── meta</span><br><span class="line">    ├── tasks</span><br><span class="line">    ├── templates</span><br><span class="line">    └── vars</span><br></pre></td></tr></table></figure></p>
<p>将要编写的task文件存放在tasks目录中，编写main.yml。<br>将httpd的配置文件复制到files目录中。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">  yum:</span> <span class="string">name=httpd</span> <span class="string">state=present</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">install</span> <span class="string">config</span></span><br><span class="line"><span class="attr">  copy:</span> <span class="string">src=httpd.conf</span> <span class="string">dest=/etc/httpd/conf/httpd.conf</span> </span><br><span class="line">  <span class="comment"># 这里copy的源可直接写文件名，会自动定位到files目录中</span></span><br><span class="line"><span class="attr">  tags:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">conf</span></span><br><span class="line"><span class="attr">  notify:</span></span><br><span class="line"><span class="bullet">  -</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">- name:</span> <span class="string">start</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span></span><br></pre></td></tr></table></figure></p>
<p>然后在handlers中添加handler文件，在目录中创建main.yml<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">restart</span> <span class="string">httpd</span></span><br><span class="line"><span class="attr">  service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br></pre></td></tr></table></figure></p>
<p>在于roles平级的目录中创建site.yml文件（名字可自定义），就是主配置文件。roles后面也可跟上参数，也可跟上条件判断。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">system1</span></span><br><span class="line"><span class="attr">  remote_port:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span> </span><br><span class="line"><span class="bullet">    -</span> <span class="string">test1</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">system3</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test2</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">system4</span></span><br><span class="line"><span class="attr">  roles:</span> </span><br><span class="line"><span class="bullet">    -</span> <span class="string">test1</span></span><br><span class="line"><span class="bullet">    -</span> <span class="string">test2</span></span><br></pre></td></tr></table></figure></p>
<p>带参数的role</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">a.yml和roles的目录结构</span><br><span class="line">a.yml</span><br><span class="line">roles/</span><br><span class="line">└── myrole</span><br><span class="line">    └── tasks</span><br><span class="line">        └── main.yml</span><br><span class="line"></span><br><span class="line">在main.yml中指定task</span><br><span class="line">---</span><br><span class="line">  - debug: msg=&quot;&#123;&#123; param &#125;&#125;&quot;</span><br><span class="line">在a.yml中的配置如下：</span><br><span class="line">---</span><br><span class="line">- hosts: group1</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - role: myrole</span><br><span class="line">      param: &quot; task first&quot;</span><br><span class="line">    - role: myrole</span><br><span class="line">      param: &quot; task second&quot;</span><br><span class="line">执行结果：</span><br><span class="line">TASK [myrole : debug] </span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot; task first&quot;</span><br><span class="line">&#125;</span><br><span class="line">TASK [myrole : debug] </span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot; task second&quot;</span><br><span class="line">&#125;</span><br><span class="line">会循环遍历a.yml中设置指定参数执行</span><br></pre></td></tr></table></figure>
<p>role的默认参数defaults，在myrole中创建defaults目录，并创建main.yml</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">roles/</span><br><span class="line">└── myrole</span><br><span class="line">    ├── defaults</span><br><span class="line">    │   └── main.yml</span><br><span class="line">    └── tasks</span><br><span class="line">        └── main.yml</span><br><span class="line">在defaults中的main.yml中只要配置</span><br><span class="line">---</span><br><span class="line">param: &quot;default param&quot;</span><br><span class="line">将a.yml中的myrole下的参数配置删除</span><br><span class="line">roles:</span><br><span class="line">    - myrole</span><br><span class="line">再执行，就会调用defaults中的指定参数</span><br><span class="line">TASK [myrole : debug]</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;default param&quot;</span><br><span class="line">&#125;</span><br><span class="line">但执行速度会变慢</span><br></pre></td></tr></table></figure>
<p>role与when的结合：当满足条件时才采用指定值</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">roles: </span><br><span class="line">  - role: myrole</span><br><span class="line">    param: &quot;myrole param&quot;</span><br><span class="line">  - role: myrole</span><br><span class="line">    when: 2&gt;1</span><br><span class="line">结果：</span><br><span class="line">TASK [myrole : debug] </span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;myrole param&quot;</span><br><span class="line">&#125;</span><br><span class="line">TASK [myrole : debug]</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;default param&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在role中使用tags</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">roles: </span><br><span class="line">  - role: myrole</span><br><span class="line">    tags: [&apos;aaa&apos;, &apos;bbb&apos;]</span><br></pre></td></tr></table></figure>
<p>role和tasks的执行顺序</p>
<ol>
<li>pre_tasks：是在最先执行的task</li>
<li>roles：roles会在tasks前执行</li>
<li>tasks</li>
<li>post_tasks：最后执行的task</li>
</ol>
<h2 id="常用技巧"><a href="#常用技巧" class="headerlink" title="常用技巧"></a>常用技巧</h2><ul>
<li>若要使command或shell的成功返回值不为0，有以下两种方式<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr"> - name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">   shell:</span> <span class="string">/usr/bin/somecommand</span> <span class="string">||</span> <span class="string">/bin/true</span></span><br><span class="line"><span class="string">或</span></span><br><span class="line"><span class="attr">tasks:</span></span><br><span class="line"><span class="attr"> - name:</span> <span class="string">run</span> <span class="string">this</span> <span class="string">command</span> <span class="string">and</span> <span class="string">ignore</span> <span class="string">the</span> <span class="string">result</span></span><br><span class="line"><span class="attr">   shell:</span> <span class="string">/usr/bin/somecommand</span></span><br><span class="line"><span class="attr">   ignore_errors:</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="Ansible变量"><a href="#Ansible变量" class="headerlink" title="Ansible变量"></a>Ansible变量</h1><p>Ansible有三个组成部分：</p>
<ul>
<li>Global：作用域为全局。在以下方面定义：<ul>
<li>Ansible配置文件中定义</li>
<li>环境变量</li>
<li>ansible及ansible-playbook命令行传入的变量</li>
</ul>
</li>
<li>Play：作用域为Play（一个Playbook由多个Play组成）。在以下方面定义：<ul>
<li>Play中vars关键词定义的变量</li>
<li>通过模块include_vars定义的变量</li>
<li>role在文件default/main.yml和vars/main.yml中定义的变量</li>
</ul>
</li>
<li>Host：作用域为某个主机。在以下方面定义：<ul>
<li>定义在主机Inventory中的变量</li>
<li>主机的系统变量</li>
<li>注册变量</li>
</ul>
</li>
</ul>
<p><strong>Ansible所有变量的优先级（从高到低）：</strong></p>
<ul>
<li><p><strong>extra vars</strong>：通过命令传入的变量</p>
</li>
<li><p><strong>task vars</strong>：仅在该任务中使用的变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - XXXX</span><br><span class="line">    vars:</span><br><span class="line">      XXX: XXX</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>block vars</strong>：只在Playbook的任务中某个block定义的变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">....</span><br><span class="line">  - block: </span><br><span class="line">    - XXX: XXXX</span><br><span class="line">    vars: </span><br><span class="line">      XXX: XXX</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>role include vars</strong>：在<code>tasks/main.yml</code>中，通过include加载的变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- name: xxx</span><br><span class="line">  include_vars: &quot;XXX.yml&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>role and include vars</strong>：role的变量。在<code>vars/main.yml</code>中定义的变量</p>
</li>
<li><p><strong>set_facts</strong>：这是一个模块，通过该模块加入一些Facts变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- set_fact:</span><br><span class="line">  XXX: XXX</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>registered vars</strong>：注册变量</p>
</li>
<li><p><strong>play vars_files</strong>：将变量单独放在一个文件中，通过关键字<code>var_files</code>从文件中加载的变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">var_files:</span><br><span class="line">  - XXX.yml</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>play vars_prompt</strong>：需要用户在执行Playbook时输入的变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vars_prompt:</span><br><span class="line">  - name: &quot;yourname&quot;</span><br><span class="line">tasks: </span><br><span class="line">  - debug: msg=&quot;your name is &#123;&#123;yourname&#125;&#125;&quot;</span><br><span class="line"></span><br><span class="line">在执行Playbook时传参</span><br><span class="line">ansible-playbook a.yml -e &apos;yourname=zhangsan&apos;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>play vars</strong>：Playbook中的<code>vars</code>关键字下定义的参数</p>
</li>
<li><p><strong>host facts</strong>：Ansible在执行Playbook时，收集到的远程主机的信息</p>
</li>
<li><p><strong>playbook host_vars</strong>：Playbook同级子目录<code>host_vars</code>中文件内定义的变量</p>
</li>
<li><p><strong>playbook group_vars</strong>：Playbook同级子目录<code>group_vars</code>中文件内定义的变量</p>
</li>
<li><p><strong>inventory host_vars</strong>：可在两个地方定义。一是在inventory文件中直接定义，二是在Inventory文件的同级子目录<code>host_vars</code>中<strong>与host同名的文件</strong>中定义</p>
</li>
<li><p><strong>inventory group_vars</strong>：可在两个地方定义。一是在inventory文件中直接定义，二是在Inventory文件的同级子目录<code>group_vars</code>中<strong>与group同名的文件</strong>中定义</p>
</li>
<li><p><strong>inventory vars</strong>：Inventory文件中定义的变量</p>
</li>
<li><p><strong>role defaults</strong>：role的默认变量，在<code>defaults/main.yml</code>中定义</p>
</li>
</ul>
<h1 id="Lookup"><a href="#Lookup" class="headerlink" title="Lookup"></a>Lookup</h1><p>lookup既能读取Ansible管理节点上文件系统的文件内容，还能读取数据库内容。</p>
<ul>
<li><p>lookup读取文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vars: </span><br><span class="line">  contents: &quot;&#123;&#123; lookup(&apos;file&apos;, &apos;data/test.txt&apos;) &#125;&#125;&quot;</span><br><span class="line">将data/test.txt中的内容赋给变量contents，file指定读取的对象类型是文件</span><br></pre></td></tr></table></figure>
</li>
<li><p>lookup生成随机密码，若文件不存在，会自动创建，并将生成的密码存入。若文件存在，则直接读取作为密码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">vars: </span><br><span class="line">  password: &quot;&#123;&#123; lookup(&apos;password&apos;, &apos;/etc/password/zhangsan length=6&apos;) &#125;&#125;&quot;</span><br><span class="line">tasks:</span><br><span class="line">  - debug: msg=&quot;password &#123;&#123;password&#125;&#125;&quot;</span><br><span class="line">  </span><br><span class="line">执行结果：</span><br><span class="line">TASK [debug]</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;password BWNcQ2 &quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lookup读取环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - debug: msg=&quot;&#123;&#123; lookup(&apos;env&apos;, &apos;HOME&apos;) &#125;&#125;&quot;</span><br><span class="line">  </span><br><span class="line">结果：</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;/root&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lookup读取Linux命令执行结果</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - debug: msg=&quot;&#123;&#123; lookup(&apos;pipe&apos;, &apos;uname -r&apos;) &#125;&#125;&quot;</span><br><span class="line">  </span><br><span class="line">结果：</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;4.8.6-300.fc25.x86_64&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lookup读取template变量替换后的文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - debug: msg=&quot;&#123;&#123; lookup(&apos;template&apos;, &apos;./httpd.conf.j2&apos;) &#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lookup读取配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">demo.ini配置文件：</span><br><span class="line">[global]</span><br><span class="line">port = 873</span><br><span class="line">.....</span><br><span class="line">[rsync_test]</span><br><span class="line">comment = rsync test</span><br><span class="line">path = /root/rsync_test</span><br><span class="line">.....</span><br><span class="line"></span><br><span class="line">tasks:</span><br><span class="line">  - debug: msg=&quot;global-port &#123;&#123; lookup(&apos;ini&apos;, &apos;port section=global file=./demo.ini&apos;) &#125;&#125;&quot;</span><br><span class="line">  - debug: msg=&quot;rsync_test-path &#123;&#123; lookup(&apos;ini&apos;, &apos;path section=rsync_test file=./demo.ini&apos;) &#125;&#125;&quot;</span><br><span class="line"># lookup的第二个参数分为几个部分：要查的字段  section=节的名称  file=文件名 </span><br><span class="line">若是properties文件，则需要添加参数type=properties</span><br><span class="line">完整的几个参数：</span><br><span class="line">参数名            默认值               含义</span><br><span class="line">type             ini                 文件类型</span><br><span class="line">file             ansible.ini         文件名</span><br><span class="line">section          global              节</span><br><span class="line">re               False               字段的正则表达式</span><br><span class="line">default          &quot;&quot;                  字段不存在时的返回值</span><br><span class="line"> </span><br><span class="line">执行结果：</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;global-port 873&quot;</span><br><span class="line">&#125;</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;rsync_test-path /root/rsync_test&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>lookup读取CSV文件的指定单元</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">csv文件：</span><br><span class="line">name       age   sex</span><br><span class="line">zhangsan   22    male</span><br><span class="line">lisi       23    male</span><br><span class="line"></span><br><span class="line">tasks:</span><br><span class="line">  - debug: msg=&quot;&#123;&#123;lookup(&apos;csvfile&apos;, &apos;lisi file=./demo.csv delimiter=, col=0&apos;)&#125;&#125;&quot;</span><br><span class="line"># 获取lisi的第0列，即名字lisi</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;lisi&quot;</span><br><span class="line">&#125;</span><br><span class="line">支持的参数：</span><br><span class="line">参数名      默认值        含义</span><br><span class="line">file       ansible.csv  文件名</span><br><span class="line">col        1            列号（从0开始计数）</span><br><span class="line">delimiter  TAB          CSV文件的分隔符</span><br><span class="line">default    &quot;&quot;           元素不存在时的返回值</span><br><span class="line">encoding   utf-8        CSV文件的编码</span><br></pre></td></tr></table></figure>
</li>
<li><p>lookup读取DNS解析的值。可以向DNS服务器查询指定域的DNS记录，可查询任何DNS记录（包括正向和反向）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">  - debug: msg=&quot;ipv4 address of baidu.com  &#123;&#123; lookup(&apos;dig&apos;, &apos;baidu.com&apos;) &#125;&#125;&quot;</span><br><span class="line">  - debug: msg=&quot;txt record of baidu.com  &#123;&#123; lookup(&apos;dig&apos;, &apos;baidu.com&apos;, &apos;qtype=TXT&apos;) &#125;&#125;&quot;</span><br><span class="line">  - debug: msg=&quot;txt record of baidu.com &#123;&#123; lookup(&apos;dig&apos;, &apos;baidu.com./TXT&apos;) &#125;&#125;&quot;</span><br><span class="line">  - debug: msg=&quot;MX record of 163.com &#123;&#123; lookup(&apos;dig&apos;, &apos;163.com./MX&apos;, &apos;wantlist=True&apos;) &#125;&#125;&quot;</span><br><span class="line">  </span><br><span class="line">需要安装dnspython模块，直接pip install 即可</span><br><span class="line">执行结果：</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;ipv4 address of &apos;baidu.com&apos;   220.181.57.216,123.125.115.110&quot;</span><br><span class="line">&#125;</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;txt record of &apos;baidu.com&apos;  v=spf1 include:spf1.baidu.com include:spf2.baidu.com include:spf3.baidu.com a mx ptr -all,google-site-verification=GHb98-6msqyx_qqjGl5eRatD3QTHyVB6-xQ3gJB5UwM&quot;</span><br><span class="line">&#125;</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;txt record of &apos;baidu.com&apos; v=spf1 include:spf1.baidu.com include:spf2.baidu.com include:spf3.baidu.com a mx ptr -all,google-site-verification=GHb98-6msqyx_qqjGl5eRatD3QTHyVB6-xQ3gJB5UwM&quot;</span><br><span class="line">&#125;</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;MX record of &apos;163.com&apos; 50 163mx00.mxmail.netease.com.,10 163mx01.mxmail.netease.com.,10 163mx03.mxmail.netease.com.,10 163mx02.mxmail.netease.com.&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">反向解析：</span><br><span class="line">- debug: msg=&quot;fqdn of &apos;8.8.8.8&apos; &#123;&#123; lookup(&apos;dig&apos;, &apos;8.8.8.8/PTR&apos;) &#125;&#125;&quot;</span><br><span class="line">结果：</span><br><span class="line">ok: [172.16.246.133] =&gt; &#123;</span><br><span class="line">    &quot;msg&quot;: &quot;fqdn of &apos;8.8.8.8&apos; google-public-dns-a.google.com.&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="Jinja2过滤器"><a href="#Jinja2过滤器" class="headerlink" title="Jinja2过滤器"></a>Jinja2过滤器</h2><ul>
<li>格式化数据</li>
</ul>
<ul>
<li>强制定义变量<br>对于未定义变量，Ansible默认行为是fail，也可关闭。</li>
</ul>
<ul>
<li>未定义变量默认值<br>Jinja2提供一个有用default过滤器，设置默认变量值。比强制定义变量更好。</li>
</ul>
<ul>
<li>忽略未定义变量和参数<br>可使用default过滤器忽略未定义的变量和模块参数</li>
</ul>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<p><a href="http://www.ansible.com.cn/index.html" target="_blank" rel="noopener">Ansible中文权威指南</a><br><a href="https://linux.cn/article-4215-3.html" target="_blank" rel="noopener">Ansible ：一个配置管理和IT自动化工具</a><br><a href="http://www.cnblogs.com/f-ck-need-u/p/7576137.html#ansible" target="_blank" rel="noopener">Ansible系列</a><br><a href="https://mp.weixin.qq.com/s?__biz=MzAxNTcyNzAyOQ==&amp;mid=2650960643&amp;idx=1&amp;sn=ba6a46d24f181eeb1308087830648cd8&amp;chksm=800973d9b77efacf2e0cc0ad2a4c015b7c67b511f1cb1786f4c74f2243e69e97da2955dce681&amp;mpshare=1&amp;scene=23&amp;srcid=0626IdjKI6mMzTfKSPwq6Dua#rd" target="_blank" rel="noopener">大神带你 20 分钟学会 Ansible！</a><br><a href="https://www.cnblogs.com/ilurker/p/6421624.html" target="_blank" rel="noopener">Ansible详解（一）</a><br><a href="https://www.cnblogs.com/ilurker/p/6421637.html" target="_blank" rel="noopener">Ansible详解（二）</a></p>
<p><a href="http://www.zsythink.net/archives/category/%E8%BF%90%E7%BB%B4%E7%9B%B8%E5%85%B3/ansible" target="_blank" rel="noopener">朱双印个人日志-Ansible</a></p>
<p>Linux集群与自动化运维</p>
<p>Ansible快速入门技术原理与实战</p>
</blockquote>

      
    </div>

    
      


    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/ansible/" rel="tag"># ansible</a>
          
            <a href="/tags/运维/" rel="tag"># 运维</a>
          
            <a href="/tags/监控/" rel="tag"># 监控</a>
          
            <a href="/tags/自动化/" rel="tag"># 自动化</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/05/27/LVS负载均衡笔记/" rel="next" title="LVS负载均衡学习笔记">
                <i class="fa fa-chevron-left"></i> LVS负载均衡学习笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/05/31/Nagios监控搭建/" rel="prev" title="Nagios监控搭建-1">
                Nagios监控搭建-1 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">tdLaogu</p>
              <p class="site-description motion-element" itemprop="description">已经是一条咸鱼了吧</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">62</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">90</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/serchaofan" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i></a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:624261309@qq.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i></a>
                  
                </span>
              
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="http://geekchen.top/" title="SuperChen" target="_blank">SuperChen</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="http://geekfan.top/" title="Geekfan" target="_blank">Geekfan</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible结构"><span class="nav-number">1.</span> <span class="nav-text">Ansible结构</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible安装"><span class="nav-number">2.</span> <span class="nav-text">Ansible安装</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Inventory"><span class="nav-number">3.</span> <span class="nav-text">Inventory</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible常见模块"><span class="nav-number">4.</span> <span class="nav-text">Ansible常见模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#cron"><span class="nav-number">4.0.1.</span> <span class="nav-text">cron</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user"><span class="nav-number">4.0.2.</span> <span class="nav-text">user</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#group"><span class="nav-number">4.0.3.</span> <span class="nav-text">group</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#copy"><span class="nav-number">4.0.4.</span> <span class="nav-text">copy</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#template"><span class="nav-number">4.0.5.</span> <span class="nav-text">template</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#file"><span class="nav-number">4.0.6.</span> <span class="nav-text">file</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#service"><span class="nav-number">4.0.7.</span> <span class="nav-text">service</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#command"><span class="nav-number">4.0.8.</span> <span class="nav-text">command</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#shell"><span class="nav-number">4.0.9.</span> <span class="nav-text">shell</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#script"><span class="nav-number">4.0.10.</span> <span class="nav-text">script</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#yum"><span class="nav-number">4.0.11.</span> <span class="nav-text">yum</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dnf"><span class="nav-number">4.0.12.</span> <span class="nav-text">dnf</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#setup"><span class="nav-number">4.0.13.</span> <span class="nav-text">setup</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#synchronize"><span class="nav-number">4.0.14.</span> <span class="nav-text">synchronize</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mount"><span class="nav-number">4.0.15.</span> <span class="nav-text">mount</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#get-url"><span class="nav-number">4.0.16.</span> <span class="nav-text">get_url</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Playbook"><span class="nav-number">5.</span> <span class="nav-text">Playbook</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#命令解析"><span class="nav-number">5.1.</span> <span class="nav-text">命令解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#变量引用"><span class="nav-number">5.2.</span> <span class="nav-text">变量引用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#register"><span class="nav-number">5.3.</span> <span class="nav-text">register</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#命令行传参"><span class="nav-number">5.4.</span> <span class="nav-text">命令行传参</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#notify与handler"><span class="nav-number">5.5.</span> <span class="nav-text">notify与handler</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#逻辑控制"><span class="nav-number">5.6.</span> <span class="nav-text">逻辑控制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#条件判断"><span class="nav-number">5.6.1.</span> <span class="nav-text">条件判断</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#迭代（循环）"><span class="nav-number">5.6.2.</span> <span class="nav-text">迭代（循环）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Block块"><span class="nav-number">5.6.3.</span> <span class="nav-text">Block块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模板"><span class="nav-number">5.6.4.</span> <span class="nav-text">模板</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#tags标签"><span class="nav-number">5.6.5.</span> <span class="nav-text">tags标签</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#include和roles"><span class="nav-number">5.6.6.</span> <span class="nav-text">include和roles</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#include"><span class="nav-number">5.6.6.1.</span> <span class="nav-text">include</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#roles"><span class="nav-number">5.6.6.2.</span> <span class="nav-text">roles</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用技巧"><span class="nav-number">5.7.</span> <span class="nav-text">常用技巧</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Ansible变量"><span class="nav-number">6.</span> <span class="nav-text">Ansible变量</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Lookup"><span class="nav-number">7.</span> <span class="nav-text">Lookup</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Jinja2过滤器"><span class="nav-number">7.1.</span> <span class="nav-text">Jinja2过滤器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">7.2.</span> <span class="nav-text">参考资料</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">tdLaogu</span>

  

  
</div>











        








        
      </div>
    </footer>

    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.2.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.2.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.2.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.2.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.2.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.2.0"></script>



  



	





  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
