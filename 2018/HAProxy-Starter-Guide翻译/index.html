<!DOCTYPE html>
<html lang="zh-CN">
    <head hexo-theme='https://github.com/volantis-x/hexo-theme-volantis/#5.7.7'>
  <meta name="generator" content="Hexo 6.3.0">
  <meta name="Volantis" content="5.7.7">
  <meta charset="utf-8">
  <!-- SEO相关 -->
  
  <link rel="canonical" href="https://tianyigu.top/2018/haproxy-starter-guide翻译/"/>
  <!-- 渲染优化 -->
    <meta http-equiv='x-dns-prefetch-control' content='on' />
      <link rel='dns-prefetch' href='https://unpkg.com'>
      <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <meta name="renderer" content="webkit">
  <meta name="force-rendering" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Content-Security-Policy" content=" default-src 'self' https:; block-all-mixed-content; base-uri 'self' https:; form-action 'self' https:; worker-src 'self' https:; connect-src 'self' https: *; img-src 'self' data: https: *; media-src 'self' https: *; font-src 'self' data: https: *; frame-src 'self' https: *; manifest-src 'self' https: *; child-src https:; script-src 'self' https: 'unsafe-inline' *; style-src 'self' https: 'unsafe-inline' *; ">
  <meta name="HandheldFriendly" content="True" >
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
  <meta content="black-translucent" name="apple-mobile-web-app-status-bar-style">
  <meta content="telephone=no" name="format-detection">
  <!-- import head_begin begin -->
  <!-- import head_begin end -->
  <!-- Custom Files headBegin begin-->
  
  <!-- Custom Files headBegin end-->
    <link rel="shortcut icon" type='image/x-icon' href="https://gcore.jsdelivr.net/gh/serchaofan/picBed/blog/202202240150263.jpg">
  <link rel="preload" href="/css/style.css" as="style">
  <link rel="preload" href="https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/VarelaRound/VarelaRound-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">
<link rel="preload" href="https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/UbuntuMono/UbuntuMono-Regular.ttf" as="font" type="font/ttf" crossorigin="anonymous">

  <!-- feed -->
  <!-- 页面元数据 -->
  <title>HAProxy Starter Guide翻译 - Tianyi的技术随笔</title>
  <meta name="keywords" content="HAProxy,翻译,undefined">
  <meta desc name="description" content="
译者：serchaofan
翻译主要借助翻译工具，并进行校对。
根据官方 18.14 与 18.15 文档 Starter Guide的翻译，并非完整翻译，且有的地方会有修改与删除。
 - Tianyi Gu - Tianyi的技术随笔">
  
<meta property="og:type" content="article">
<meta property="og:title" content="HAProxy Starter Guide翻译">
<meta property="og:url" content="https://tianyigu.top/2018/HAProxy-Starter-Guide%E7%BF%BB%E8%AF%91/index.html">
<meta property="og:site_name" content="Tianyi的技术随笔">
<meta property="og:description" content="译者：serchaofan 翻译主要借助翻译工具，并进行校对。 根据官方 18.14 与 18.15 文档 Starter Guide的翻译，并非完整翻译，且有的地方会有修改与删除。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
<meta property="article:published_time" content="2018-12-02T15:45:17.000Z">
<meta property="article:modified_time" content="2022-07-11T15:20:00.465Z">
<meta property="article:author" content="Tianyi Gu">
<meta property="article:tag" content="HAProxy">
<meta property="article:tag" content="翻译">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
  <style>
    /* 首屏样式 */
    #safearea {
  display: none;
}
:root {
  --color-site-body: #f4f4f4;
  --color-site-bg: #f4f4f4;
  --color-site-inner: #fff;
  --color-site-footer: #666;
  --color-card: #fff;
  --color-text: #444;
  --color-block: #f6f6f6;
  --color-inlinecode: #c74f00;
  --color-codeblock: #fff7ea;
  --color-h1: #3a3a3a;
  --color-h2: #3a3a3a;
  --color-h3: #333;
  --color-h4: #444;
  --color-h5: #555;
  --color-h6: #666;
  --color-p: #444;
  --color-list: #666;
  --color-list-hl: #30ad91;
  --color-meta: #888;
  --color-read-bkg: #e0d8c8;
  --color-read-post: #f8f1e2;
  --color-copyright-bkg: #f5f5f5;
}
* {
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  outline: none;
  margin: 0;
  padding: 0;
}
*::-webkit-scrollbar {
  height: 4px;
  width: 4px;
}
*::-webkit-scrollbar-track-piece {
  background: transparent;
}
*::-webkit-scrollbar-thumb {
  background: #3dd9b6;
  cursor: pointer;
  border-radius: 2px;
  -webkit-border-radius: 2px;
}
*::-webkit-scrollbar-thumb:hover {
  background: #ff5722;
}
html {
  color: var(--color-text);
  width: 100%;
  height: 100%;
  font-family: UbuntuMono, "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Menlo, Monaco, monospace, sans-serif;
  font-size: 16px;
}
html >::-webkit-scrollbar {
  height: 4px;
  width: 4px;
}
html >::-webkit-scrollbar-track-piece {
  background: transparent;
}
html >::-webkit-scrollbar-thumb {
  background: #3dd9b6;
  cursor: pointer;
  border-radius: 2px;
  -webkit-border-radius: 2px;
}
html >::-webkit-scrollbar-thumb:hover {
  background: #ff5722;
}
body {
  background-color: var(--color-site-body);
  text-rendering: optimizelegibility;
  -webkit-tap-highlight-color: rgba(0,0,0,0);
  line-height: 1.6;
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}
body.modal-active {
  overflow: hidden;
}
@media screen and (max-width: 680px) {
  body.modal-active {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
  }
}
a {
  color: #2092ec;
  cursor: pointer;
  text-decoration: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
a:hover {
  color: #ff5722;
}
a:active,
a:hover {
  outline: 0;
}
ul,
ol {
  padding-left: 0;
}
ul li,
ol li {
  list-style: none;
}
header {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
img {
  border: 0;
  background: none;
  max-width: 100%;
}
svg:not(:root) {
  overflow: hidden;
}
hr {
  -moz-box-sizing: content-box;
  box-sizing: content-box;
  -webkit-box-sizing: content-box;
  -moz-box-sizing: content-box;
  height: 0;
  border: 0;
  border-radius: 1px;
  -webkit-border-radius: 1px;
  border-bottom: 1px solid rgba(68,68,68,0.1);
}
button,
input {
  color: inherit;
  font: inherit;
  margin: 0;
}
button {
  overflow: visible;
  text-transform: none;
  -webkit-appearance: button;
  cursor: pointer;
}
@supports (backdrop-filter: blur(20px)) {
  .blur {
    background: rgba(255,255,255,0.9) !important;
    backdrop-filter: saturate(200%) blur(20px);
  }
}
.shadow {
  box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
}
.shadow.floatable {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.shadow.floatable:hover {
  box-shadow: 0 2px 4px 0px rgba(0,0,0,0.1), 0 4px 8px 0px rgba(0,0,0,0.1), 0 8px 16px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 2px 4px 0px rgba(0,0,0,0.1), 0 4px 8px 0px rgba(0,0,0,0.1), 0 8px 16px 0px rgba(0,0,0,0.1);
}
#l_cover {
  min-height: 64px;
}
.cover-wrapper {
  top: 0;
  left: 0;
  max-width: 100%;
  height: 100vh;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  align-self: center;
  align-content: center;
  color: var(--color-site-inner);
  padding: 0 16px;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  position: relative;
  overflow: hidden;
  margin-bottom: -100px;
}
.cover-wrapper .cover-bg {
  position: absolute;
  width: 100%;
  height: 100%;
  background-position: center;
  background-size: cover;
  -webkit-background-size: cover;
  -moz-background-size: cover;
}
.cover-wrapper .cover-bg.lazyload:not(.loaded) {
  opacity: 0;
  -webkit-opacity: 0;
  -moz-opacity: 0;
}
.cover-wrapper .cover-bg.lazyload.loaded {
  animation-delay: 0s;
  animation-duration: 0.5s;
  animation-fill-mode: forwards;
  animation-timing-function: ease-out;
  animation-name: fadeIn;
}
@-moz-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-webkit-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-o-keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@keyframes fadeIn {
  0% {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
    filter: blur(12px);
    transform: scale(1.02);
    -webkit-transform: scale(1.02);
    -khtml-transform: scale(1.02);
    -moz-transform: scale(1.02);
    -o-transform: scale(1.02);
    -ms-transform: scale(1.02);
  }
  100% {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.cover-wrapper .cover-body {
  z-index: 1;
  position: relative;
  width: 100%;
  height: 100%;
}
.cover-wrapper#full {
  height: calc(100vh + 100px);
  padding-bottom: 100px;
}
.cover-wrapper#half {
  max-height: 640px;
  min-height: 400px;
  height: calc(36vh - 64px + 200px);
}
.cover-wrapper #scroll-down {
  width: 100%;
  height: 64px;
  position: absolute;
  bottom: 100px;
  text-align: center;
  cursor: pointer;
}
.cover-wrapper #scroll-down .scroll-down-effects {
  color: #fff;
  font-size: 24px;
  line-height: 64px;
  position: absolute;
  width: 24px;
  left: calc(50% - 12px);
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
  animation: scroll-down-effect 1.5s infinite;
  -webkit-animation: scroll-down-effect 1.5s infinite;
  -khtml-animation: scroll-down-effect 1.5s infinite;
  -moz-animation: scroll-down-effect 1.5s infinite;
  -o-animation: scroll-down-effect 1.5s infinite;
  -ms-animation: scroll-down-effect 1.5s infinite;
}
@-moz-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-webkit-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@-o-keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@keyframes scroll-down-effect {
  0% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
  50% {
    top: -16px;
    opacity: 0.4;
    -webkit-opacity: 0.4;
    -moz-opacity: 0.4;
  }
  100% {
    top: 0;
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.cover-wrapper .cover-body {
  margin-top: 64px;
  margin-bottom: 100px;
}
.cover-wrapper .cover-body,
.cover-wrapper .cover-body .top,
.cover-wrapper .cover-body .bottom {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  max-width: 100%;
}
.cover-wrapper .cover-body .bottom {
  margin-top: 32px;
}
.cover-wrapper .cover-body .title {
  font-family: "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Helvetica, monospace;
  font-size: 3.125rem;
  line-height: 1.2;
  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
}
.cover-wrapper .cover-body .subtitle {
  font-size: 20px;
}
.cover-wrapper .cover-body .logo {
  max-height: 120px;
  max-width: calc(100% - 4 * 16px);
}
@media screen and (min-height: 1024px) {
  .cover-wrapper .cover-body .title {
    font-size: 3rem;
  }
  .cover-wrapper .cover-body .subtitle {
    font-size: 1.05rem;
  }
  .cover-wrapper .cover-body .logo {
    max-height: 150px;
  }
}
.cover-wrapper .cover-body .m_search {
  position: relative;
  max-width: calc(100% - 16px);
  width: 320px;
  vertical-align: middle;
}
.cover-wrapper .cover-body .m_search .form {
  position: relative;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  width: 100%;
}
.cover-wrapper .cover-body .m_search .icon,
.cover-wrapper .cover-body .m_search .input {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.cover-wrapper .cover-body .m_search .icon {
  position: absolute;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  line-height: 2.5rem;
  width: 32px;
  top: 0;
  left: 5px;
  color: rgba(68,68,68,0.75);
}
.cover-wrapper .cover-body .m_search .input {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  height: 2.5rem;
  width: 100%;
  box-shadow: none;
  -webkit-box-shadow: none;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  font-size: 0.875rem;
  -webkit-appearance: none;
  padding-left: 36px;
  border-radius: 1.4rem;
  -webkit-border-radius: 1.4rem;
  background: rgba(255,255,255,0.6);
  backdrop-filter: blur(10px);
  border: none;
  color: var(--color-text);
}
@media screen and (max-width: 500px) {
  .cover-wrapper .cover-body .m_search .input {
    padding-left: 36px;
  }
}
.cover-wrapper .cover-body .m_search .input:hover {
  background: rgba(255,255,255,0.8);
}
.cover-wrapper .cover-body .m_search .input:focus {
  background: #fff;
}
.cover-wrapper .list-h {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: horizontal;
  -moz-box-orient: horizontal;
  -webkit-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  flex-wrap: wrap;
  -webkit-flex-wrap: wrap;
  -khtml-flex-wrap: wrap;
  -moz-flex-wrap: wrap;
  -o-flex-wrap: wrap;
  -ms-flex-wrap: wrap;
  align-items: stretch;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
.cover-wrapper .list-h a {
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -webkit-flex: 1 0;
  -ms-flex: 1 0;
  flex: 1 0;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  font-weight: 600;
}
.cover-wrapper .list-h a img {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  border-radius: 2px;
  -webkit-border-radius: 2px;
  margin: 4px;
  min-width: 40px;
  max-width: 44px;
}
@media screen and (max-width: 768px) {
  .cover-wrapper .list-h a img {
    min-width: 36px;
    max-width: 40px;
  }
}
@media screen and (max-width: 500px) {
  .cover-wrapper .list-h a img {
    margin: 2px 4px;
    min-width: 32px;
    max-width: 36px;
  }
}
@media screen and (max-width: 375px) {
  .cover-wrapper .list-h a img {
    min-width: 28px;
    max-width: 32px;
  }
}
.cover-wrapper {
  max-width: 100%;
}
.cover-wrapper.search .bottom .menu {
  margin-top: 16px;
}
.cover-wrapper.search .bottom .menu .list-h a {
  white-space: nowrap;
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: horizontal;
  -moz-box-orient: horizontal;
  -webkit-flex-direction: row;
  -ms-flex-direction: row;
  flex-direction: row;
  align-items: baseline;
  padding: 2px;
  margin: 4px;
  color: var(--color-site-inner);
  opacity: 0.75;
  -webkit-opacity: 0.75;
  -moz-opacity: 0.75;
  text-shadow: 0 1px 2px rgba(0,0,0,0.05);
  border-bottom: 2px solid transparent;
}
.cover-wrapper.search .bottom .menu .list-h a i {
  margin-right: 4px;
}
.cover-wrapper.search .bottom .menu .list-h a p {
  font-size: 0.9375rem;
}
.cover-wrapper.search .bottom .menu .list-h a:hover,
.cover-wrapper.search .bottom .menu .list-h a.active,
.cover-wrapper.search .bottom .menu .list-h a:active {
  opacity: 1;
  -webkit-opacity: 1;
  -moz-opacity: 1;
  border-bottom: 2px solid var(--color-site-inner);
}
.cover-wrapper.dock .menu,
.cover-wrapper.featured .menu,
.cover-wrapper.focus .menu {
  border-radius: 6px;
  -webkit-border-radius: 6px;
}
.cover-wrapper.dock .menu .list-h a,
.cover-wrapper.featured .menu .list-h a,
.cover-wrapper.focus .menu .list-h a {
  -webkit-box-direction: normal;
  -moz-box-direction: normal;
  -webkit-box-orient: vertical;
  -moz-box-orient: vertical;
  -webkit-flex-direction: column;
  -ms-flex-direction: column;
  flex-direction: column;
  align-items: center;
  padding: 12px;
  line-height: 24px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  border-bottom: none;
  text-align: center;
  align-content: flex-end;
  color: rgba(68,68,68,0.7);
  font-size: 1.5rem;
}
@media screen and (max-width: 500px) {
  .cover-wrapper.dock .menu .list-h a,
  .cover-wrapper.featured .menu .list-h a,
  .cover-wrapper.focus .menu .list-h a {
    padding: 12px 8px;
  }
}
.cover-wrapper.dock .menu .list-h a i,
.cover-wrapper.featured .menu .list-h a i,
.cover-wrapper.focus .menu .list-h a i {
  margin: 8px;
}
.cover-wrapper.dock .menu .list-h a p,
.cover-wrapper.featured .menu .list-h a p,
.cover-wrapper.focus .menu .list-h a p {
  font-size: 0.875rem;
}
.cover-wrapper.dock .menu .list-h a.active,
.cover-wrapper.featured .menu .list-h a.active,
.cover-wrapper.focus .menu .list-h a.active {
  background: var(--color-card);
  backdrop-filter: none;
}
.cover-wrapper.dock .menu .list-h a.active i,
.cover-wrapper.featured .menu .list-h a.active i,
.cover-wrapper.focus .menu .list-h a.active i,
.cover-wrapper.dock .menu .list-h a.active i+p,
.cover-wrapper.featured .menu .list-h a.active i+p,
.cover-wrapper.focus .menu .list-h a.active i+p {
  color: #3dd9b6;
}
.cover-wrapper.dock .menu .list-h a.active img+p,
.cover-wrapper.featured .menu .list-h a.active img+p,
.cover-wrapper.focus .menu .list-h a.active img+p {
  color: var(--color-text);
}
.cover-wrapper.dock .menu .list-h a:hover,
.cover-wrapper.featured .menu .list-h a:hover,
.cover-wrapper.focus .menu .list-h a:hover {
  background: var(--color-card);
}
.cover-wrapper.dock .top {
  margin-bottom: 48px;
}
.cover-wrapper.dock .menu {
  background: rgba(255,255,255,0.5);
  position: absolute;
  bottom: 0;
  max-width: 100%;
}
.cover-wrapper.dock .menu .list-h {
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  margin: 4px;
}
.cover-wrapper.dock .menu .list-h a+a {
  margin-left: 4px;
}
@media screen and (max-width: 500px) {
  .cover-wrapper.dock .menu .list-h {
    overflow-x: scroll;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar {
    height: 0;
    width: 0;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar-track-piece {
    background: transparent;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar-thumb {
    background: #3dd9b6;
    cursor: pointer;
    border-radius: 0;
    -webkit-border-radius: 0;
  }
  .cover-wrapper.dock .menu .list-h::-webkit-scrollbar-thumb:hover {
    background: #ff5722;
  }
}
@supports (backdrop-filter: blur(20px)) {
  .cover-wrapper.dock .menu {
    background: rgba(255,255,255,0.5);
    backdrop-filter: saturate(200%) blur(20px);
  }
}
@font-face {
  font-family: 'UbuntuMono';
  src: url("https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/UbuntuMono/UbuntuMono-Regular.ttf");
  font-weight: 'normal';
  font-style: 'normal';
  font-display: swap;
}
@font-face {
  font-family: 'Varela Round';
  src: url("https://unpkg.com/volantis-static@0.0.1654736714924/media/fonts/VarelaRound/VarelaRound-Regular.ttf");
  font-weight: 'normal';
  font-style: 'normal';
  font-display: swap;
}
.l_header {
  position: fixed;
  z-index: 1000;
  top: 0;
  width: 100%;
  height: 64px;
  background: var(--color-card);
  box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
  -webkit-box-shadow: 0 1px 2px 0px rgba(0,0,0,0.1);
}
.l_header.auto {
  transition: opacity 0.4s ease;
  -webkit-transition: opacity 0.4s ease;
  -khtml-transition: opacity 0.4s ease;
  -moz-transition: opacity 0.4s ease;
  -o-transition: opacity 0.4s ease;
  -ms-transition: opacity 0.4s ease;
  visibility: hidden;
}
.l_header.auto.show {
  opacity: 1 !important;
  -webkit-opacity: 1 !important;
  -moz-opacity: 1 !important;
  visibility: visible;
}
.l_header .container {
  margin-left: 16px;
  margin-right: 16px;
}
.l_header #wrapper {
  height: 100%;
  user-select: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
}
.l_header #wrapper .nav-main,
.l_header #wrapper .nav-sub {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  flex-wrap: nowrap;
  -webkit-flex-wrap: nowrap;
  -khtml-flex-wrap: nowrap;
  -moz-flex-wrap: nowrap;
  -o-flex-wrap: nowrap;
  -ms-flex-wrap: nowrap;
  justify-content: space-between;
  -webkit-justify-content: space-between;
  -khtml-justify-content: space-between;
  -moz-justify-content: space-between;
  -o-justify-content: space-between;
  -ms-justify-content: space-between;
  align-items: center;
}
.l_header #wrapper .nav-main {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.l_header #wrapper.sub .nav-main {
  transform: translateY(-64px);
  -webkit-transform: translateY(-64px);
  -khtml-transform: translateY(-64px);
  -moz-transform: translateY(-64px);
  -o-transform: translateY(-64px);
  -ms-transform: translateY(-64px);
}
.l_header #wrapper .nav-sub {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  opacity: 0;
  -webkit-opacity: 0;
  -moz-opacity: 0;
  height: 64px;
  width: calc(100% - 2 * 16px);
  position: absolute;
}
.l_header #wrapper .nav-sub ::-webkit-scrollbar {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
}
@media screen and (min-width: 2048px) {
  .l_header #wrapper .nav-sub {
    max-width: 55vw;
    margin: auto;
  }
}
.l_header #wrapper.sub .nav-sub {
  opacity: 1;
  -webkit-opacity: 1;
  -moz-opacity: 1;
}
.l_header #wrapper .title {
  position: relative;
  color: var(--color-text);
  padding-left: 24px;
  max-height: 64px;
}
.l_header #wrapper .nav-main .title {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  flex-shrink: 0;
  line-height: 64px;
  padding: 0 24px;
  font-size: 1.25rem;
  font-family: "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Helvetica, monospace;
}
.l_header #wrapper .nav-main .title img {
  height: 64px;
}
.l_header .nav-sub {
  max-width: 1580px;
  margin: auto;
}
.l_header .nav-sub .title {
  font-weight: bold;
  font-family: UbuntuMono, "Varela Round", "PingFang SC", "Microsoft YaHei", Helvetica, Arial, Menlo, Monaco, monospace, sans-serif;
  line-height: 1.2;
  max-height: 64px;
  white-space: normal;
  flex-shrink: 1;
}
.l_header .switcher {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  line-height: 64px;
  align-items: center;
}
.l_header .switcher .s-toc {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
}
@media screen and (max-width: 768px) {
  .l_header .switcher .s-toc {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: -ms-flexbox /* TWEENER - IE 10 */;
    display: -webkit-flex /* NEW - Chrome */;
    display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
    display: flex;
  }
}
.l_header .switcher >li {
  height: 48px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  margin: 2px;
}
@media screen and (max-width: 500px) {
  .l_header .switcher >li {
    margin: 0 1px;
    height: 48px;
  }
}
.l_header .switcher >li >a {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  align-items: center;
  width: 48px;
  height: 48px;
  padding: 0.85em 1.1em;
  border-radius: 100px;
  -webkit-border-radius: 100px;
  border: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  color: #3dd9b6;
}
.l_header .switcher >li >a:hover {
  border: none;
}
.l_header .switcher >li >a.active,
.l_header .switcher >li >a:active {
  border: none;
  background: var(--color-site-bg);
}
@media screen and (max-width: 500px) {
  .l_header .switcher >li >a {
    width: 36px;
    height: 48px;
  }
}
.l_header .nav-sub .switcher {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
}
.l_header .m_search {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  height: 64px;
  width: 240px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
@media screen and (max-width: 1024px) {
  .l_header .m_search {
    width: 44px;
    min-width: 44px;
  }
  .l_header .m_search input::placeholder {
    opacity: 0;
    -webkit-opacity: 0;
    -moz-opacity: 0;
  }
  .l_header .m_search:hover {
    width: 240px;
  }
  .l_header .m_search:hover input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@media screen and (min-width: 500px) {
  .l_header .m_search:hover .input {
    width: 100%;
  }
  .l_header .m_search:hover .input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
@media screen and (max-width: 500px) {
  .l_header .m_search {
    min-width: 0;
  }
  .l_header .m_search input::placeholder {
    opacity: 1;
    -webkit-opacity: 1;
    -moz-opacity: 1;
  }
}
.l_header .m_search .form {
  position: relative;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  width: 100%;
  align-items: center;
}
.l_header .m_search .icon {
  position: absolute;
  width: 36px;
  left: 5px;
  color: var(--color-meta);
}
@media screen and (max-width: 500px) {
  .l_header .m_search .icon {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: none;
  }
}
.l_header .m_search .input {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  padding-top: 8px;
  padding-bottom: 8px;
  line-height: 1.3;
  width: 100%;
  color: var(--color-text);
  background: #fafafa;
  box-shadow: none;
  -webkit-box-shadow: none;
  box-sizing: border-box;
  -webkit-box-sizing: border-box;
  -moz-box-sizing: border-box;
  padding-left: 40px;
  font-size: 0.875rem;
  border-radius: 8px;
  -webkit-border-radius: 8px;
  border: none;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
@media screen and (min-width: 500px) {
  .l_header .m_search .input:focus {
    box-shadow: 0 4px 8px 0px rgba(0,0,0,0.1);
    -webkit-box-shadow: 0 4px 8px 0px rgba(0,0,0,0.1);
  }
}
@media screen and (max-width: 500px) {
  .l_header .m_search .input {
    background: var(--color-block);
    padding-left: 8px;
    border: none;
  }
  .l_header .m_search .input:hover,
  .l_header .m_search .input:focus {
    border: none;
  }
}
@media (max-width: 500px) {
  .l_header .m_search {
    left: 0;
    width: 0;
    overflow: hidden;
    position: absolute;
    background: #fff;
    transition: all 0.28s ease;
    -webkit-transition: all 0.28s ease;
    -khtml-transition: all 0.28s ease;
    -moz-transition: all 0.28s ease;
    -o-transition: all 0.28s ease;
    -ms-transition: all 0.28s ease;
  }
  .l_header .m_search .input {
    border-radius: 32px;
    -webkit-border-radius: 32px;
    margin-left: 16px;
    padding-left: 16px;
  }
  .l_header.z_search-open .m_search {
    width: 100%;
  }
  .l_header.z_search-open .m_search .input {
    width: calc(100% - 120px);
  }
}
ul.m-pc >li>a {
  color: inherit;
  border-bottom: 2px solid transparent;
}
ul.m-pc >li>a:active,
ul.m-pc >li>a.active {
  border-bottom: 2px solid #3dd9b6;
}
ul.m-pc li:hover >ul.list-v,
ul.list-v li:hover >ul.list-v {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
ul.nav-list-h {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: -ms-flexbox /* TWEENER - IE 10 */;
  display: -webkit-flex /* NEW - Chrome */;
  display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
  display: flex;
  align-items: stretch;
}
ul.nav-list-h>li {
  position: relative;
  justify-content: center;
  -webkit-justify-content: center;
  -khtml-justify-content: center;
  -moz-justify-content: center;
  -o-justify-content: center;
  -ms-justify-content: center;
  height: 100%;
  line-height: 2.4;
  border-radius: 4px;
  -webkit-border-radius: 4px;
}
ul.nav-list-h>li >a {
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  font-weight: 600;
}
ul.list-v {
  z-index: 1;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  position: absolute;
  background: var(--color-card);
  box-shadow: 0 2px 4px 0px rgba(0,0,0,0.08), 0 4px 8px 0px rgba(0,0,0,0.08), 0 8px 16px 0px rgba(0,0,0,0.08);
  -webkit-box-shadow: 0 2px 4px 0px rgba(0,0,0,0.08), 0 4px 8px 0px rgba(0,0,0,0.08), 0 8px 16px 0px rgba(0,0,0,0.08);
  margin-top: -6px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  padding: 8px 0;
}
ul.list-v.show {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
}
ul.list-v hr {
  margin-top: 8px;
  margin-bottom: 8px;
}
ul.list-v >li {
  white-space: nowrap;
  word-break: keep-all;
}
ul.list-v >li.header {
  font-size: 0.78125rem;
  font-weight: bold;
  line-height: 2em;
  color: var(--color-meta);
  margin: 8px 16px 4px;
}
ul.list-v >li.header i {
  margin-right: 8px;
}
ul.list-v >li ul {
  margin-left: 0;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  margin-top: -40px;
}
ul.list-v .aplayer-container {
  min-height: 64px;
  padding: 6px 16px;
}
ul.list-v >li>a {
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  color: var(--color-list);
  font-size: 0.875rem;
  font-weight: bold;
  line-height: 36px;
  padding: 0 20px 0 16px;
  text-overflow: ellipsis;
  margin: 0 4px;
  border-radius: 4px;
  -webkit-border-radius: 4px;
}
@media screen and (max-width: 1024px) {
  ul.list-v >li>a {
    line-height: 40px;
  }
}
ul.list-v >li>a >i {
  margin-right: 8px;
}
ul.list-v >li>a:active,
ul.list-v >li>a.active {
  color: var(--color-list-hl);
}
ul.list-v >li>a:hover {
  color: var(--color-list-hl);
  background: var(--color-site-bg);
}
.l_header .menu >ul>li>a {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: block;
  padding: 0 8px;
}
.l_header .menu >ul>li>a >i {
  margin-right: 4px;
}
.l_header ul.nav-list-h>li {
  color: var(--color-list);
  line-height: 64px;
}
.l_header ul.nav-list-h>li >a {
  max-height: 64px;
  overflow: hidden;
  color: inherit;
}
.l_header ul.nav-list-h>li >a:active,
.l_header ul.nav-list-h>li >a.active {
  color: #3dd9b6;
}
.l_header ul.nav-list-h>li:hover>a {
  color: var(--color-list-hl);
}
.l_header ul.nav-list-h>li i.music {
  animation: rotate-effect 1.5s linear infinite;
  -webkit-animation: rotate-effect 1.5s linear infinite;
  -khtml-animation: rotate-effect 1.5s linear infinite;
  -moz-animation: rotate-effect 1.5s linear infinite;
  -o-animation: rotate-effect 1.5s linear infinite;
  -ms-animation: rotate-effect 1.5s linear infinite;
}
@-moz-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@-webkit-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@-o-keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
@keyframes rotate-effect {
  0% {
    transform: rotate(0);
    -webkit-transform: rotate(0);
    -khtml-transform: rotate(0);
    -moz-transform: rotate(0);
    -o-transform: rotate(0);
    -ms-transform: rotate(0);
  }
  25% {
    transform: rotate(90deg);
    -webkit-transform: rotate(90deg);
    -khtml-transform: rotate(90deg);
    -moz-transform: rotate(90deg);
    -o-transform: rotate(90deg);
    -ms-transform: rotate(90deg);
  }
  50% {
    transform: rotate(180deg);
    -webkit-transform: rotate(180deg);
    -khtml-transform: rotate(180deg);
    -moz-transform: rotate(180deg);
    -o-transform: rotate(180deg);
    -ms-transform: rotate(180deg);
  }
  75% {
    transform: rotate(270deg);
    -webkit-transform: rotate(270deg);
    -khtml-transform: rotate(270deg);
    -moz-transform: rotate(270deg);
    -o-transform: rotate(270deg);
    -ms-transform: rotate(270deg);
  }
  100% {
    transform: rotate(360deg);
    -webkit-transform: rotate(360deg);
    -khtml-transform: rotate(360deg);
    -moz-transform: rotate(360deg);
    -o-transform: rotate(360deg);
    -ms-transform: rotate(360deg);
  }
}
.menu-phone li ul.list-v {
  right: calc(100% - 0.5 * 16px);
}
.menu-phone li ul.list-v ul {
  right: calc(100% - 0.5 * 16px);
}
#wrapper {
  max-width: 1580px;
  margin: auto;
}
@media screen and (min-width: 2048px) {
  #wrapper {
    max-width: 55vw;
  }
}
#wrapper .menu {
  -webkit-box-flex: 1;
  -moz-box-flex: 1;
  -webkit-flex: 1 1;
  -ms-flex: 1 1;
  flex: 1 1;
  margin: 0 16px 0 0;
}
#wrapper .menu .list-v ul {
  left: calc(100% - 0.5 * 16px);
}
.menu-phone {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  margin-top: 16px;
  right: 8px;
  transition: all 0.28s ease;
  -webkit-transition: all 0.28s ease;
  -khtml-transition: all 0.28s ease;
  -moz-transition: all 0.28s ease;
  -o-transition: all 0.28s ease;
  -ms-transition: all 0.28s ease;
}
.menu-phone ul {
  right: calc(100% - 0.5 * 16px);
}
@media screen and (max-width: 500px) {
  .menu-phone {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: block;
  }
}
.l_header {
  max-width: 65vw;
  left: calc((100% - 65vw) * 0.5);
  border-bottom-left-radius: 8px;
  border-bottom-right-radius: 8px;
}
@media screen and (max-width: 2048px) {
  .l_header {
    max-width: 1612px;
    left: calc((100% - 1612px) * 0.5);
  }
}
@media screen and (max-width: 1612px) {
  .l_header {
    left: 0;
    border-radius: 0;
    -webkit-border-radius: 0;
    max-width: 100%;
  }
}
@media screen and (max-width: 500px) {
  .l_header .container {
    margin-left: 0;
    margin-right: 0;
  }
  .l_header #wrapper .nav-main .title {
    padding-left: 16px;
    padding-right: 16px;
  }
  .l_header #wrapper .nav-sub {
    width: 100%;
  }
  .l_header #wrapper .nav-sub .title {
    overflow-y: scroll;
    margin-top: 2px;
    padding: 8px 16px;
  }
  .l_header #wrapper .switcher {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: -ms-flexbox /* TWEENER - IE 10 */;
    display: -webkit-flex /* NEW - Chrome */;
    display: flex /* NEW, Spec - Opera 12.1, Firefox 20+ */;
    display: flex;
    margin-right: 8px;
  }
  .l_header .menu {
    display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
    display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
    display: none;
  }
}
@media screen and (max-width: 500px) {
  .list-v li {
    max-width: 270px;
  }
}
#u-search {
  display: -webkit-box /* OLD - iOS 6-, Safari 3.1-6 */;
  display: -moz-box /* OLD - Firefox 19- (buggy but mostly works) */;
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  padding: 60px 20px;
  z-index: 1001;
}
@media screen and (max-width: 680px) {
  #u-search {
    padding: 0px;
  }
}

  </style>
  <link rel="stylesheet" href="/css/style.css" media="print" onload="this.media='all';this.onload=null">
  <noscript><link rel="stylesheet" href="/css/style.css"></noscript>
  
<script>
if (/*@cc_on!@*/false || (!!window.MSInputMethodContext && !!document.documentMode))
    document.write(
	'<style>'+
		'html{'+
			'overflow-x: hidden !important;'+
			'overflow-y: hidden !important;'+
		'}'+
		'.kill-ie{'+
			'text-align:center;'+
			'height: 100%;'+
			'margin-top: 15%;'+
			'margin-bottom: 5500%;'+
		'}'+
    '.kill-t{'+
      'font-size: 2rem;'+
    '}'+
    '.kill-c{'+
      'font-size: 1.2rem;'+
    '}'+
		'#l_header,#l_body{'+
			'display: none;'+
		'}'+
	'</style>'+
    '<div class="kill-ie">'+
        `<span class="kill-t"><b>抱歉，您的浏览器无法访问本站</b></span><br/>`+
        `<span class="kill-c">微软已经于2016年终止了对 Internet Explorer (IE) 10 及更早版本的支持，<br/>继续使用存在极大的安全隐患，请使用当代主流的浏览器进行访问。</span><br/>`+
        `<a target="_blank" rel="noopener" href="https://blogs.windows.com/windowsexperience/2021/05/19/the-future-of-internet-explorer-on-windows-10-is-in-microsoft-edge/"><strong>了解详情 ></strong></a>`+
    '</div>');
</script>


<noscript>
	<style>
		html{
			overflow-x: hidden !important;
			overflow-y: hidden !important;
		}
		.kill-noscript{
			text-align:center;
			height: 100%;
			margin-top: 15%;
			margin-bottom: 5500%;
		}
    .kill-t{
      font-size: 2rem;
    }
    .kill-c{
      font-size: 1.2rem;
    }
		#l_header,#l_body{
			display: none;
		}
	</style>
    <div class="kill-noscript">
        <span class="kill-t"><b>抱歉，您的浏览器无法访问本站</b></span><br/>
        <span class="kill-c">本页面需要浏览器支持（启用）JavaScript</span><br/>
        <a target="_blank" rel="noopener" href="https://www.baidu.com/s?wd=启用JavaScript"><strong>了解详情 ></strong></a>
    </div>
</noscript>


  <script>
  /************这个文件存放不需要重载的全局变量和全局函数*********/
  window.volantis = {}; // volantis 全局变量
  volantis.debug = "env"; // 调试模式
  volantis.dom = {}; // 页面Dom see: /source/js/app.js etc.

  volantis.GLOBAL_CONFIG ={
    debug: "env",
    cdn: {"js":{"app":"/js/app.js","parallax":"/js/plugins/parallax.js","rightMenu":"/js/plugins/rightMenu.js","rightMenus":"/js/plugins/rightMenus.js","sites":"/js/plugins/tags/sites.js","friends":"/js/plugins/tags/friends.js","contributors":"/js/plugins/tags/contributors.js","search":"/js/search/hexo.js"},"css":{"style":"/css/style.css"}},
    default: {"avatar":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/avatar/round/3442075.svg","link":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/link/8f277b4ee0ecd.svg","cover":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/cover/76b86c0226ffd.svg","image":"https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/image/2659360.svg"},
    lastupdate: new Date(1682016589825),
    sidebar: {
      for_page: ["blogger","category","tagcloud"],
      for_post: ["toc"],
      webinfo: {
        lastupd: {
          enable: true,
          friendlyShow: true
        },
        runtime: {
          data: "2020/01/01",
          unit: "天"
        }
      }
    },
    plugins: {
      message: {"enable":true,"css":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/izitoast/dist/css/iziToast.min.css","js":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/izitoast/dist/js/iziToast.min.js","icon":{"default":"fa-solid fa-info-circle light-blue","quection":"fa-solid fa-question-circle light-blue"},"time":{"default":5000,"quection":20000},"position":"topRight","transitionIn":"bounceInLeft","transitionOut":"fadeOutRight","titleColor":"var(--color-text)","messageColor":"var(--color-text)","backgroundColor":"var(--color-card)","zindex":2147483647,"copyright":{"enable":true,"title":"知识共享许可协议","message":"请遵守 CC BY-NC-SA 4.0 协议。","icon":"far fa-copyright light-blue"},"aplayer":{"enable":true,"play":"fa-solid fa-play","pause":"fa-solid fa-pause"},"rightmenu":{"enable":true,"notice":true}},
      fancybox: {"css":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fancyapps/ui/dist/fancybox.css","js":"https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fancyapps/ui/dist/fancybox.umd.js"},
      
      
      
    }
  }

  /******************** volantis.EventListener ********************************/
  // 事件监听器 see: /source/js/app.js
  volantis.EventListener = {}
  // 这里存放pjax切换页面时将被移除的事件监听器
  volantis.EventListener.list = []
  //构造方法
  function volantisEventListener(type, f, ele) {
    this.type = type
    this.f = f
    this.ele = ele
  }
  // 移除事件监听器
  volantis.EventListener.remove = () => {
    volantis.EventListener.list.forEach(function (i) {
      i.ele.removeEventListener(i.type, i.f, false)
    })
    volantis.EventListener.list = []
  }
  /******************** volantis.dom.$ ********************************/
  // 注：这里没有选择器，也没有forEach一次只处理一个dom，这里重新封装主题常用的dom方法，返回的是dom对象，对象包含了以下方法，同时保留dom的原生API
  function volantisDom(ele) {
    if (!ele) ele = document.createElement("div")
    this.ele = ele;
    // ==============================================================
    this.ele.find = (c) => {
      let q = this.ele.querySelector(c)
      if (q)
        return new volantisDom(q)
    }
    // ==============================================================
    this.ele.hasClass = (c) => {
      return this.ele.className.match(new RegExp('(\\s|^)' + c + '(\\s|$)'));
    }
    this.ele.addClass = (c) => {
      this.ele.classList.add(c);
      return this.ele
    }
    this.ele.removeClass = (c) => {
      this.ele.classList.remove(c);
      return this.ele
    }
    this.ele.toggleClass = (c) => {
      if (this.ele.hasClass(c)) {
        this.ele.removeClass(c)
      } else {
        this.ele.addClass(c)
      }
      return this.ele
    }
    // ==============================================================
    // 参数 r 为 true 表示pjax切换页面时事件监听器将被移除，false不移除
    this.ele.on = (c, f, r = 1) => {
      this.ele.addEventListener(c, f, false)
      if (r) {
        volantis.EventListener.list.push(new volantisEventListener(c, f, this.ele))
      }
      return this.ele
    }
    this.ele.click = (f, r) => {
      this.ele.on("click", f, r)
      return this.ele
    }
    this.ele.scroll = (f, r) => {
      this.ele.on("scroll", f, r)
      return this.ele
    }
    // ==============================================================
    this.ele.html = (c) => {
      // if(c=== undefined){
      //   return this.ele.innerHTML
      // }else{
      this.ele.innerHTML = c
      return this.ele
      // }
    }
    // ==============================================================
    this.ele.hide = (c) => {
      this.ele.style.display = "none"
      return this.ele
    }
    this.ele.show = (c) => {
      this.ele.style.display = "block"
      return this.ele
    }
    // ==============================================================
    return this.ele
  }
  volantis.dom.$ = (ele) => {
    return !!ele ? new volantisDom(ele) : null;
  }
  /******************** RunItem ********************************/
  function RunItem() {
    this.list = []; // 存放回调函数
    this.start = () => {
      for (var i = 0; i < this.list.length; i++) {
        this.list[i].run();
      }
    };
    this.push = (fn, name, setRequestAnimationFrame = true) => {
      let myfn = fn
      if (setRequestAnimationFrame) {
        myfn = ()=>{
          volantis.requestAnimationFrame(fn)
        }
      }
      var f = new Item(myfn, name);
      this.list.push(f);
    };
    this.remove = (name) =>{
      for (let index = 0; index < this.list.length; index++) {
        const e = this.list[index];
        if (e.name == name) {
          this.list.splice(index,1);
        }
      }
    }
    // 构造一个可以run的对象
    function Item(fn, name) {
      // 函数名称
      this.name = name || fn.name;
      // run方法
      this.run = () => {
        try {
          fn()
        } catch (error) {
          console.log(error);
        }
      };
    }
  }
  /******************** Pjax ********************************/
  // /layout/_plugins/pjax/index.ejs
  // volantis.pjax.send(callBack[,"callBackName"]) 传入pjax:send回调函数
  // volantis.pjax.push(callBack[,"callBackName"]) 传入pjax:complete回调函数
  // volantis.pjax.error(callBack[,"callBackName"]) 传入pjax:error回调函数
  volantis.pjax = {};
  volantis.pjax.method = {
    complete: new RunItem(),
    error: new RunItem(),
    send: new RunItem(),
  };
  volantis.pjax = Object.assign(volantis.pjax, {
    push: volantis.pjax.method.complete.push,
    error: volantis.pjax.method.error.push,
    send: volantis.pjax.method.send.push,
  });
  /******************** RightMenu ********************************/
  // volantis.rightmenu.handle(callBack[,"callBackName"]) 外部菜单项控制
  // 可在 volantis.mouseEvent 处获取右键事件
  volantis.rightmenu = {};
  volantis.rightmenu.method = {
    handle: new RunItem(),
  }
  volantis.rightmenu = Object.assign(volantis.rightmenu, {
    handle: volantis.rightmenu.method.handle.push,
  });
  /********************  Dark Mode  ********************************/
  // /layout/_partial/scripts/darkmode.ejs
  // volantis.dark.mode 当前模式 dark or light
  // volantis.dark.toggle() 暗黑模式触发器
  // volantis.dark.push(callBack[,"callBackName"]) 传入触发器回调函数
  volantis.dark = {};
  volantis.dark.method = {
    toggle: new RunItem(),
  };
  volantis.dark = Object.assign(volantis.dark, {
    push: volantis.dark.method.toggle.push,
  });
  /********************  Message  ********************************/
  // VolantisApp.message
  /********************  isMobile  ********************************/
  // /source/js/app.js
  // volantis.isMobile
  // volantis.isMobileOld
  /********************脚本动态加载函数********************************/
  // volantis.js(src, cb)  cb 可以传入onload回调函数 或者 JSON对象 例如: volantis.js("src", ()=>{}) 或 volantis.js("src", {defer:true,onload:()=>{}})
  // volantis.css(src)

  // 返回Promise对象，如下方法同步加载资源，这利于处理文件资源之间的依赖关系，例如：APlayer 需要在 MetingJS 之前加载
  // (async () => {
  //     await volantis.js("...theme.plugins.aplayer.js.aplayer...")
  //     await volantis.js("...theme.plugins.aplayer.js.meting...")
  // })();

  // 已经加入了setTimeout
  volantis.js = (src, cb) => {
    return new Promise(resolve => {
      setTimeout(function () {
        var HEAD = document.getElementsByTagName("head")[0] || document.documentElement;
        var script = document.createElement("script");
        script.setAttribute("type", "text/javascript");
        if (cb) {
          if (JSON.stringify(cb)) {
            for (let p in cb) {
              if (p == "onload") {
                script[p] = () => {
                  cb[p]()
                  resolve()
                }
              } else {
                script[p] = cb[p]
                script.onload = resolve
              }
            }
          } else {
            script.onload = () => {
              cb()
              resolve()
            };
          }
        } else {
          script.onload = resolve
        }
        script.setAttribute("src", src);
        HEAD.appendChild(script);
      });
    });
  }
  volantis.css = (src) => {
    return new Promise(resolve => {
      setTimeout(function () {
        var link = document.createElement('link');
        link.rel = "stylesheet";
        link.href = src;
        link.onload = resolve;
        document.getElementsByTagName("head")[0].appendChild(link);
      });
    });
  }
  /********************按需加载的插件********************************/
  // volantis.import.jQuery().then(()=>{})
  volantis.import = {
    jQuery: () => {
      if (typeof jQuery == "undefined") {
        return volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/jquery/dist/jquery.min.js")
      } else {
        return new Promise(resolve => {
          resolve()
        });
      }
    }
  }
  /********************** requestAnimationFrame ********************************/
  // 1、requestAnimationFrame 会把每一帧中的所有 DOM 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率，一般来说，这个频率为每秒60帧。
  // 2、在隐藏或不可见的元素中，requestAnimationFrame 将不会进行重绘或回流，这当然就意味着更少的的 cpu，gpu 和内存使用量。
  volantis.requestAnimationFrame = (fn)=>{
    if (!window.requestAnimationFrame) {
      window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame;
    }
    window.requestAnimationFrame(fn)
  }
  /************************ layoutHelper *****************************************/
  volantis.layoutHelper = (helper, html, opt)=>{
    opt = Object.assign({clean:false, pjax:true}, opt)
    function myhelper(helper, html, clean) {
      volantis.tempDiv = document.createElement("div");
      volantis.tempDiv.innerHTML = html;
      let layoutHelper = document.querySelector("#layoutHelper-"+helper)
      if (layoutHelper) {
        if (clean) {
          layoutHelper.innerHTML = ""
        }
        layoutHelper.append(volantis.tempDiv);
      }
    }
    myhelper(helper, html, opt.clean)
    if (opt.pjax) {
      volantis.pjax.push(()=>{
        myhelper(helper, html, opt.clean)
      },"layoutHelper-"+helper)
    }
  }
  /****************************** 滚动事件处理 ****************************************/
  volantis.scroll = {
    engine: new RunItem(),
    unengine: new RunItem(),
  };
  volantis.scroll = Object.assign(volantis.scroll, {
    push: volantis.scroll.engine.push,
  });
  // 滚动条距离顶部的距离
  volantis.scroll.getScrollTop = () =>{
    let scrollPos;
    if (window.pageYOffset) {
      scrollPos = window.pageYOffset;
    } else if (document.compatMode && document.compatMode != 'BackCompat') {
      scrollPos = document.documentElement.scrollTop;
    } else if (document.body) {
      scrollPos = document.body.scrollTop;
    }
    return scrollPos;
  }
  // 使用 requestAnimationFrame 处理滚动事件
  // `volantis.scroll.del` 中存储了一个数值, 该数值检测一定时间间隔内滚动条滚动的位移, 数值的检测频率是浏览器的刷新频率. 数值为正数时, 表示向下滚动. 数值为负数时, 表示向上滚动.
  volantis.scroll.handleScrollEvents = () => {
    volantis.scroll.lastScrollTop = volantis.scroll.getScrollTop()
    function loop() {
      const scrollTop = volantis.scroll.getScrollTop();
      if (volantis.scroll.lastScrollTop !== scrollTop) {
        volantis.scroll.del = scrollTop - volantis.scroll.lastScrollTop;
        volantis.scroll.lastScrollTop = scrollTop;
        // if (volantis.scroll.del > 0) {
        //   console.log("向下滚动");
        // } else {
        //   console.log("向上滚动");
        // }
        // 注销过期的unengine未滚动事件
        volantis.scroll.unengine.list=[]
        volantis.scroll.engine.start();
      }else{
        volantis.scroll.unengine.start();
      }
      volantis.requestAnimationFrame(loop)
    }
    volantis.requestAnimationFrame(loop)
  }
  volantis.scroll.handleScrollEvents()
  volantis.scroll.ele = null;
  // 触发页面滚动至目标元素位置
  volantis.scroll.to = (ele, option = {}) => {
    if (!ele) return;
    volantis.scroll.ele = ele;
    // 默认配置
    opt = {
      top: ele.getBoundingClientRect().top + document.documentElement.scrollTop,
      behavior: "smooth"
    }
    // 定义配置
    if ("top" in option) {
      opt.top = option.top
    }
    if ("behavior" in option) {
      opt.behavior = option.behavior
    }
    if ("addTop" in option) {
      opt.top += option.addTop
    }
    if (!("observerDic" in option)) {
      option.observerDic = 100
    }
    // 滚动
    window.scrollTo(opt);
    // 监视器
    // 监视并矫正元素滚动到指定位置
    // 用于处理 lazyload 引起的 cls 导致的定位失败问题
    // option.observer = false
    if (option.observer) {
      setTimeout(() => {
        if (volantis.scroll.ele != ele) {
          return
        }
        volantis.scroll.unengine.push(() => {
          let me = ele.getBoundingClientRect().top
          if(!(me >= -option.observerDic && me <= option.observerDic)){
            volantis.scroll.to(ele, option)
          }
          volantis.scroll.unengine.remove("unengineObserver")
        },"unengineObserver")
      },1000)
    }
  }
  /********************** Content Visibility ********************************/
  // 见 source/css/first.styl 如果遇到任何问题 删除 .post-story 即可
  // 一个元素被声明 content-visibility 属性后 如果元素不在 viewport 中 浏览器不会计算其后代元素样式和属性 从而节省 Style & Layout 耗时
  // content-visibility 的副作用: 锚点失效 等等(实验初期 暂不明确), 使用此方法清除样式
  volantis.cleanContentVisibility = ()=>{
    if (document.querySelector(".post-story")) {
      console.log("cleanContentVisibility");
      document.querySelectorAll(".post-story").forEach(e=>{
        e.classList.remove("post-story")
      })
    }
  }
  /******************************************************************************/
  /******************************************************************************/
  /******************************************************************************/
  //图像加载出错时的处理
  function errorImgAvatar(img) {
    img.src = "https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/avatar/round/3442075.svg";
    img.onerror = null;
  }
  function errorImgCover(img) {
    img.src = "https://unpkg.com/volantis-static@0.0.1654736714924/media/placeholder/cover/76b86c0226ffd.svg";
    img.onerror = null;
  }
  /******************************************************************************/
</script>

  <!-- import head_end begin -->
  <!-- import head_end end -->
  <!-- Custom Files headEnd begin-->
  
  <!-- Custom Files headEnd end-->
</head>
  <body itemscope itemtype="http://schema.org/WebPage">
    <!-- import body_begin begin-->
    <!-- import body_begin end-->
    <!-- Custom Files bodyBegin begin-->
    
    <!-- Custom Files bodyBegin end-->
    <header itemscope itemtype="http://schema.org/WPHeader" id="l_header" class="l_header auto shadow floatable blur show" style='opacity: 0' >
  <div class='container'>
  <div id='wrapper'>
    <div class='nav-sub'>
      <p class="title"></p>
      <ul class='switcher nav-list-h m-phone' id="pjax-header-nav-list">
        <li><a id="s-comment" class="fa-solid fa-comments fa-fw" target="_self"  href="/" onclick="return false;" title="comment"></a></li>
        
          <li><a id="s-toc" class="s-toc fa-solid fa-list fa-fw" target="_self"  href="/" onclick="return false;" title="toc"></a></li>
        
      </ul>
    </div>
		<div class="nav-main">
      

			<div class='menu navigation'>
				<ul class='nav-list-h m-pc'>
          
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/" title="文档"
                  
                  
                  
                    active-action="action-home"
                  >
                  <i class='fa-sharp fa-solid fa-book fa-fw'></i>文档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/categories/" title="分类"
                  
                  
                  
                    active-action="action-categories"
                  >
                  <i class='fa-solid fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/tags/" title="标签"
                  
                  
                  
                    active-action="action-tags"
                  >
                  <i class='fa-solid fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/archives/" title="归档"
                  
                  
                  
                    active-action="action-archives"
                  >
                  <i class='fa-solid fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
          
            
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/friends/" title="友链"
                  
                  
                  
                    active-action="action-friends"
                  >
                  <i class='fa-solid fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
          
				</ul>
			</div>
      
      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fa-solid fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="Search..." />
        </form>
      </div>
      

			<ul class='switcher nav-list-h m-phone'>
				
					<li><a class="s-search fa-solid fa-search fa-fw" target="_self" href="/" onclick="return false;" title="search"></a></li>
				
				<li>
          <a class="s-menu fa-solid fa-bars fa-fw" target="_self" href="/" onclick="return false;" title="menu"></a>
          <ul class="menu-phone list-v navigation white-box">
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/" title="文档"
                  
                  
                  
                    active-action="action-home"
                  >
                  <i class='fa-sharp fa-solid fa-book fa-fw'></i>文档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/categories/" title="分类"
                  
                  
                  
                    active-action="action-categories"
                  >
                  <i class='fa-solid fa-folder-open fa-fw'></i>分类
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/tags/" title="标签"
                  
                  
                  
                    active-action="action-tags"
                  >
                  <i class='fa-solid fa-tags fa-fw'></i>标签
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/archives/" title="归档"
                  
                  
                  
                    active-action="action-archives"
                  >
                  <i class='fa-solid fa-archive fa-fw'></i>归档
                </a>
                
              </li>
            
          
            
              
            
              <li>
                <a class="menuitem flat-box faa-parent animated-hover"
                href="/friends/" title="友链"
                  
                  
                  
                    active-action="action-friends"
                  >
                  <i class='fa-solid fa-link fa-fw'></i>友链
                </a>
                
              </li>
            
          
            
          </ul>
        </li>
			</ul>

      <!-- Custom Files header begin -->
      
      <!-- Custom Files header end -->
		</div>
	</div>
  </div>
</header>

    <div id="l_body">
      <div id="l_cover">
  
    
      <!-- see: /layout/_partial/scripts/_ctrl/coverCtrl.ejs -->
      <div id="none" class='cover-wrapper post dock' style="display: none;">
        
  <div class='cover-bg lazyload placeholder' data-bg="https://gcore.jsdelivr.net/gh/MHG-LAB/cron@gh-pages/bing/bing.jpg"></div>

<div class='cover-body'>
  <div class='top'>
    
    
      <p class="title">Volantis</p>
    
    
  </div>
  <div class='bottom'>
    <div class='menu navigation'>
      <div class='list-h'>
        
          
            <a href="/v4/getting-started/"
              
              
              active-action="action-v4getting-started">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f5c3.svg'><p>文档</p>
            </a>
          
            <a href="/faqs/"
              
              
              active-action="action-faqs">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f516.svg'><p>帮助</p>
            </a>
          
            <a href="/examples/"
              
              
              active-action="action-examples">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f396.svg'><p>示例</p>
            </a>
          
            <a href="/contributors/"
              
              
              active-action="action-contributors">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f389.svg'><p>社区</p>
            </a>
          
            <a href="/archives/"
              
              
              active-action="action-archives">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f4f0.svg'><p>博客</p>
            </a>
          
            <a target="_blank" rel="noopener" href="https://github.com/volantis-x/hexo-theme-volantis/"
              
              
              active-action="action-https:githubcomvolantis-xhexo-theme-volantis">
              <img src='https://unpkg.com/volantis-static@0.0.1654736714924/media/twemoji/assets/svg/1f9ec.svg'><p>源码</p>
            </a>
          
        
      </div>
    </div>
  </div>
</div>

        <div id="scroll-down" style="display: none;"><i class="fa fa-chevron-down scroll-down-effects"></i></div>
      </div>
    
  
</div>

      <div id="safearea">
        <div class="body-wrapper">
          
<div id="l_main" class=''>
  <article itemscope itemtype="http://schema.org/Article" class="article post white-box reveal md shadow floatable blur article-type-post" id="post" itemscope itemprop="blogPost">
  <link itemprop="mainEntityOfPage" href="https://tianyigu.top/2018/HAProxy-Starter-Guide翻译/">
  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Tianyi的技术随笔">
  </span>
  <span hidden itemprop="post" itemscope itemtype="http://schema.org/Post">
    <meta itemprop="name" content="Tianyi的技术随笔">
    <meta itemprop="description" content="Tianyi的技术随笔">
  </span>
  


  
    <span hidden>
      <meta itemprop="image" content="https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png">
    </span>
  
  <div class="article-meta" id="top">
    
    
    
      <h1 class="title" itemprop="name headline">
        HAProxy Starter Guide翻译
      </h1>
      <div class='new-meta-box'>
        
          
            
  <div class='new-meta-item category'>
    <i class="fa-solid fa-folder-open fa-fw" aria-hidden="true"></i>
    <a class="category-link" href="/categories/Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E8%B4%9F%E8%BD%BD/">Web服务器与负载</a>
    
      <span hidden itemprop="about" itemscope itemtype="http://schema.org/Thing">
        <a href="/categories/Web%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E8%B4%9F%E8%BD%BD/" itemprop="url"><span itemprop="name">Web服务器与负载</span></a>
      </span>
    
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateCreated datePublished" datetime="2018-12-02T23:45:17+08:00">
  <a class='notlink'>
    <i class="fa-solid fa-calendar-alt fa-fw" aria-hidden="true"></i>
    <p>发布于：2018年12月2日</p>
  </a>
</div>

          
        
        <!-- Custom Files topMeta begin-->
        
        <!-- Custom Files topMeta end-->
      </div>
    
  </div>


  <div id="layoutHelper-page-plugins"></div>
  <div id="post-body" itemprop="articleBody">
    <blockquote>
<p>译者：<a target="_blank" rel="noopener" href="https://github.com/serchaofan">serchaofan</a></p>
<p>翻译主要借助翻译工具，并进行校对。</p>
<p>根据<a target="_blank" rel="noopener" href="https://cbonte.github.io/haproxy-dconv/1.8/intro.html">官方 18.14 与 18.15 文档 Starter Guide</a>的翻译，并非完整翻译，且有的地方会有修改与删除。</p>
</blockquote>
<span id="more"></span>

<ul>
<li><a href="#%E5%BF%AB%E9%80%9F%E4%BB%8B%E7%BB%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8">快速介绍负载均衡和负载均衡器</a></li>
<li><a href="#haproxy-%E4%BB%8B%E7%BB%8D">HAProxy 介绍</a><ul>
<li><a href="#haproxy-%E6%98%AF%E4%BB%80%E4%B9%88%E4%B8%8E%E4%B8%8D%E6%98%AF%E4%BB%80%E4%B9%88">HAProxy 是什么与不是什么</a></li>
<li><a href="#haproxy-%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C">HAProxy 如何工作</a></li>
<li><a href="#%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD">基础功能</a><ul>
<li><a href="#%E4%BB%A3%E7%90%86">代理</a></li>
<li><a href="#ssl">SSL</a></li>
<li><a href="#%E7%9B%91%E6%8E%A7">监控</a></li>
<li><a href="#%E9%AB%98%E5%8F%AF%E7%94%A8">高可用</a></li>
<li><a href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1">负载均衡</a></li>
<li><a href="#%E7%B2%98%E6%80%A7">粘性</a></li>
<li><a href="#%E9%87%87%E6%A0%B7%E4%B8%8E%E8%BD%AC%E6%8D%A2%E4%BF%A1%E6%81%AF">采样与转换信息</a></li>
<li><a href="#acls-%E5%92%8C%E6%9D%A1%E4%BB%B6">ACLS 和条件</a></li>
<li><a href="#%E5%86%85%E5%AE%B9%E8%BD%AC%E6%8D%A2">内容转换</a></li>
<li><a href="#%E7%BB%91%E5%AE%9A%E8%A1%A8">绑定表</a></li>
<li><a href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2">格式化字符串</a></li>
<li><a href="#http-%E9%87%8D%E5%86%99%E4%B8%8E%E9%87%8D%E5%AE%9A%E5%90%91">HTTP 重写与重定向</a></li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BF%9D%E6%8A%A4">服务器保护</a></li>
<li><a href="#%E6%97%A5%E5%BF%97">日志</a></li>
<li><a href="#%E7%BB%9F%E8%AE%A1">统计</a></li>
</ul>
</li>
<li><a href="#%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD">高级功能</a><ul>
<li><a href="#%E7%AE%A1%E7%90%86">管理</a></li>
<li><a href="#%E7%B3%BB%E7%BB%9F%E7%89%B9%E5%AE%9A%E5%8A%9F%E8%83%BD">系统特定功能</a></li>
<li><a href="#%E8%84%9A%E6%9C%AC">脚本</a></li>
</ul>
</li>
<li><a href="#%E8%B0%83%E4%BC%98">调优</a></li>
</ul>
</li>
<li><a href="#%E9%85%8D%E5%A5%97%E4%BA%A7%E5%93%81%E5%8F%8A%E6%9B%BF%E4%BB%A3%E4%BA%A7%E5%93%81">配套产品及替代产品</a><ul>
<li><a href="#apache">Apache</a></li>
<li><a href="#nginx">Nginx</a></li>
<li><a href="#varnish">Varnish</a></li>
<li><a href="#%E6%9B%BF%E4%BB%A3%E4%BA%A7%E5%93%81">替代产品</a></li>
</ul>
</li>
</ul>
<h1 id="快速介绍负载均衡和负载均衡器"><a href="#快速介绍负载均衡和负载均衡器" class="headerlink" title="快速介绍负载均衡和负载均衡器"></a>快速介绍负载均衡和负载均衡器</h1><p>负载均衡包括聚合多个组件，以便在每个组件的单独流量上实现总处理能力，而无需客户端用户的任何干预并且是可扩展的。这导致组件在仅执行一个操作所花费的时间内同时执行更多操作。 但是，单个操作仍然会一次在单个组件上执行，并且不会比没有负载均衡时更快。 它始终需要至少与可用组件一样多的操作和有效的负载均衡机制来充分利用所有组件并从负载均衡中充分受益。一个很好的例子是高速公路上的车道数量，不增加车辆速度而允许尽可能多的车辆在同一时间段内通过。</p>
<p>负载均衡的示例：</p>
<ul>
<li>多处理器系统中的进程调度</li>
<li>链路负载均衡（例如 EtherChannel，Bonding）</li>
<li>IP 地址负载均衡（例如 ECMP，DNS round-robin）</li>
<li>服务器负载均衡（通过负载均衡器）</li>
</ul>
<p>执行负载均衡操作的机制或组件称为负载均衡器。 在 Web 环境中，这些组件称为“网络负载均衡器”，更常见的是“负载均衡器”，因为此说法是迄今为止负载均衡的最好示例。</p>
<p>负载均衡器可以起作用：</p>
<ul>
<li>在链路级别：这称为链路负载均衡，它包括选择发送数据包的网络链路</li>
<li>在网络级别：这称为网络负载均衡，它包括选择一系列数据包将使用的路由</li>
<li>在服务器级别：这称为服务器负载均衡，它包括决定哪个服务器将处理连接或请求</li>
</ul>
<p>存在两种不同的技术并满足不同的需求，但有一些重叠。在每种情况下，重要的是要记住，负载均衡包括将流量从其自然流转移，并且这样做总是需要最少的维护，以维持所有路由决策之间所需的一致性水平。</p>
<p>第一个技术作用于数据包级别并且或多或少地单独处理数据包。 输入和输出数据包之间存在一对一的关系，因此可以使用常规网络嗅探器跟踪负载均衡器两侧的流量。这项技术非常便宜且速度极快。 它通常以硬件（ASIC）实现，能够达到线速（line rate），例如执行 ECMP 的交换机。 通常是无状态的，它也可以是有状态的（考虑一个数据包所属的会话并称为 layer4-LB 或 L4），如果数据包没有被修改，可以支持 DSR（直接服务器返回，不再通过 LB），但几乎不提供内容感知（content awareness）。 该技术非常适合网络级负载均衡，但有时用于高速的基本服务器负载均衡。</p>
<p>第二个技术作用于会话内容。 它要求输入流作为一个整体进行重组和处理。 可以修改内容，并且将输出流分段为新分组。出于这个原因，它通常由代理执行，它们通常被称为第 7 层负载均衡器或 L7。这意味着每一侧有两个不同的连接，并且输入和输出数据包大小与计数之间没有关系。客户端和服务器不需要使用相同的协议（例如 IPv4 与 IPv6，不加密与 SSL）。 操作始终是有状态的，返回流量必须通过负载均衡器。 额外的处理带来了成本，因此并不总是能够实现线速，特别是对于小数据包。 另一方面，它提供了广泛的可能性，并且通常通过纯软件实现，即使嵌入到硬件设备中也是如此。 该技术非常适合服务器负载均衡。</p>
<p>基于数据包的负载均衡器通常以直通模式（cut-though mode）部署，因此它们安装在流量的正常路径上，并根据配置进行转移。 返回的流量不一定通过负载均衡器。 可以对网络目的地址进行一些修改，以便将流量引导到适当的目的地。 在这种情况下，返回流量必须通过负载均衡器。如果路由不能实现这一点，则负载均衡器也可以用自己的路由替换数据包的源地址，强制返回流量通过它。</p>
<p>基于代理的负载均衡器部署为具有自己的 IP 地址和端口的服务器，无需更改体系结构。<br>有时，这需要对应用程序执行一些调整，以便客户端正确定向到负载均衡器的 IP 地址，而不是直接定向到服务器。某些负载均衡器可能必须调整某些服务器的响应才能实现这一点（例如 HTTP 重定向中使用的 HTTP Location 头字段）。某些基于代理的负载均衡器可能会拦截其不拥有的地址的流量，并在连接到服务器时欺骗客户端的地址。这使得它们可以像通常的路由器或防火墙一样进行部署，采用与基于数据包的负载均衡器非常相似的直通模式。对于结合了分组模式和代理模式的产品，这是特别受欢迎的。 在这种情况下，DSR 显然仍然不可能，并且返回流量仍然必须路由回负载均衡器。</p>
<p>一种非常可扩展的分层方法将包括具有从多个负载均衡链路接收流量的前端路由器，并使用 ECMP 将该流量分配到多个有状态分组的负载均衡器（L4）的第一层。这些 L4 负载均衡器又将流量传递给更大数量的基于代理的负载均衡器（L7），这些负载均衡器必须解析内容以确定哪个服务器最终将接收流量。</p>
<p>流量的组件数量和可能的路径增加了失败的风险; 在非常大的环境中，永久性地将一些故障部件修复或替换是正常的。 在不了解整个堆栈的运行状况的情况下完成负载均衡会显着降低可用性。 出于这个原因，任何严谨的负载均衡器都将验证它打算提供流量的组件是否仍然存活且可访问，并且它将停止向故障流量提供流量。 这可以使用各种方法实现。</p>
<p>最常见的一种是定期发送探测包以确保组件仍可运行。 这些探测包称为“健康检查”。 它们必须代表要解决的失败类型。 例如，基于 ping 的检查不会检测到 Web 服务器已经崩溃并且不再监听端口，而与端口的连接将验证这一点，而更高级的请求甚至可以验证服务器是否仍然有效并且它依赖的数据库仍然可以访问。 健康检查通常需要进行一些重试以防止偶尔的监测错误。检查之间的时间间隔必须足够小，以确保在发生错误后故障组件的使用时间不会太长。</p>
<p>其他方法包括对发送到目的地的生产流量进行抽样，以观察是否正确处理，并去除返回不适当响应的组件。 然而，这需要牺牲一部分生产流量，这并不总是可以接受的。 这两种机制的组合提供了两全其美的优势，两者都用于检测故障，只有健康检查才能检测到故障的结束。 最后一种方法涉及集中报告：中央监控代理定期更新所有负载均衡器的所有组件的状态。 这为所有组件提供了基础架构的全局视图，但有时精度或响应性较低。 它最适合具有许多负载均衡器和许多服务器的环境。</p>
<p>第 7 层负载均衡器还面临另一个被称为粘性或持久性的挑战。 原则是它们通常必须将来自同一来源（例如最终用户）的多个后续请求或连接指向同一目标。 最着名的例子是在线商店的购物车。 如果每次点击都会导致新连接，则必须始终将用户发送到保存其购物车的服务器。 内容感知使得更容易发现请求中的某些元素以识别要将其传递到的服务器，但这并不总是足够的。 例如，如果把源地址用作选择服务器的指标，则可以确定将使用基于散列的算法，并且将始终按可用服务器的数量基于地址划分将给定的 IP 地址发送到同一服务器 。 但是如果一台服务器出现故障，结果会发生变化，所有用户都会突然被发送到另一台服务器并丢失购物车。 针对此问题的解决方案在于记录所选目标，以便每次看到相同的访问者时，无论可用服务器的数量如何，都会将其定向到同一服务器。 信息可以存储在负载均衡器的内存中，在这种情况下，如果不是单独的话，可能必须将其复制到其他负载均衡器，或者可以使用各种方法存储在客户端的内存中，前提是客户端能够随每个请求呈现该信息（cookie 插入，重定向到子域等）。 这种机制提供了额外的好处，即不必依赖不稳定或分布不均匀的信息（例如源 IP 地址）。 事实上，这是采用第 7 层负载均衡器而不是第 4 层负载均衡器的最有力理由。</p>
<p>为了提取诸如 cookie，主机头字段，URL 或其他信息之类的信息，负载均衡器可能需要解密 SSL&#x2F;TLS 流量，甚至可能在将其传递给服务器时对其进行重新加密。 这个复杂的任务解释了为什么在一些高流量的基础设施中，有时可能会有很多负载均衡器。<br>由于第 7 层负载均衡器可以对流量执行许多复杂的操作（解密，解析，修改，匹配 cookie，决定要发送到哪个服务器等），它肯定会造成一些麻烦，并且通常会为显露出很多麻烦而被指责。 通常会发现服务器不稳定并且周期性地停止重启，或者对于 Web 服务器，它们会传递带有一些硬编码链接的页面，迫使客户端直接连接到一个特定的服务器而不通过负载均衡器，或者他们需要很长时间才能在高负荷下做出反应，导致超时，这就是为什么日志记录是第 7 层负载均衡的一个极其重要的方面。一旦报告故障，重要的是要确定负载均衡器是否做出了错误的决定，如果是这样，如何才能不再发生这种情况。</p>
<h1 id="HAProxy-介绍"><a href="#HAProxy-介绍" class="headerlink" title="HAProxy 介绍"></a>HAProxy 介绍</h1><p>HAProxy 写作“HAProxy”来指定产品，而“haproxy”被指定为可执行程序，软件包或进程。 然而，两者通常用于两种目的，并且发音为 H-A-Proxy。，很早以前，“haproxy”曾经代表“高可用性代理”，这个名字用两个单独的单词写成，但现在它只不过是“HAProxy”。</p>
<h2 id="HAProxy-是什么与不是什么"><a href="#HAProxy-是什么与不是什么" class="headerlink" title="HAProxy 是什么与不是什么"></a>HAProxy 是什么与不是什么</h2><p>HAProxy 是：</p>
<ul>
<li>TCP 代理：它可以接受来自侦听套接字的 TCP 连接，连接到服务器并将这些套接字连接在一起，允许流量在两个方向上流动</li>
<li>HTTP 反向代理（在 HTTP 术语中称为“网关”）：它将自身表示为服务器，通过侦听 TCP 套接字上接受的连接接收 HTTP 请求，并使用不同的连接将请求从这些连接传递到服务器。</li>
<li>SSL 终端&#x2F;发起者&#x2F;卸载程序（offloader）：SSL &#x2F; TLS 可用于来自客户端，到服务器的连接，甚至两个连接的连接。</li>
<li>TCP 规范化程序（normalizer）：由于操作系统本地终止了连接，双方之间没有关系，因此无效数据包、标志组合、窗口通告（window advertisement）、序列号、不完整连接（SYN 泛洪）等异常流量不会被传递到另一边。 这可以保护脆弱的 TCP 栈免受协议攻击，并且还允许与客户端优化连接参数，而无需修改服务器的 TCP 栈设置。</li>
<li>HTTP 规范化程序：配置为处理 HTTP 流量时，仅传递有效的完整请求。 这可以防止许多基于协议的攻击。 另外，规范中存在容差的协议偏差是固定的，因此它们不会在服务器上引起问题（例如，多行头）。</li>
<li>HTTP 修复工具：它可以修改&#x2F;修复&#x2F;添加&#x2F;删除&#x2F;重写 URL 或任何请求或响应头。 这有助于解决复杂环境中的互操作性（interoperability）问题。</li>
<li>基于内容的交换机：它可以根据请求中的任何元素来决定将请求或连接传递给哪个服务器。 因此，可以在同一端口上处理多个协议（例如，HTTP，HTTPS，SSH）。</li>
<li>服务器负载均衡器：它可以对 TCP 连接和 HTTP 请求进行负载均衡。 在 TCP 模式下，对整个连接采取负载均衡决策。 在 HTTP 模式下，根据请求做出决定。</li>
<li>流量调节器：它可以在不同点应用一些速率限制，保护服务器免受过载，根据内容调整流量优先级，甚至通过标记数据包将这些信息传递给较低层和外部网络组件。</li>
<li>防止 DDoS 和服务滥用（service abuse）：它可以维护每个 IP 地址，URL，cookie 等的大量统计信息，并检测何时发生滥用，然后采取措施（减慢违规行为，阻止它们，将它们发送到过时的内容 等）。</li>
<li>网络故障排除的观察点：由于日志中报告的信息的精确性，它通常用于缩小网络相关问题的范围。</li>
<li>HTTP 压缩卸载程序：它可以压缩未被服务器压缩的响应，从而减少连接不良或使用高延迟移动网络的客户端的页面加载时间。</li>
</ul>
<p>HAProxy 不是：</p>
<ul>
<li>显式 HTTP 代理，即浏览器用于访问互联网的代理。 有专门用于此任务的优秀开源软件，例如 Squid。 但是，HAProxy 可以部署在这样的代理之前，以提供负载均衡和高可用性。</li>
<li>缓存代理：它将按原样返回从服务器收到的内容，不会干扰任何缓存策略。 有很好的开源软件可以完成这项任务，比如 Varnish。 HAProxy 可以部署在这样的缓存之前，通过智能负载均衡提供 SSL 卸载和可扩展性。</li>
<li>数据清理程序：它不会修改请求体和响应体。</li>
<li>Web 服务器：在启动期间，它将自己隔离在 chroot jail 中并删除其权限，以便一旦启动它就不会执行任何单个文件系统访问。 因此，它无法转变为 Web 服务器。 有很好的开源软件，如 Apache 或 Nginx，HAProxy 可以部署在它们前端，以提供负载均衡和高可用性。</li>
<li>基于数据包的负载均衡器：它不会看到 IP 数据包也不会看到 UDP 数据包，也不会执行 NAT 甚至更少的 DSR（动态源路由协议）。 这些是较低层的任务。 一些基于内核的组件（如 IPVS（Linux 虚拟服务器））已经很好地完成了这项工作并与 HAProxy 完美匹配。</li>
</ul>
<h2 id="HAProxy-如何工作"><a href="#HAProxy-如何工作" class="headerlink" title="HAProxy 如何工作"></a>HAProxy 如何工作</h2><p>HAProxy 是一个单线程，事件驱动的非阻塞引擎，它将非常快的 I &#x2F; O 层与基于优先级的调度程序相结合。 由于它的设计考虑了数据转发目标，因此其架构经过优化，可以尽可能快地以尽可能少的操作移动数据。 因此，它实现了一个分层模型，在每个级别提供旁路机制（bypass mechanisms），确保数据不会达到更高级别，除非需要。 大多数处理都是在内核中执行的，HAProxy 尽最大努力通过提供一些提示或者在猜测它们可以在以后分组时避免某些操作来尽可能快地帮助内核完成工作。 因此，典型数据显示，在 TCP 或 HTTP 关闭模式下，HAProxy 中花费的处理时间占 15％，而在内核占 85％，在 HTTP keep-alive 模式下，HAProxy 约占 30％，而内核占 70％。</p>
<p>单个进程可以运行许多代理实例。根据试验，单个进程中大到 300000 个不同代理的配置运行正常。 因此，通常不需要为所有实例启动多个进程。</p>
<p>可以使 HAProxy 在多个进程上运行，但它有一些限制。 一般来说，它在 HTTP 关闭或 TCP 模式下没有意义，因为内核端不能很好地扩展一些操作，如<code>connect()</code>。 它可以很好地扩展到 HTTP 的 keep-alive 模式，但是可以通过单个进程实现的性能通常比常见的需求高出一个数量级。 但是，当用作 SSL 卸载器（offloader）时，它确实有意义，并且在多进程模式中很好地支持此功能。</p>
<p>HAProxy 只需要运行 haproxy 可执行文件和配置文件。 对于日志记录，强烈建议使用正确配置的 syslog 守护程序并记录日志轮换。 在启动之前解析配置文件，然后 HAProxy 尝试绑定所有侦听套接字，并在任何失败时拒绝启动。做到这一点，它就不会运行失败了。 这意味着没有运行时故障，如果它接受启动，它将一直有效，直到它停止。</p>
<p>一旦 HAProxy 被启动，它会做三件事：</p>
<ul>
<li>处理传入的连接</li>
<li>定期检查服务器状态(称为健康检查)</li>
<li>与其他 haproxy 节点交换信息</li>
</ul>
<p>处理传入连接是迄今为止最复杂的任务，因为它依赖于许多配置可能性，但它可以概括为以下 9 个步骤：</p>
<ol>
<li>接受来自属于称为<code>frontend</code>的配置实体的侦听套接字的传入连接 ，引用一个或多个侦听地址</li>
<li>将特定于 frontend 的处理规则应用于这些可能导致阻塞它们，修改某些头或拦截它们以执行某些内部小程序（例如统计页面或 CLI）的连接</li>
<li>将这些传入连接传递给另一个表示称为<code>backend</code>的服务器池的配置实体，该服务器场包含服务器列表和此服务器池的负载均衡策略</li>
<li>将特定于后端的处理规则应用于这些连接</li>
<li>根据负载均衡策略决定将连接转发到哪个服务器</li>
<li>将特定于后端的处理规则应用于响应数据</li>
<li>将特定于前端的处理规则应用于响应数据</li>
<li>发出日志详细报告发生的事情</li>
<li>在 HTTP 中，循环回第二步以等待新请求，否则关闭连接</li>
</ol>
<p>前端和后端有时被认为是半代理，因为它们只看端到端连接的一侧。前端只关心客户端，而后端只关心服务器。 HAProxy 还支持完全代理，它们正是前端和后端的联合。 当需要 HTTP 处理时，配置通常会分为前端和后端，因为它们会打开很多可能性，因为任何前端都可以将连接传递给任何后端。 对于仅使用 TCP 的代理，使用前端和后端很少提供好处，并且使用完整代理可以使配置更具可读性。</p>
<h2 id="基础功能"><a href="#基础功能" class="headerlink" title="基础功能"></a>基础功能</h2><p>本节将列举 HAProxy 实现的许多功能，其中一些功能通常可以从任何现代负载均衡器中获得，其中一些功能是 HAProxy 架构的直接优势。 更多高级功能将在下一节中详细介绍。</p>
<h3 id="代理"><a href="#代理" class="headerlink" title="代理"></a>代理</h3><p>代理是通过两个独立连接在客户端和服务器之间传输数据的操作。通过代理和连接管理，HAProxy 具有以下基本特性：</p>
<ul>
<li>为服务器提供干净的连接，以防止客户端出现任何客户端缺陷或攻击</li>
<li>监听多个 IP 地址或端口，甚至端口范围</li>
<li>透明：截取任何甚至不属于本地系统的任意 IP 地址的流量</li>
<li>服务器端口不需要与监听端口相关，甚至可以通过固定偏移量（对范围有用）进行转换</li>
</ul>
<ul>
<li>透明连接：连接服务器时，如果需要会欺骗客户端（或任何其他主机）的 IP 地址</li>
<li>为多站点 LB 中的服务器提供可靠的返回 IP 地址</li>
<li>借助缓冲区和可能短暂的连接来卸载服务器，以减少它们的并发连接数和内存占用量</li>
<li>优化 TCP 栈（例如 SACK），拥塞控制和减少 RTT 影响</li>
<li>支持双方不同的协议系列（例如 IPv4 &#x2F; IPv6 &#x2F; Unix）</li>
<li>超时强制执行：HAProxy 支持多级别的超时，具体取决于连接的阶段，因此断开的客户端或服务器或攻击者不能长时间获得资源</li>
<li>协议验证：检查 HTTP，SSL 或有效负载，拒绝无效的协议元素，除非指示无论如何接受它们</li>
<li>策略执行：确保只转发允许的内容</li>
<li>传入和传出连接都可能仅限于某些网络命名空间（仅限 Linux），因此可以轻松构建跨容器，多用户负载均衡器</li>
<li>PROXY 协议将客户端的 IP 地址呈现给服务器，即使对于非 HTTP 流量也是如此。这是一个 HAProxy 扩展，现在被许多第三方产品采用，在撰写本文时至少有以下产品：<ul>
<li>客户端：haproxy，stud，stunnel，exaproxy，ELB，squid</li>
<li>服务器：haproxy，stud，postfix，exim，nginx，squid，node.js，varnish</li>
</ul>
</li>
</ul>
<h3 id="SSL"><a href="#SSL" class="headerlink" title="SSL"></a>SSL</h3><p>Google 的工程师（<a target="_blank" rel="noopener" href="http://istlsfastyet.com/%EF%BC%89%E8%AE%A4%E4%B8%BAHAProxy%E7%9A%84SSL%E6%A0%88%E6%98%AF%E6%9C%80%E5%85%B7%E7%89%B9%E8%89%B2%E7%9A%84%E5%8A%9F%E8%83%BD%E4%B9%8B%E4%B8%80%E3%80%82">http://istlsfastyet.com/）认为HAProxy的SSL栈是最具特色的功能之一。</a> 使其相当完整的最常用特性是：</p>
<ul>
<li>基于 SNI 的多主机，不限制站点数量并专注于性能。 至少有一个部署用于运行 50000 个域及其各自的证书</li>
<li>对通配符证书（wildcard certificates）的支持减少了对许多证书的需求</li>
<li>基于证书的客户端身份验证，如果无法提供有效证书，则使用可配置策略。例如，这允许不同的服务器池重新生成客户端证书</li>
<li>后端服务器的身份验证确保后端服务器是真正的后端服务器而不是中间人</li>
<li>使用后端服务器进行身份验证让后端服务器知道它实际上是连接到它的预期 haproxy 节点</li>
<li>TLS NPN 和 ALPN 扩展使得可以可靠地卸载 SPDY&#x2F;HTTP2 连接并以明文形式将它们传递给后端服务器</li>
<li>当客户端请求证书状态请求时，通过提供内联 OCSP 响应，OCSP 装订（stapling）进一步减少了首页加载时间</li>
<li>动态记录大小调整可提供高性能和低延迟，并且当数据包仍处于运行状态时，允许浏览器开始获取新对象，从而显着缩短页面加载时间</li>
<li>永久访问所有相关的 SSL&#x2F;TLS 层信息，用于日志记录、访问控制、报告等。这些元素可以嵌入到 HTTP 报头中，甚至可以作为代理协议扩展，这样卸载的服务器就可以获得如果它自己执行 SSL 终止时会有的所有信息</li>
<li>在易受攻击的 SSL 库上检测、记录和阻止某些已知攻击，例如影响 OpenSSL 某些版本的 Heartbleed 攻击</li>
</ul>
<ul>
<li>支持无状态会话恢复（RFC 5077 TLS 故障单扩展）。可以从 CLI 更新 TLS 票证，通过频繁翻转（rotate）票证为他们提供实现 Perfect Forward Secrecy 的方法。</li>
</ul>
<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p>HAProxy 非常关注可用性。 因此，它关心服务器状态，并将其自身状态报告给其他网络组件：</p>
<ul>
<li>使用每台服务器的参数持续监控服务器的状态。 这确保了服务器的路径可用于常规流量</li>
<li>健康检查支持两个滞后（hysteresis）的上下转换，以防止状态振荡</li>
<li>可以将检查发送到不同的地址&#x2F;端口&#x2F;协议：这样可以轻松检查被视为代表多个服务的单个服务，例如 HTTP + HTTPS 服务器的 HTTPS 端口。</li>
<li>服务器可以跟踪其他服务器并同时关闭：这可确保托管多个服务的服务器可以原子方式失败，并且不会将任何人发送到部分故障的服务器</li>
<li>可以在服务器上部署代理以监视负载和运行状况：服务器可能有兴趣报告其负载，运行状态，管理状态，而不管运行状况检查可以看到什么。<br>通过在服务器上运行一个简单的代理，除了验证整个路径的运行状况检查外，还可以考虑服务器对自身运行状况的看法</li>
<li>提供各种检查方法：TCP 连接，HTTP 请求，SMTP hello，SSL hello，LDAP，SQL，Redis，send &#x2F;<br>expect 脚本，所有有&#x2F;无 SSL</li>
<li>状态更改在日志和统计信息页面中以失败原因通知（例如，在检测到故障时收到的 HTTP 响应）。<br>在发生此类更改时，也可以将电子邮件发送到可配置的地址</li>
<li>服务器状态也在统计接口上报告，并且可用于做出路由决定，以便可以根据流量大小和&#x2F;或健康状况（例如，丢失 DC 间链路）将流量发送到不同的服务器场。</li>
<li>HAProxy 可以使用运行状况检查请求将信息传递给服务器，例如其名称，重量，服务器场中其他服务器的数量等，以便服务器可以根据这些知识调整其响应和决策（例如，推迟备份以保持<br>更多 CPU 可用）</li>
<li>服务器可以使用健康检查报告更详细的状态，而不仅仅是打开&#x2F;关闭（例如，我想停止，请停止发送新访问者）</li>
<li>HAProxy 本身可以将其状态报告给外部组件，例如路由器或其他负载均衡器，从而可以构建非常完整的多路径和多层基础架构。</li>
</ul>
<h3 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a>高可用</h3><p>就像任何负载均衡器一样，HAProxy 非常重视可用性，以确保最佳的全局服务持续性：</p>
<ul>
<li>仅使用有效的服务器，其他的被自动从负载均衡服务器群中剔除，在某些条件下，仍有可能强制使用它们</li>
<li>支持优雅关闭，以便可以在不影响任何连接的情况下将服务器从服务器群中剔除</li>
<li>当活跃服务器关闭时自动使用备份服务器并替换它们，以便在可能的情况下不会丢失会话。 这还允许构建多个路径以到达相同的服务器（例如，多个接口）</li>
<li>当服务器过多时，能够返回服务器群的全局故障状态。 这与监视功能相结合，使上游组件可以为给定的服务选择不同的 LB 节点</li>
<li>无状态设计使构建集群变得容易：通过设计，HAProxy 尽最大努力确保最高的服务持续性，而无需存储在发生故障时可能丢失的信息。 这确保了接管是最无缝的。</li>
<li>与标准 VRRP 守护程序保持良好集成：HAProxy 告知 keepalived 其状态，并与浮动虚拟 IP 地址很好地对应。 注意：仅使用基于集群的解决方案（Heartbeat，…）的 IP 冗余协议（VRRP&#x2F;CARP），因为它们是提供最快，最无缝和最可靠切换的解决方案。</li>
</ul>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p>HAProxy 提供了一套相当完整的负载均衡功能，其中大多数功能在许多其他负载均衡产品中是不支持的：</p>
<ul>
<li><p>支持不少于 9 种负载均衡算法，其中一些适用于输入数据，以提供无限的可能性列表。 最常见的是 round-robin（用于短连接，依次选择每个服务器），leastconn（用于长连接，选择最近最少使用的具有最低连接数的服务器），source（用于 SSL 服务器群或终端服务器群，服务器直接依赖于客户端的源地址），uri（对于 HTTP 缓存，服务器直接依赖于 HTTP URI），hdr（服务器直接依赖于特定 HTTP 头字段的内容），first（对于短期虚拟机，所有连接都打包在最小的服务器子集上，以便可以关闭未使用的服务器）</p>
</li>
<li><p>以上所有算法都支持服务器权重，以便可以适应服务器群中不同的级别的服务器，或者将一小部分流量引导到特定服务器（调试模式，运行下一版本的软件等）</p>
</li>
<li><p>支持动态权重的轮询、最小控制和一致哈希，这允许从 CLI 动态修改服务器权重，甚至允许服务器上运行的代理修改服务器权重</p>
</li>
<li><p>只要支持动态权重，就支持慢启动，这允许服务器逐步获取流量。 这是脆弱的应用程序服务器的一个重要特性，它需要在运行时编译类以及需要在全速运行之前填满的冷缓存（cold caches）</p>
</li>
<li><p>散列可以应用于各种元素，如客户端的源地址，URL 组件，查询字符串元素，报文头字段值，POST 参数，RDP cookie</p>
</li>
<li><p>在服务器群中添加或删除服务器时，一致性哈希（consitent hashing）可保护服务器群免受大量重新分发的影响。 这在大型缓存群中非常重要，它允许使用慢启动来重新填充冷缓存</p>
</li>
<li><p>许多内部指标，例如每个服务器、每个后端的连接数，后端中可用连接插槽的数量等，可以构建非常先进的负载均衡策略。</p>
</li>
</ul>
<h3 id="粘性"><a href="#粘性" class="headerlink" title="粘性"></a>粘性</h3><p>如果没有粘性（stickness），应用程序负载均衡将毫无用处。 HAProxy 提供了一套相当全面的可能性，可以将访问者维持在同一台服务器上，甚至可以跨越各种事件，例如服务器添加&#x2F;删除，下线&#x2F;上线周期，并且某些方法可以克服多个负载均衡节点之间的距离并不需要任何复制：</p>
<ul>
<li><p>如果需要，粘性信息可以单独匹配并从不同的地方学习。 例如，JSESSIONID cookie 可以在 cookie 和 URL 中匹配。 可以同时学习多达 8 个并行源，每个源可以指向不同的绑定表（stick-table）</p>
</li>
<li><p>粘性信息可以来自请求或响应中可以看到的任何内容，包括源地址，TCP 有效负载偏移和长度，HTTP 查询字符串元素，报头字段值，cookie 等</p>
</li>
<li><p>以多主方式在所有节点之间复制绑定表</p>
</li>
<li><p>常用的元素，如 SSL-ID 或 RDP cookie（用于 TSE 群）可直接访问，以方便操作</p>
</li>
<li><p>所有粘性规则都可以由 ACL 动态调节</p>
</li>
<li><p>可以决定不绑定某些服务器，例如备份服务器。这样当名义上的（nominal）服务器返回集群时，它会自动恢复负载。 这通常用于多路径环境</p>
</li>
<li><p>在 HTTP 中，通常不会学习任何东西，而是操纵专用于粘性的 cookie。 为此，可以检测，重写，插入或添加这样的 cookie，让客户端记住分配了哪个服务器</p>
</li>
<li><p>服务器可以决定在注销时更改或清除粘性 cookie，以便离开的访问者自动从服务器解除绑定</p>
</li>
<li><p>使用基于 ACL 的规则，无论服务器的状态如何，都可以选择性地忽略或强制粘性，结合高级健康检查，帮助管理员验证他们正在安装的服务器是否正常运行，再对外服务</p>
</li>
<li><p>在 cookie 上设置最大空闲时间（maximum idle time）和持续时间（duration）的机制可确保在永不关闭的设备（智能手机，电视，家用电器）上顺利停止粘性，而无需将其存储在持久存储上</p>
</li>
<li><p>多个服务器条目可以共享相同的粘性键，以便在一个路径发生故障时多路径环境中不会丢失粘性</p>
</li>
<li><p>软停止（soft-stop）确保只有具有粘性信息的用户才能继续访问他们已被分配到的服务器，但新用户不能被分配到那些服务器</p>
</li>
</ul>
<h3 id="采样与转换信息"><a href="#采样与转换信息" class="headerlink" title="采样与转换信息"></a>采样与转换信息</h3><p>HAProxy 支持使用大量“采样函数”进行信息采样。 原则是提取称为样本的信息，以便立即使用。 这用于粘性，构建条件，在日志中生成信息或丰富 HTTP 头。</p>
<p>可以从各种来源获取样本：</p>
<ul>
<li>常量：整数，字符串，IP 地址，二进制块</li>
<li>进程：日期，环境变量，服务器&#x2F;前端&#x2F;后端&#x2F;进程状态，字节&#x2F;连接计数&#x2F;速率，队列长度，随机生成器，…</li>
<li>变量：每个会话，每个请求，每个响应变量</li>
<li>客户端连接：源和目标地址和端口，以及所有相关的统计计数器</li>
<li>SSL 客户端会话：协议，版本，算法，密码，密钥大小，会话 ID，所有客户端和服务器证书字段，证书序列，SNI，ALPN，NPN，某些扩展的客户端支持</li>
<li>请求和响应缓冲区内容：偏移&#x2F;长度的任意有效载荷，数据长度，RDP cookie，SSL hello 类型的解码，TLS SNI 的解码</li>
<li>HTTP（请求和响应）：方法，URI，路径，查询字符串参数，状态代码，报头值，位置报头值，cookie，捕获，身份验证，正文元素</li>
</ul>
<p>然后，样本可以通过许多称为“转换器”的运算符来实现一些转换。 转换器消耗样本并生成新样本，可能是完全不同的类型。 例如，转换器可以用于仅返回输入字符串的整数长度，或者可以将字符串转换为大写。 在最终使用之前，可以将任意数量的转换器串联应用于样品。 在所有可用的样本转换器中，以下是最常用的：</p>
<ul>
<li>算术和逻辑运算符：它们可以对输入数据执行高级计算，例如计算比率，百分比或简单地从一个单元转换为另一个单元</li>
<li>当某些地址需要通过较大的网络进行分组时，IP 地址掩码非常有用</li>
<li>数据表示：URL 解码，base64，十六进制，JSON 字符串，散列</li>
<li>字符串转换：提取固定位置的子串，固定长度，提取某些分隔符周围的特定字段，提取某些单词，更改大小写，应用基于正则表达式的替换</li>
<li>日期转换：转换为 HTTP 日期格式，将本地转换为 UTC，反之，添加或删除偏移量</li>
<li>查找绑定表（stick table）中的条目以查找统计信息或分配的服务器</li>
<li>通过文件（主要用于定位）的基于映射的键值转换</li>
</ul>
<h3 id="映射"><a href="#映射" class="headerlink" title="映射"></a>映射</h3><p>映射是一种强大的转换器类型，包括在引导时将两列文件加载到内存中，然后查找第一列中的每个输入样本，并在找到条目时返回第二列上的相应模式，或者返回默认值。 输出信息也是一个样本，它可以反过来进行其他转换，包括其他映射查找。 映射最常用于将客户端的 IP 地址转换为 AS 号或国家&#x2F;地区代码，因为它们支持网络地址的最长匹配，但它们还可用于各种其他目的。<br>它们的部分优势来自于可以通过 CLI 或使用其他样本的某些操作进行快速更新，使它们能够在后续访问到来前完成存储和检索信息。 另一个优势来自基于二叉树的索引，即使它们包含数十万个条目，它们也非常快，使得位置定位非常方便且易于设置。</p>
<h3 id="ACLS-和条件"><a href="#ACLS-和条件" class="headerlink" title="ACLS 和条件"></a>ACLS 和条件</h3><p>HAProxy 中的大多数操作都可以是有条件的。 通过使用逻辑运算符（AND，OR，NOT）组合多个 ACL 来构建条件。 每个 ACL 都是基于以下元素的一系列测试：</p>
<ul>
<li>用于检索要测试的元素的示例获取方法</li>
<li>一系列可选的转换元件</li>
<li>要匹配的模式列表</li>
<li>一种匹配方法，用于指示如何将模式与样本进行比较</li>
</ul>
<p>例如，可以从 HTTP“主机”头部获取样本，然后可以将其转换为小写，然后使用正则表达式匹配方法与多个正则表达式模式进行匹配。</p>
<p>从技术上讲，ACL 与映射构建在同一个核心上，它们共享完全相同的内部结构，模式匹配方法和性能。 唯一真正的区别是，ACL 只返回“找到”或“未找到”，而不是返回样本。 在使用方面，ACL 模式可以在配置文件中内联声明，并且不需要自己的文件。 可以命名 ACL 以便于使用或使配置易于理解。 命名 ACL 可以多次声明，它将依次评估所有定义，直到匹配为止。</p>
<p>提供了大约 13 种不同的模式匹配方法，其中包括 IP 地址掩码，整数范围，子串，正则表达式。 它们像函数一样工作，就像使用任何编程语言一样，只评估所需的内容，因此当涉及 OR 的条件已经为真时，不会评估下一个条件，并且当涉及 AND 的条件已经为假时，其余的条件则无需评估。</p>
<p>声明的 ACL 的数量没有实际限制，并且提供了少数常用的 ACL。 但是经验表明，使用大量命名 ACL 的设置很难排除故障，并且有时使用内联匿名 ACL 更容易，因为它需要更少的分析范围之外的引用。</p>
<h3 id="内容转换"><a href="#内容转换" class="headerlink" title="内容转换"></a>内容转换</h3><p>HAProxy 实现了一种称为基于内容的转换机制。 原则是连接或请求到达前端，然后处理此请求或连接携带的信息，此时可以编写基于 ACL 的条件，利用这些信息来决定哪些后端处理请求。 因此，根据请求的内容将流量引导到一个后端或其他后端。 最常见的示例包括使用路径中的 Host 头和 &#x2F; 或元素（子目录或文件扩展名）来确定 HTTP 请求是针对静态对象还是应用程序，以及将静态对象流量路由到后端快速轻量的服务器，以及所有剩余流量路由到更复杂的应用服务器，从而构成了一个细粒度的虚拟主机解决方案。 这可以方便地使多种技术作为更全面的解决方案共存。</p>
<p>内容交换的另一个用例包括根据各种标准使用不同的负载均衡算法。 缓存可以使用 URI 哈希，而应用程序将使用循环法（round-robin）。</p>
<p>最后，它允许多个客户通过强制执行每个后端（因此按客户连接限制）来使用一小部分公共资源。</p>
<p>内容转换规则可以很好地扩展，但其性能可能取决于所使用的 ACL 的数量和复杂性。 但是，也可以编写动态内容转换规则，其中样本值直接变为后端名称，而根本不使用 ACL。 据报道，这种配置在生产中至少有 300000 个后端工作正常。</p>
<h3 id="绑定表"><a href="#绑定表" class="headerlink" title="绑定表"></a>绑定表</h3><p>绑定表（stick table）通常用于存储粘性信息，即保持对某个访问者所指向的服务器的引用。 然后，密钥是与访问者关联的标识符（其源地址，连接的 SSL ID，HTTP 或 RDP cookie，从 URL 或有效负载中提取的客户编号，…），然后存储的值为服务器的标识符。</p>
<p>绑定表可以使用 3 种不同类型的样本作为其键：整数，字符串和地址。 代理中只能引用一个绑定表，并且在任何地方都使用代理名称指定它。 最多可以并行跟踪 8 个键。 一旦密钥和服务器都已知，就在请求或响应处理期间提交服务器标识符。</p>
<p>绑定表内容可以在主主（active-active）模式下与其他 HAProxy 节点（称为“对等节点（peer）”）以及重新加载操作期间的新进程一起复制，以便如果客户机的请求分布在多个节点上，则所有负载均衡节点共享相同的信息并做出相同的路由决策。</p>
<p>由于绑定表是基于允许识别客户端的索引，因此它们通常还用于存储额外信息，例如每个客户端的统计信息。 额外的统计信息需要一些额外的空间，需要明确声明。 可以存储的统计类型包括输入和输出带宽，并发连接数，一段时间内的连接速率和计数，错误的数量和频率，一些特定的标签和计数器等。为了支持保持这些信息在不被强制绑定到给定服务器，它实现了一个特殊的“跟踪”特性，允许同时跟踪来自不同表的 3 个键，而不考虑粘性规则。 可以从 CLI 搜索，转储和清除每个存储的统计信息，并添加到实时故障排除功能。</p>
<p>虽然这种机制可以用来代表返回的访问者或根据好的或坏的行为来调整提供的服务质量，但它主要用于对抗服务滥用（service abuse），更常见的是 DDoS，因为它允许构建复杂的模型，以高处理速度检测某些不良行为。</p>
<h3 id="格式化字符串"><a href="#格式化字符串" class="headerlink" title="格式化字符串"></a>格式化字符串</h3><p>HAProxy 需要处理字符串的许多地方，例如日志，重定向，添加报头等。 为了提供最大的灵活性，引入了格式化字符串的概念，最初用于记录目的，这解释了为什么它仍称为“日志格式”。 这些字符串包含转义字符，允许将各种动态数据（包括变量和样本提取表达式）引入字符串，甚至在结果转换为字符串时调整编码（例如，添加引号）。 这提供了一种构建报头内容或自定义日志行的强大方法。 此外，为了保持构建大多数常见字符串的简单性，提供了大约 50 个特殊标记作为日志中常用信息的捷径。</p>
<h3 id="HTTP-重写与重定向"><a href="#HTTP-重写与重定向" class="headerlink" title="HTTP 重写与重定向"></a>HTTP 重写与重定向</h3><p>如果没有合适的工具，在从未为此设计的应用程序前面安装负载均衡器可能是一项具有挑战性的任务。 在这种情况下，最常请求的操作之一是调整请求和响应头，以使负载均衡器显示为源服务器并修复硬编码信息。 这需要更改请求中的路径（强烈建议不要这样做），修改主机头字段，修改重定向的位置响应头字段，修改 cookie 的路径和域属性等。 还有一些服务器有些冗长，往往会在响应中泄漏太多信息，使它们更容易受到针对性攻击。 虽然理论上讲负载均衡器并不能解决这个问题，但实际上它位于基础设施中最好的位置，以保证一切都被清理干净。</p>
<p>同样，有时负载均衡器必须拦截某些请求，并通过重定向到新的目标 URL 进行响应。 虽然有些人往往混淆重定向和重写，但这些是两个完全不同的概念，因为重写使客户端和服务器看到不同的东西（并且访问页面的位置不一致），而重定向则要求客户端访问新的 URL，以便它看到与服务器相同的位置。</p>
<p>为此，HAProxy 支持各种重写和重定向的可能性，其中包括：</p>
<ul>
<li><p>请求和响应中基于正则表达式的 URL 和报头重写。 正则表达式是最常用的修改报头值的工具，因为它们易于操作和易于理解</p>
</li>
<li><p>也可以根据格式化字符串附加，删除或替换报头，以便传递信息（例如客户端 TLS 算法和密码）</p>
</li>
<li><p>HTTP 重定向可以使任何 3xx 代码重定向到相对，绝对或完全动态（格式化的字符串）的 URI</p>
</li>
<li><p>HTTP 重定向还支持一些额外的选项，例如设置或清除特定 cookie，删除查询字符串，如果缺少则附加斜杠等</p>
</li>
<li><p>所有操作都支持基于 ACL 的条件</p>
</li>
</ul>
<h3 id="服务器保护"><a href="#服务器保护" class="headerlink" title="服务器保护"></a>服务器保护</h3><p>HAProxy 可以最大限度地提高服务可用性，为此，需要付出巨大努力来保护服务器免受过载和攻击。 第一个也是最重要的一点是，只有完整有效的请求才会被转发到服务器， 最初的原因是 HAProxy 需要找到它与字节流保持同步所需的协议元素，第二个原因是在请求完成之前，无法知道某些元素是否会改变其语义。 这样做的直接好处是服务器不会暴露于无效或不完整的请求。 这是一种非常有效的防止慢速逃逸攻击（slowloris attacks）的保护措施，对 HAProxy 几乎没有任何影响。</p>
<p>另一个重要的点是，HAProxy 包含用于存储请求和响应的缓冲区，并且仅在服务器完成时向服务器发送请求，并通过从本地网络快速读取整个响应，服务器端的连接只在短时间内被使用，这将尽可能地保留服务器资源。</p>
<p>对此的直接扩展是 HAProxy 可以人为地限制并发连接的数量或服务器未完成的请求，这保证了服务器永远不会过载，即使它在流量高峰期间不断以 100％的容量运行。当一个插槽被释放时，所有多余的请求将被排队等待处理。 最后，这种巨大的资源节省通常可以确保更好的服务器响应时间，最终实际上比通过重载服务器更快。排队的请求可能被重新分配到其他服务器，甚至在客户端中止时在队列中中止，这也保护服务器免受“重新加载效应（reload effect）”的影响，即访问者在缓慢加载的页面上每次点击“重新加载”通常会导致新请求，使服务器维持在过载状态。</p>
<p>慢启动机制还可以在服务器仍在完成启动或编译某些类时保护服务器不受高流量水平的影响。</p>
<p>关于协议级保护，可以放宽 HTTP 解析器以接受非标准兼容但无害的请求或响应，甚至修复它们。这允许在开发修复程序时访问伪造应用程序。 同时，使用详细报告完全捕获有问题的消息，该报告可帮助开发人员发现应用程序中的问题。最危险的协议违规会被正确检测和处理并修复。 例如，如果值完全相同，则具有两个 Content-length 头的格式错误的请求或响应将被修复，或者如果它们不同则被拒绝，因为它会成为安全问题。 协议检查不仅限于 HTTP，它也可用于其他协议，如 TLS 或 RDP。</p>
<p>当检测到协议违规或攻击时，有多种选项可以响应用户，例如返回常见的“HTTP 400 bad request”，使用 TCP 重置关闭连接，或者在长时间延迟后伪造错误（“tarpit”）迷惑攻击者。 所有这些都有助于通过阻止违规客户端进行维护成本非常高的攻击来保护服务器。</p>
<p>HAProxy 还提出了一些更高级的选项来防止意外数据泄漏和会话交叉（session crossing）。 它不仅可以记录可疑的服务器响应，还会记录并可选地阻止可能影响指定访问者机密性的响应。 一个这样的示例，可缓存的响应出现在可缓存的 cookie 中，可以导致中间缓存将其传递给另一个访问者，从而导致意外的会话共享。</p>
<h3 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h3><p>对于负载均衡器来说，日志记录是一个非常重要的功能，首先是因为负载均衡器经常被错误地指责导致了它显现的问题，其次是因为它被放置在需要分析所有正常和异常活动的基础设施中的关键点并与其他组件相关联。</p>
<p>HAProxy 提供非常详细的日志，具有毫秒精度，和可在防火墙日志中搜索的确切连接接受时间（例如，用于 NAT 关联）。 默认情况下，TCP 和 HTTP 日志非常详细，包含故障排除所需的所有内容，例如源 IP 地址和端口，前端，后端，服务器，计时器（请求接收持续时间，队列持续时间，连接建立时间，响应报头时间，数据传输时间），全局进程状态，连接计数，队列状态，重试次数，详细的粘性操作和断开连接原因，带有安全输出编码的报头捕获（header captures）。然后可以扩展或替换此格式以包括任何采样数据，变量，捕获，从而产生非常详细的信息。 例如，可以记录客户端访问的累积请求数或不同 URL。</p>
<p>可以使用标准 ACL 根据请求调整日志级别，因此可以自动静默一些脏日志，不会在一小部分流量发生某些异常行为时引发警告（例如，过多的 URL 或一个源地址的 HTTP 错误）。 管理日志也以其自己的级别发出，以通知服务器的丢失或恢复。</p>
<p>每个前端和后端可以使用多个独立的日志输出，这可以简化多租户。 日志优选地通过 UDP 发送，可能是 JSON 编码的，并且在可配置的线长度（line length）之后被截断以便保证传送。</p>
<h3 id="统计"><a href="#统计" class="headerlink" title="统计"></a>统计</h3><p>HAProxy 提供基于 Web 的统计报告界面，其中包含身份验证，安全级别和范围。 因此，可以为每个托管客户（hosted customer）提供他自己的页面，仅显示他自己的实例。 此页面可以位于常规网站的隐藏 URL 部分，因此不需要打开新端口。 此页面还可以报告其他 HAProxy 节点的可用性，以便一眼就能看出是否一切正常。 视图是合成的，可以访问许多详细信息（例如错误原因，上次访问和上次更改持续时间等），这些也可以作为 CSV 表访问，其他工具可以导入以绘制图形。 该页面可以自刷新以用作大显示器上的监视页面。 在管理模式下，该页面还允许更改服务器状态以简化维护操作。</p>
<h2 id="高级功能"><a href="#高级功能" class="headerlink" title="高级功能"></a>高级功能</h2><h3 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h3><p>HAProxy 旨在在常规生产环境中保持极其稳定和安全的管理。它是作为一个单独的可执行文件提供的，不需要任何安装过程。 多个版本可以轻松共存，这意味着可以（并推荐）按重要性顺序逐步升级实例，而不是一次性迁移所有实例。配置文件很容易进行版本控制。配置检查是离线完成的，因此不需要重新启动可能失败的服务。在配置检查期间，可以检测到许多高级错误（例如隐藏另一个错误的规则，或者不起作用的粘性），并且提出详细的警告和配置提示来修复它们。向后配置文件的兼容性非常及时，版本 1.5 仍然完全支持 13 年前编写的 1.1 版本的配置，而 1.6 仅删除对几乎未使用的过时关键字的支持，这些关键字可以采用不同的方式。配置和软件升级机制平稳且无中断，因为它允许新旧进程在系统上共存，每个进程都处理自己的连接。 启动时会报告系统状态，构建选项和库兼容性。</p>
<p>一些高级功能允许应用程序管理员顺利停止服务器，检测服务器上何时没有活动，然后将其脱机，停止，升级并确保在升级时不会占用任何流量，然后再次通过正常路径对其进行测试并且不向外部开放服务，所有这一切都没有触及 HAProxy。 这确保了在开放时间内可以利用所有可用的技术资源进行复杂的生产操作。</p>
<p>进程试图尽可能地节约资源，使用内存池来节省分配时间并限制内存碎片，一旦发送内容就释放有效负载缓冲区，并支持强制执行强内存限制，超过该限制，连接必须等待缓冲区变为可用，而不是分配更多内存。 该系统有助于保证在某些严格的环境中使用内存。</p>
<p>命令行界面（CLI）可用作 UNIX 或 TCP 套接字，以执行许多操作并检索故障排除信息。 在此套接字上完成的所有操作都不需要更改配置，因此它主要用于临时更改。 使用此接口可以更改服务器的地址、权重和状态，查询统计信息和清除计数器，转储和清除粘性表，可能有选择的关键标准，转储和终止客户端和服务器端连接，转储捕获的错误，详细分析错误的确切原因和位置，转储、添加和删除 ACL 和映射中的条目，更新 TLS 共享密钥，立即将连接限制和速率限制应用于任意前端（在共享托管环境中很有用），并禁用特定前端以释放监听端口（在禁止白天操作且仍需要修复时非常有用）。</p>
<p>对于必须使用 SNMP 的环境，至少存在两个代理，一个代理随 HAProxy 源提供，并依赖于 Net-SNMP Perl 模块。 另一个是商业包提供的，不需要 Perl。 两者在覆盖范围方面大致相同。</p>
<p>通常建议在部署 HAProxy 的机器上安装 4 个实用程序：</p>
<ul>
<li>socat（为了连接到 CLI，虽然 netcat 的某些分支也可以在一定程度上做到这一点）</li>
<li>来自最新 HAProxy 版本的 halog：这是日志分析工具，它可以非常快速地解析本机 TCP 和 HTTP 日志（每秒 1 到 2GB）并提取有用的信息和统计信息，例如每个 URL 的请求，每个源地址，已根据响应时间或错误率排序的 URL ，终止代码等。它是为了在生产服务器上部署帮助解决问题，所以必须准备使用</li>
<li>tcpdump：强烈建议您使用所需的网络跟踪来解决日志中可见的问题。 有一段时间，应用程序和 haproxy 的分析会发生分歧，网络跟踪是判断谁对谁错的唯一方法。 由于 tcpdump，在网络堆栈和管理程序中检测 bug 也相当常见。</li>
<li>strace：这是 tcpdump 的附件。 它将报告 HAProxy 真正看到的内容，并将帮助从 HAProxy 负责的问题中找出操作系统负责的问题。 当怀疑 HAProxy 中存在错误时，通常会要求 Strace</li>
</ul>
<h3 id="系统特定功能"><a href="#系统特定功能" class="headerlink" title="系统特定功能"></a>系统特定功能</h3><p>根据部署的 HAProxy 操作系统，可能会提供或需要某些额外功能。 虽然它在许多平台上都受支持，但 HAProxy 主要是在 Linux 上开发的，这解释了为什么某些功能仅在此平台上可用。</p>
<p>透明绑定和连接功能，对绑定连接到特定网络接口的支持，以及将多个进程绑定到相同 IP 地址和端口的功能仅在 Linux 和 BSD 系统上可用，虽然只有 Linux 对可用进程之间的传入请求执行内核端负载均衡。</p>
<p>在 Linux 上，还有许多额外的功能和优化，包括支持网络命名空间（也称为“容器”），允许 HAProxy 成为所有容器之间的网关，能够在客户端连接上设置 MSS，Netfilter 标记和 IP TOS 字段，在监听端支持 TCP FastOpen，TCP 用户超时（user timeouts）让内核在检测到客户端在配置的超时时间之前消失时快速终止连接，TCP 拼接（splicing）让内核在连接的两端之间转发数据，从而避免多个内存副本，启用“defer-accept”绑定选项的能力只有在内核缓冲区中数据可用时才会收到传入连接的通知，并且能够通过 ACK 确认连接发送请求（有时称为“背驮式（piggy-back）”），通过使用“tcp-smart-connect”选项启用。 在 Linux 上，HAProxy 还非常注意操纵 TCP 延迟的 ACK，以便在网络上保存尽可能多的数据包。</p>
<p>有些系统有一个不可靠的时钟，它在过去和将来会来回跳跃。这种情况曾经发生在一些 NUMA 系统中，其中多个处理器没有观察到完全相同的时间，并且最近它在虚拟化环境中变得更加普遍，其中虚拟时钟与真实时钟无关，导致巨大的时间跳跃（有时已观察到长达 30 秒）。这通常会导致很多关于超时执行的麻烦。 由于这些系统的缺陷，HAProxy 保持其自己的单调时钟，该时钟基于系统的时钟，但是会测量和补偿时钟漂移。这确保即使系统时钟非常糟糕，定时器仍然保持相当准确，并且超时也可以继续工作。 请注意，此问题会影响在此类系统上运行的所有软件，并非特定于 HAProxy。常见的影响是虚假超时（spurious timeouts）或应用冻结（application freezes）。 因此，如果在系统上检测到此行为，则必须修复此行为，而不管 HAProxy 是否保护自己不受其影响。</p>
<h3 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h3><p>HAProxy 可以构建为支持 Lua 嵌入式语言，以实现请求或响应的复杂操作，路由决策，统计处理等相关的广泛的新功能。 使用 Lua 甚至可以与其他服务器建立并行连接以交换信息。 这样，例如使开发认证系统变得可能（尽管很复杂）。 有关如何使用 Lua 的更多信息，请参阅文档“doc&#x2F;lua-api&#x2F;index.rst”。</p>
<h2 id="调优"><a href="#调优" class="headerlink" title="调优"></a>调优</h2><p>典型的 CPU 使用率数据显示，在 TCP 或 HTTP 关闭模式下，HAProxy 中花费的处理时间占 15％，而在内核占 85％，在 HTTP keep-alive 模式下，HAProxy 约占 30％，而内核占 70％。 这意味着操作系统及其调优对全局性能有很大影响。</p>
<p>用户之间的用途差异很大，一些用于带宽，另一些用于请求率，其他用于连接并发或用于 SSL 性能。 本节旨在提供一些帮助完成此任务的要素。</p>
<p>重要的是要记住，每个操作都带有开销，因此每个单独的操作都会增加其他操作的开销，这在某些情况下可以忽略不计，并且在其他情况下可能占主导地位。</p>
<p>在处理来自连接的请求时，我们可以这样说：</p>
<ul>
<li>转发数据的开销低于解析请求或响应报头</li>
<li>解析请求或响应头的成本低于建立然后关闭与服务器的连接</li>
<li>建立关闭连接开销低于 TLS 恢复操作</li>
<li>TLS 恢复操作的成本低于完整的需要密钥计算的 TLS 握手</li>
<li>空闲连接比缓冲区保存数据的连接消耗更少的 CPU 资源</li>
<li>TLS 上下文比与数据连接的内存开销更高</li>
</ul>
<p>因此在实践中，处理有效负载字节比头字节开销更少，因此使用大对象（每个卷单元的请求很少）比使用小对象（每个卷单元的请求很多）更容易实现高网络带宽。 这解释了为什么始终使用大对象测量最大带宽，而使用小对象测量请求率或连接速率。</p>
<p>某些操作可以在分布在多个 CPU 上的多个进程中很好地扩展，而其他操作不能扩展。网络带宽不会扩展到很远，因为 CPU 资源不足是大对象的瓶颈，到达网络接口的主要是网络带宽和数据总线。由于在处理本地端口表时系统中有一些锁，所以连接速率在多个处理器上不能很好地扩展。持久连接上的请求速率伸缩性非常好，因为它不涉及太多内存和网络带宽，也不需要访问锁定结构。TLS 密钥计算非常好，因为它完全受 CPU 限制。TLS 恢复规模适度，但在大约 4 个进程时达到其极限，其中访问共享表的开销抵消了从更大的功耗中获得的小收益。</p>
<p>人们可以从一个非常好的调优系统中得到的性能数字在以下范围内。重要的是将它们作为数量级，并根据处理器、IRQ 设置、内存类型、网络接口类型、操作系统调优等预期任何方向都会发生显着变化。</p>
<p>在运行 3.7 GHz 的 Core i7 上发现了以下数字，配备了运行 Linux 内核 3.10，HAProxy 1.6 和 OpenSSL 1.0.2 的双端口 10 Gbps 网卡。 HAProxy 在单个专用 CPU 内核上作为单个进程运行，另外两个内核专用于网络中断：</p>
<ul>
<li>对于 256kB 或更高的对象，明文的 20Gbps 最大网络带宽；对于 41kB 或更高的对象，为 10Gbps</li>
<li>使用带有大型对象的 AES256-GCM 密码的 4.6 Gbps TLS 流量</li>
<li>从客户端到服务器每秒 83000 个 TCP 连接</li>
<li>从客户端到服务器每秒 82000 个 HTTP 连接</li>
<li>服务器关闭（server-close）模式下每秒 97000 个 HTTP 请求（与客户端保持活跃状态，与服务器关闭）</li>
<li>端到端保持（end-to-end keep-alive）模式下每秒 243000 个 HTTP 请求</li>
<li>每秒 300000 个过滤的 TCP 连接（反 DDoS）</li>
<li>在持久 TLS 连接上的 keep-alive 模式下每秒 160000 个 HTTPS 请求</li>
<li>使用 TLS 恢复连接，每秒 13100 个 HTTPS 请求</li>
<li>使用与 RSA2048 重新协商的 TLS 连接，每秒 1300 个 HTTPS 连接</li>
<li>每 GB 内存 20000 个并发饱和连接，包括系统缓冲区所需的内存，通过仔细调整可以做得更好，但这很容易实现。</li>
<li>每 GB 内存大约 8000 个并发 TLS 连接（仅客户端），包括系统缓冲区所需的内存</li>
<li>每 GB 内存大约 5000 个并发端到端 TLS 连接（双方），包括系统缓冲区所需的内存</li>
</ul>
<p>因此，要记住的一个好的经验法则是请求率是 TLS 保持活动和 TLS 恢复之间数除以 10，或 TLS 恢复和 TLS 重新协商之间的数除以 10，或 HTTP keepalive 和 HTTP close 之间的值除以 3。 另一个是，带有 AES 指令的高频核心可以为每个核心提供大约 5 Gbps 的 AES-GCM。</p>
<p>拥有更多内核并不会有用（TLS 除外），并且由于频率较低而甚至会适得其反。 通常，少量但高频的核心更好。</p>
<p>另一个好的经验法则是考虑在同一台服务器上，HAProxy 将能够饱和：</p>
<ul>
<li>大约 5-10 个静态文件服务器或缓存代理</li>
<li>约 100 个反病毒代理</li>
</ul>
<ul>
<li>大约 100-1000 个应用服务器，取决于所使用的技术</li>
</ul>
<h1 id="配套产品及替代产品"><a href="#配套产品及替代产品" class="headerlink" title="配套产品及替代产品"></a>配套产品及替代产品</h1><p>HAProxy 与下面列出的某些产品集成得相当好，这就是为什么在这里提到它们，即使它们与 HAProxy 没有直接关系。</p>
<h2 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h2><p>Apache 是一个实际的标准 HTTP 服务器。 这是一个非常完整的模块化项目，支持文件服务和动态内容。 它可以作为某些应用程序服务器的前端， 甚至可以代理请求和缓存响应。 在所有这些使用案例中，通常需要前负载均衡器。 Apache 可以在各种模式下工作，有些模式比其他模式更繁重。 某些模块仍然需要较繁重的预分叉（pre-forked）模型，并且会阻止 Apache 通过大量连接进行良好的扩展。 在这种情况下，HAProxy 可以通过将每个服务器的连接限制强制设置为一个安全值来提供极大的帮助，并且可以显著提高服务器的速度，并保存应用程序可以更好地使用的资源。</p>
<p>Apache 可以使用“mod_rpaf”扩展名从 X-Forwarded-For 报头中提取客户端的地址。 当在其配置中指定“option forwardfor”时，HAProxy 将自动提供此报头。 当暴露于互联网时，HAProxy 也可以为 Apache 提供良好的保护，它可以更好地抵御各种类型的 DoS 攻击。</p>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>NGINX 是第二个实际的标准 HTTP 服务器。 就像 Apache 一样，它涵盖了广泛的功能。 NGINX 建立在与 HAProxy 类似的模型上，因此处理数以万计的并发连接没有问题。 当用作某些应用程序的网关时（例如使用内含的 PHP FPM），设置一些前端连接限制以减少 PHP 应用程序的负载通常是有益的。 HAProxy 作为常规负载均衡器和流量调节器显然都非常有用，可以通过解除拥塞来加速 PHP。 此外，由于它们的事件驱动架构，两种产品都使用非常少的 CPU，因此通常很容易在同一系统上安装它们。 NGINX 实现了 HAProxy 的 PROXY 协议，因此 HAProxy 能很容易地将客户端的连接信息传递给 NGINX，以便应用程序获取所有相关信息。 一些基准测试还表明，对于大型静态文件服务，在 NGINX 前面的 HAProxy 上实现一致的哈希可以通过优化操作系统的缓存命中率(基本上是乘服务器节点的数量)来实现。</p>
<h2 id="Varnish"><a href="#Varnish" class="headerlink" title="Varnish"></a>Varnish</h2><p>Varnish 是一种智能缓存反向代理，可能最好的描述是 Web 应用程序加速器。 Varnish 没有实现 SSL&#x2F;TLS，并希望将其所有 CPU 周期专用于最佳功能。 Varnish 还实现了 HAProxy 的 PROXY 协议，因此 HAProxy 可以很容易地作为 SSL 卸载程序和负载均衡器部署在 Varnish 前面，并将所有相关的客户端信息传递给它。此外，当服务器提供压缩对象时，Varnish 自然支持从缓存中解压缩，但是不会压缩。 然后，当后端服务器不实现压缩时，可以使用 HAProxy 压缩传出数据，除非流量较小，否则在负载均衡器上压缩并不是一个好主意。</p>
<p>在跨多个节点构建大型缓存集群时，HAProxy 可以使用一致的 URL 哈希来智能地将负载分配给缓存节点，避免缓存重复，从而得到一个总缓存大小，即所有缓存节点的总和。</p>
<h2 id="替代产品"><a href="#替代产品" class="headerlink" title="替代产品"></a>替代产品</h2><p>Linux 虚拟服务器（LVS 或 IPVS）是 Linux 内核中包含的第 4 层负载均衡器。 它在数据包级别工作并处理 TCP 和 UDP。 在大多数情况下，它更多的是补充而不是替代，因为它根本没有第 7 层知识。</p>
<p>Pound 是另一个著名的负载均衡器。它比 HAProxy 简单得多，功能也少得多，但对于许多非常基本的设置，都可以使用这两种方法。它的作者总是首先关注代码的可审计性，并希望保持少量的特性。它的基于线程的体系结构在连接计数高的情况下伸缩性较差，但它是一个很好的产品。</p>
<p>Pen 是一款非常轻的负载均衡器。它支持 SSL，使用客户机 IP 地址的固定大小表维护持久性。它支持面向包的模式，允许它在一定程度上支持直接服务器返回和 UDP。它适用于小负载（持久性表只有 2048 个条目）。</p>
<p>NGINX 可以在某种程度上进行一些负载均衡，尽管它显然不是它的主要功能。 生产流量用于检测服务器故障，负载均衡算法更受限制，并且粘性非常有限。 但是在它已经存在的一些简单部署场景中它是有意义的。 好处是，由于它与 HAProxy 的集成非常好，因此在达到其限制后添加 HAProxy 没有任何问题。</p>
<p>Varnish 还对其后台服务器进行了一些负载均衡，并支持真正的健康检查。但是它并没有实现粘性，所以就像 NGINX 一样，只要不需要粘性，这就足够了。同样，由于 HAProxy 和 Varnish 集成得非常好，所以很容易在以后将其混用以补充功能集。</p>

  </div>
  
  
    
    <div class='footer'>
       <!-- 参考资料、相关资料等 -->
      
       <!-- 相关文章 -->
      
      <!-- 版权声明组件 -->
      
      <!-- 打赏组件 -->
      
    </div>
  
  
    


  <div class='article-meta' id="bottom">
    <div class='new-meta-box'>
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/tags/HAProxy/" rel="nofollow"><i class="fa-solid fa-hashtag fa-fw" aria-hidden="true"></i><p>HAProxy</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/tags/%E7%BF%BB%E8%AF%91/" rel="nofollow"><i class="fa-solid fa-hashtag fa-fw" aria-hidden="true"></i><p>翻译</p></a></div>
  <span hidden itemprop="keywords">HAProxy 翻译</span>


        
      
    </div>
    <!-- Custom Files bottomMeta begin -->
    
    <!-- Custom Files bottomMeta end -->
  </div>


  
  

  
    <div class="prev-next">
      
        <a class='prev' href='/2018/MFS%E5%88%86%E5%B8%83%E5%BC%8F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E7%AC%94%E8%AE%B0/'>
          <p class='title'><i class="fa-solid fa-chevron-left" aria-hidden="true"></i>MFS分布式文件系统笔记</p>
          <p class='content'>
分布式文件系统
MFS 概述
MFS 读过程
MFS 写过程


MFS 简单部署
启动 master
mfsmaster.cfg
mfsexports.cfg
启动操作


启动 metal...</p>
        </a>
      
      
        <a class='next' href='/2018/NFS%E9%AB%98%E5%8F%AF%E7%94%A8%E7%AC%94%E8%AE%B0/'>
          <p class='title'>NFS高可用笔记<i class="fa-solid fa-chevron-right" aria-hidden="true"></i></p>
          <p class='content'>
NFS 高可用概述
NFS+Keepalived+DRBD 搭建



NFS 高可用概述NFS 的物理磁盘往往做 RAID10 或 RAID0，再通过 DRBD 同步 NFS，以及设置 VI...</p>
        </a>
      
    </div>
  
  <!-- Custom Files postEnd begin-->
  
  <!-- Custom Files postEnd end-->
</article>




</div>
<aside id='l_side' itemscope itemtype="http://schema.org/WPSideBar">
  

  
    
    
      
    
  


<div class="widget-sticky pjax">

  
  


  <section class="widget toc-wrapper desktop mobile " id="toc-div" >
    
  <header>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    
  </header>


    <div class='content'>
        <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E4%BB%8B%E7%BB%8D%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%92%8C%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%99%A8"><span class="toc-text">快速介绍负载均衡和负载均衡器</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#HAProxy-%E4%BB%8B%E7%BB%8D"><span class="toc-text">HAProxy 介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy-%E6%98%AF%E4%BB%80%E4%B9%88%E4%B8%8E%E4%B8%8D%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-text">HAProxy 是什么与不是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#HAProxy-%E5%A6%82%E4%BD%95%E5%B7%A5%E4%BD%9C"><span class="toc-text">HAProxy 如何工作</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E5%8A%9F%E8%83%BD"><span class="toc-text">基础功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%A3%E7%90%86"><span class="toc-text">代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SSL"><span class="toc-text">SSL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%91%E6%8E%A7"><span class="toc-text">监控</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-text">高可用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-text">负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%98%E6%80%A7"><span class="toc-text">粘性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%87%E6%A0%B7%E4%B8%8E%E8%BD%AC%E6%8D%A2%E4%BF%A1%E6%81%AF"><span class="toc-text">采样与转换信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%98%A0%E5%B0%84"><span class="toc-text">映射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ACLS-%E5%92%8C%E6%9D%A1%E4%BB%B6"><span class="toc-text">ACLS 和条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E8%BD%AC%E6%8D%A2"><span class="toc-text">内容转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%91%E5%AE%9A%E8%A1%A8"><span class="toc-text">绑定表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-text">格式化字符串</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP-%E9%87%8D%E5%86%99%E4%B8%8E%E9%87%8D%E5%AE%9A%E5%90%91"><span class="toc-text">HTTP 重写与重定向</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%BF%9D%E6%8A%A4"><span class="toc-text">服务器保护</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97"><span class="toc-text">日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1"><span class="toc-text">统计</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AB%98%E7%BA%A7%E5%8A%9F%E8%83%BD"><span class="toc-text">高级功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86"><span class="toc-text">管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E7%89%B9%E5%AE%9A%E5%8A%9F%E8%83%BD"><span class="toc-text">系统特定功能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%84%9A%E6%9C%AC"><span class="toc-text">脚本</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E4%BC%98"><span class="toc-text">调优</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E5%A5%97%E4%BA%A7%E5%93%81%E5%8F%8A%E6%9B%BF%E4%BB%A3%E4%BA%A7%E5%93%81"><span class="toc-text">配套产品及替代产品</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Apache"><span class="toc-text">Apache</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nginx"><span class="toc-text">Nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Varnish"><span class="toc-text">Varnish</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9B%BF%E4%BB%A3%E4%BA%A7%E5%93%81"><span class="toc-text">替代产品</span></a></li></ol></li></ol>
    </div>
  </section>

  

</div>


<!-- 没有 pjax 占位会报错 万恶的 pjax -->

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <div class="pjax">
    <!-- pjax占位 -->
  </div>

  <!-- Custom Files side begin -->
  
  <!-- Custom Files side end -->
</aside>



          <!--此文件用来存放一些不方便取值的变量-->
<!--思路大概是将值藏到重加载的区域内-->

<pjax>
<script>
  window.pdata={}
  pdata.ispage=true;
  pdata.commentPath="";
  pdata.commentPlaceholder="";
  pdata.commentConfig={};
  //  see: /layout/_partial/scripts/_ctrl/coverCtrl.ejs
  
    // header
    var l_header=document.getElementById("l_header");
    
    l_header.classList.add("show");
    
    
      // cover
      var cover_wrapper=document.querySelector('#l_cover .cover-wrapper');
      var scroll_down=document.getElementById('scroll-down');
      cover_wrapper.id="none";
      cover_wrapper.style.display="none";
      scroll_down.style.display="none";
    
  
</script>
</pjax>
        </div>
        
  
  <footer class="footer clearfix"  itemscope itemtype="http://schema.org/WPFooter">
    <br><br>
    
      
        <div class="aplayer-container">
          


        </div>
      
    
      
        <br>
        <div class="social-wrapper" itemprop="about" itemscope itemtype="http://schema.org/Thing">
          
            
              <a href="https://github.com/serchaofan"
                class="social fab fa-github flat-btn"
                target="_blank"
                rel="external nofollow noopener noreferrer" itemprop="url">
                
              </a>
            
          
        </div>
      
    
      
        <div><p>博客内容遵循 <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
      
    
    <!-- Custom Files footer begin-->
    
    <!-- Custom Files footer end-->
  </footer>


        <a id="s-top" class="fa-solid fa-arrow-up fa-fw" href="/" onclick="return false;" title="top"></a>
      </div>
    </div>
    <div>
      <script>
  /******************** volantis.dom ********************************/
  // 页面选择器 将dom对象缓存起来 see: /source/js/app.js etc.
  volantis.dom.bodyAnchor = volantis.dom.$(document.getElementById("safearea")); // 页面主体
  volantis.dom.topBtn = volantis.dom.$(document.getElementById('s-top')); // 向上
  volantis.dom.wrapper = volantis.dom.$(document.getElementById('wrapper')); // 整个导航栏
  volantis.dom.coverAnchor = volantis.dom.$(document.querySelector('#l_cover .cover-wrapper')); // 1个
  volantis.dom.switcher = volantis.dom.$(document.querySelector('#l_header .switcher .s-search')); // 搜索按钮   移动端 1个
  volantis.dom.header = volantis.dom.$(document.getElementById('l_header')); // 移动端导航栏
  volantis.dom.search = volantis.dom.$(document.querySelector('#l_header .m_search')); // 搜索框 桌面端 移动端 1个
  volantis.dom.mPhoneList = volantis.dom.$(document.querySelectorAll('#l_header .m-phone .list-v')); //  手机端 子菜单 多个
</script>

<script>
  
  volantis.css("https://unpkg.com/volantis-static@0.0.1654736714924/libs/@fortawesome/fontawesome-free/css/all.min.css");
  
  
  
</script>

<!-- required -->


<!-- internal -->

<script src="/js/app.js"></script>






<!-- rightmenu要在darkmode之前（ToggleButton） darkmode要在comments之前（volantis.dark.push）-->



<script>
  function loadIssuesJS() {
    
      const sites_api = document.getElementById('sites-api');
      if (sites_api != undefined && typeof SitesJS === 'undefined') {
        volantis.js("/js/plugins/tags/sites.js")
      }
    
    
      const friends_api = document.getElementById('friends-api');
      if (friends_api != undefined && typeof FriendsJS === 'undefined') {
        volantis.js("/js/plugins/tags/friends.js")
      }
    
    
      const contributors_api = document.getElementById('contributors-api');
      if (contributors_api != undefined && typeof ContributorsJS === 'undefined') {
        volantis.js("/js/plugins/tags/contributors.js")
      }
    
  };
  loadIssuesJS()
  volantis.pjax.push(()=>{
    loadIssuesJS();
  })

</script>




  <script defer src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/vanilla-lazyload/dist/lazyload.min.js"></script>
<script>
  // https://www.npmjs.com/package/vanilla-lazyload
  // Set the options globally
  // to make LazyLoad self-initialize
  window.lazyLoadOptions = {
    elements_selector: ".lazyload",
    threshold: 0
  };
  // Listen to the initialization event
  // and get the instance of LazyLoad
  window.addEventListener(
    "LazyLoad::Initialized",
    function (event) {
      window.lazyLoadInstance = event.detail.instance;
    },
    false
  );
  document.addEventListener('DOMContentLoaded', function () {
    lazyLoadInstance.update();
  });
  document.addEventListener('pjax:complete', function () {
    lazyLoadInstance.update();
  });
</script>




  

<script>
  window.FPConfig = {
	delay: 0,
	ignoreKeywords: ["#"],
	maxRPS: 6,
	hoverDelay: 0
  };
</script>
<script defer src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/flying-pages/flying-pages.min.js"></script>









      <script>
  volantis.layoutHelper("comments",`<div id="giscus_container"></div>`)

  volantis.giscus = {};

  function check_giscus() {
    if (volantis.dark.mode === "dark") {
      volantis.giscus.Theme = 'dark';
    } else {
      volantis.giscus.Theme = 'light';
    }

    return document.getElementById("giscus_container");
  }

  function pjax_giscus() {
    const HEAD = check_giscus();
    if (!HEAD) return;
    let cfg = Object.assign({"theme":{"light":"light","dark":"dark"}},pdata.commentConfig)
    const script = document.createElement('script');
    script.setAttribute('src', 'https://giscus.app/client.js');
    Object.keys(cfg).forEach(k=>{
      if (k != "theme") {
        script.setAttribute('data-'+k, cfg[k]);
      }
    })
    script.setAttribute('data-theme', volantis.giscus.Theme);
    script.setAttribute('crossorigin', "anonymous");
    HEAD.appendChild(script);
  }

  function dark_giscus() {
    const HEAD = check_giscus();
    if (!HEAD) return;

    const message = {
      setConfig: {
        theme: volantis.giscus.Theme
      }
    };
    const giscusIframe = document.querySelector('iframe.giscus-frame');
    giscusIframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
  }
  pjax_giscus();
  volantis.pjax.push(pjax_giscus);
  volantis.dark.push(dark_giscus);
</script>

    





<!-- optional -->

  <script>
  const SearchServiceDataPathRoot = ("/" || "/").endsWith("/") ?
    "/" || "/" :
    "//" || "/";
  const SearchServiceDataPath = SearchServiceDataPathRoot + "content.json";

  function loadSearchScript() {
    // see: layout/_partial/scripts/_ctrl/cdnCtrl.ejs
    return volantis.js("/js/search/hexo.js");
  }

  function loadSearchService() {
    loadSearchScript();
    document.querySelectorAll(".input.u-search-input").forEach((e) => {
      e.removeEventListener("focus", loadSearchService, false);
    });

    document.querySelectorAll(".u-search-form").forEach((e) => {
      e.addEventListener("submit", (event) => {
        event.preventDefault();
      }, false);
    });
  }

  // 打开并搜索 字符串 s
  function OpenSearch(s) {
    if (typeof SearchService === 'undefined')
      loadSearchScript().then(() => {
        SearchService.setQueryText(s);
        SearchService.search();
      });
    else {
      SearchService.setQueryText(s);
      SearchService.search();
    }
  }

  // 访问含有 ?s=xxx  的链接时打开搜索 // 与搜索引擎 structured data 相关: /scripts/helpers/structured-data/lib/config.js
  if (window.location.search && /^\?s=/g.test(window.location.search)) {
    let queryText = decodeURI(window.location.search)
      .replace(/\ /g, "-")
      .replace(/^\?s=/g, "");
    OpenSearch(queryText);
  }

  // 搜索输入框获取焦点时加载搜索
  document.querySelectorAll(".input.u-search-input").forEach((e) => {
    e.addEventListener("focus", loadSearchService, false);
  });
</script>







  <script>



  function pjax_highlightjs_copyCode(){
    if (!(document.querySelector(".highlight .code pre") ||
      document.querySelector(".article pre code"))) {
      return;
    }
    VolantisApp.utilCopyCode(".highlight .code pre, .article pre code")
  }
  volantis.requestAnimationFrame(pjax_highlightjs_copyCode)
  volantis.pjax.push(pjax_highlightjs_copyCode)

</script>












  <script>
  function load_swiper() {
    if (!document.querySelectorAll(".swiper-container")[0]) return;
    volantis.css("https://unpkg.com/volantis-static@0.0.1654736714924/libs/swiper/swiper-bundle.min.css");
    volantis.js("https://unpkg.com/volantis-static@0.0.1654736714924/libs/swiper/swiper-bundle.min.js").then(() => {
      pjax_swiper();
    });
  }

  load_swiper();

  function pjax_swiper() {
    volantis.swiper = new Swiper('.swiper-container', {
      slidesPerView: 'auto',
      spaceBetween: 8,
      centeredSlides: true,
      loop: true,
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
      },
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },
    });
  }

  volantis.pjax.push(() => {
    if (!document.querySelectorAll(".swiper-container")[0]) return;
    if (typeof volantis.swiper === "undefined") {
      load_swiper();
    } else {
      pjax_swiper();
    }
  });
</script>


<!-- pjax 标签必须存在于所有页面 否则 pjax error -->
<pjax>

</pjax>

<script>
  function listennSidebarTOC() {
    const navItems = document.querySelectorAll(".toc li");
    if (!navItems.length) return;
    let targets = []
    const sections = [...navItems].map((element) => {
      const link = element.querySelector(".toc-link");
      const target = document.getElementById(
        decodeURI(link.getAttribute("href")).replace("#", "")
      );
      targets.push(target)
      // 解除 a 标签 href 的 锚点定位, a 标签 href 的 锚点定位 会随机启用?? 产生错位???
      link.setAttribute("onclick","return false;")
      link.setAttribute("toc-action","toc-"+decodeURI(link.getAttribute("href")).replace("#", ""))
      link.setAttribute("href","/")
      // 配置 点击 触发新的锚点定位
      link.addEventListener("click", (event) => {
        event.preventDefault();
        // 这里的 addTop 是通过错位使得 toc 自动展开.
        volantis.scroll.to(target,{addTop: 5, observer:true})
        // Anchor id
        history.pushState(null, document.title, "#" + target.id);
      });
      return target;
    });

    function activateNavByIndex(target) {
      if (target.classList.contains("active-current")) return;

      document.querySelectorAll(".toc .active").forEach((element) => {
        element.classList.remove("active", "active-current");
      });
      target.classList.add("active", "active-current");
      let parent = target.parentNode;
      while (!parent.matches(".toc")) {
        if (parent.matches("li")) parent.classList.add("active");
        parent = parent.parentNode;
      }
    }

    // 方案一：
    volantis.activateNavIndex=0
    activateNavByIndex(navItems[volantis.activateNavIndex])
    volantis.scroll.push(()=>{
      if (targets[0].getBoundingClientRect().top >= 0) {
        volantis.activateNavIndex = 0
      }else if (targets[targets.length-1].getBoundingClientRect().top < 0) {
        volantis.activateNavIndex = targets.length-1
      } else {
        for (let index = 0; index < targets.length; index++) {
          const target0 = targets[index];
          const target1 = targets[(index+1)%targets.length];
          if (target0.getBoundingClientRect().top < 0&&target1.getBoundingClientRect().top >= 0) {
            volantis.activateNavIndex=index
            break;
          }
        }
      }
      activateNavByIndex(navItems[volantis.activateNavIndex])
    })

    // 方案二：
    // IntersectionObserver 不是完美精确到像素级别 也不是低延时性的
    // function findIndex(entries) {
    //   let index = 0;
    //   let entry = entries[index];
    //   if (entry.boundingClientRect.top > 0) {
    //     index = sections.indexOf(entry.target);
    //     return index === 0 ? 0 : index - 1;
    //   }
    //   for (; index < entries.length; index++) {
    //     if (entries[index].boundingClientRect.top <= 0) {
    //       entry = entries[index];
    //     } else {
    //       return sections.indexOf(entry.target);
    //     }
    //   }
    //   return sections.indexOf(entry.target);
    // }
    // function createIntersectionObserver(marginTop) {
    //   marginTop = Math.floor(marginTop + 10000);
    //   let intersectionObserver = new IntersectionObserver(
    //     (entries, observe) => {
    //       let scrollHeight = document.documentElement.scrollHeight;
    //       if (scrollHeight > marginTop) {
    //         observe.disconnect();
    //         createIntersectionObserver(scrollHeight);
    //         return;
    //       }
    //       let index = findIndex(entries);
    //       activateNavByIndex(navItems[index]);
    //     }, {
    //       rootMargin: marginTop + "px 0px -100% 0px",
    //       threshold: 0,
    //     }
    //   );
    //   sections.forEach((element) => {
    //     element && intersectionObserver.observe(element);
    //   });
    // }
    // createIntersectionObserver(document.documentElement.scrollHeight);
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    volantis.requestAnimationFrame(listennSidebarTOC)
  });
  document.addEventListener("pjax:success", ()=>{
    volantis.requestAnimationFrame(listennSidebarTOC)
  });
</script>



<script>
  document.onreadystatechange = function () {
    if (document.readyState == 'complete') {
      // 页面加载完毕 样式加载失败，或是当前网速慢，或是开启了省流模式
      const { saveData, effectiveType } = navigator.connection || navigator.mozConnection || navigator.webkitConnection || {}
      if (getComputedStyle(document.querySelector("#safearea"), null)["display"] == "none" || saveData || /2g/.test(effectiveType)) {
        document.querySelectorAll(".reveal").forEach(function (e) {
          e.style["opacity"] = "1";
        });
        document.querySelector("#safearea").style["display"] = "block";
      }
    }
  }
</script>


  <script type="application/ld+json">[{"@context":"http://schema.org","@type":"Organization","name":"Tianyi的技术随笔","url":"https://tianyigu.top/","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},{"@context":"http://schema.org","@type":"Person","name":"Tianyi Gu","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"https://tianyigu.top/","sameAs":["https://github.com/volantis-x"],"description":"Tianyi的技术随笔"},{"@context":"http://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"item":{"@id":"https://tianyigu.top/","name":"Tianyi的技术随笔"}},{"@type":"ListItem","position":2,"item":{"@id":"https://tianyigu.top/categories/Web服务器与负载/","name":"Web服务器与负载"}},{"@type":"ListItem","position":3,"item":{"@id":"https://tianyigu.top/2018/HAProxy-Starter-Guide翻译/","name":"HAProxy Starter Guide翻译"}}]},{"@context":"http://schema.org","@type":"WebSite","name":"Tianyi的技术随笔","url":"https://tianyigu.top/","description":"Tianyi的技术随笔","author":{"@type":"Person","name":"Tianyi Gu","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"https://tianyigu.top/","description":"Tianyi的技术随笔"},"publisher":{"@type":"Organization","name":"Tianyi的技术随笔","url":"https://tianyigu.top/","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},"potentialAction":{"@type":"SearchAction","name":"Site Search","target":{"@type":"EntryPoint","urlTemplate":"https://tianyigu.top?s={search_term_string}"},"query-input":"required name=search_term_string"}},{"@context":"http://schema.org","@type":"BlogPosting","headline":"HAProxy Starter Guide翻译","description":"\n译者：serchaofan\n翻译主要借助翻译工具，并进行校对。\n根据官方 18.14 与 18.15 文档 Starter Guide的翻译，并非完整翻译，且有的地方会有修改与删除。\n","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https://tianyigu.top/2018/HAProxy-Starter-Guide%E7%BF%BB%E8%AF%91/"},"author":{"@type":"Person","name":"Tianyi Gu","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png"},"url":"https://tianyigu.top/"},"publisher":{"@type":"Organization","name":"Tianyi的技术随笔","logo":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}},"url":"https://tianyigu.top/2018/HAProxy-Starter-Guide%E7%BF%BB%E8%AF%91/","wordCount":93,"datePublished":"2018-12-02T15:45:17.000Z","dateModified":"2022-07-11T15:20:00.465Z","articleSection":"Web服务器与负载","keywords":"HAProxy,翻译","image":{"@type":"ImageObject","url":"https://unpkg.com/volantis-static@0.0.1654736714924/media/org.volantis/blog/favicon/android-chrome-192x192.png","width":192,"height":192}}]</script>



      
        <!--
  pjax重载区域接口：
  1.  <pjax></pjax> 标签 pjax 标签必须存在于所有页面 否则 pjax error
  2.  script[data-pjax]
  3.  .pjax-reload script
  4.  .pjax
-->



<script src="https://unpkg.com/volantis-static@0.0.1654736714924/libs/pjax/pjax.min.js"></script>


<script>
    var pjax;
    document.addEventListener('DOMContentLoaded', function () {
      pjax = new Pjax({
        elements: 'a[href]:not([href^="#"]):not([href="javascript:void(0)"]):not([pjax-fancybox]):not([onclick="return false;"]):not([onclick="return!1"]):not([target="_blank"]):not([target="view_window"]):not([href$=".xml"])',
        selectors: [
          "head title",
          "head meta[name=keywords]",
          "head meta[name=description]",
          
          "#l_main",
          "#pjax-header-nav-list",
          ".pjax",
          "pjax", // <pjax></pjax> 标签
          "script[data-pjax], .pjax-reload script" // script标签添加data-pjax 或 script标签外层添加.pjax-reload 的script代码段重载
        ],
        cacheBust: false,   // url 地址追加时间戳，用以避免浏览器缓存
        timeout: 5000,
        
      });
    });

    document.addEventListener('pjax:send', function (e) {
      //window.stop(); // 相当于点击了浏览器的停止按钮

      try {
        var currentUrl = window.location.pathname;
        var targetUrl = e.triggerElement.href;
        var banUrl = [""];
        if (banUrl[0] != "") {
          banUrl.forEach(item => {
            if(currentUrl.indexOf(item) != -1 || targetUrl.indexOf(item) != -1) {
              window.location.href = targetUrl;
            }
          });
        }
      } catch (error) {}

      // 使用 volantis.pjax.send 方法传入pjax:send回调函数 参见layout/_partial/scripts/global.ejs
      volantis.pjax.method.send.start();
    });

    document.addEventListener('pjax:complete', function () {
      // 使用 volantis.pjax.push 方法传入重载函数 参见layout/_partial/scripts/global.ejs
      volantis.pjax.method.complete.start();
    });

    document.addEventListener('pjax:error', function (e) {
      if(volantis.debug) {
        console.error(e);
        console.log('pjax error: \n' + JSON.stringify(e));
      }else{
        // 使用 volantis.pjax.error 方法传入pjax:error回调函数 参见layout/_partial/scripts/global.ejs
        volantis.pjax.method.error.start();
        window.location.href = e.triggerElement.href;
      }
    });
</script>

      
    </div>
    <!-- import body_end begin-->
    <!-- import body_end end-->
    <!-- Custom Files bodyEnd begin-->
    
    <!-- Custom Files bodyEnd end-->
  </body>
</html>
