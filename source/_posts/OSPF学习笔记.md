---
title: OSPF学习笔记
date: 2018-07-31 12:36:00
tags: [OSPF,网络]
---

**基于华三网络学习笔记（理论）**

本篇包含以下内容
* [OSPF特性与基本术语](#OSPF特性与基本术语)
* [OSPF报文](#OSPF报文)
* [OSPF邻居建立维护与状态机](#OSPF邻居建立维护与状态机)
* [OSPF特殊区域](#OSPF特殊区域)
<!-- more -->

## OSPF特性与基本术语
Open Shortest Path First开放最短路径优先
* 属于IGP，优先级AS内部10，外部150
* 采用链路状态算法SPF防环
* 封装在IP报文中，协议号89
* 度量值为开销cost=带宽参考值/接口带宽，参考值通常为100M，若求得的数小于1，则cost就取1
* 报文更新方式为触发更新+周期更新（30min。LSA老化时间60min）
* 增量更新（通过LSA），组播更新报文
* 组播地址224.0.0.5（主要，所有OSPF路由器都能收到）或224.0.0.6（DR、BDR可收到）
* 没有跳数限制，可用于大规模组网

路由生成过程：
1. 生成LSA描述自身接口状态（链路开销、IP地址等）
2. 同步OSPF区域内每台路由器的LSDB（通过交换LSA）
3. SPF算法计算路由：每个路由器以自身为根计算最短路径树（即根到各节点的开销都是最小的），加入路由表，若两条路径开销相同，则都加入表中形成等价路由。

开启OSPF的路由器上与路由转发相关的三张表：
* 邻居表：记录建立了邻居关系的路由器
* LSDB表：记录所有链路状态信息，需要实时同步
* 路由表：记录经SPF算法计算的路由

OSPF选路原则：
1. 按路由类型优先级：区域内路由>区域间路由>第一类外部路由>第二类外部路由
2. 类型相同，选路由开销小的
3. 以上都相同，形成等价路由

两类外部路由：
{% asset_img 3.png %}
* 第一类外部路由：偏向于AS内部的选路，并不关心AS外的开销。用于控制入AS的路由选路。
  如图中RTA，若选择第一类外部路由，则关心AS内部的开销，会选择开销较小的RTB路线。
* 第二类外部路由：偏向与AS外部的选路，并不关心AS内的开销。用于控制出AS的路由选路。
  如图中RTA，若选择第二类外部路由，则关心AS外部的开销，会选择开销较小的RTC路线。

若同一网段的路由信息同时通过第一类外部路由和第二类外部路由学习到，在其他条件相同的情况下，会优选第一类外部路由。

骨干区域：area 0，负责转发非骨干区域之间的路由。
区域间路由规则：
1. 非骨干区域必须与骨干区域相连
2. 非骨干区域之间不能传递路由，必须通过骨干区域
3. 骨干区域传出的路由不能传回非骨干区域

OSPF防环：从一个区域学习到的路由不会再向该区域注入。非骨干区域间不能直接通信

当骨干区域被分割或非骨干区域不与骨干区域相连时，可通过虚连接解决。
两台ABR（区域边界路由器）通过一个非骨干区域建立一条逻辑通道，对于通道上的路由器是透明的。

划分区域的好处：
* 减少了区域内LSDB中链路状态信息的数量
* 便于管理
* 减少路由震荡的影响范围

OSPF路由器类型：
1. 区域内路由器Internal：所有接口都属于同一个区域
2. 区域边界路由器Area Border：连接骨干与非骨干区域（物理上或逻辑上）
3. 骨干路由器Backbone：至少有一个接口属于骨干区域，即所有区域内和区域边界路由器都是骨干路由器
4. 自治系统边界路由器Autonomous System Border：与其他AS路由器交换路由信息，不一定在AS的边界，只要该路由器引入外部路由，就是ASBR。
{% asset_img 2.png %}

Router ID用来在AS中唯一标识一个路由器，RouterID的选取优先级如下：
局部 > 全局 > 自动选举
局部：创建OSPF进程时同时指定router-id
全局：系统视图下指定router id
自动选举：环回口中最大的，若无环回口，则选取接口中IP地址最大的

网络类型：
1. Broadcast广播：当链路层为以太网协议时，默认为Broadcast，以组播地址发报文(.5|.6)，需要DR，Hello定时器10s，邻居失效时间40s。
2. NBMA非广播多点可达网络：当链路层为帧中继或ATM时，默认为NBMA，以单播发报文，需要DR，Hello定时器10s，邻居失效时间40s。
3. P2P点到点：当链路层为PPP、HDLC时，默认P2P，以组播发报文(.5)，不需要DR，Hello定时器30s，邻居失效时间120s。
4. P2MP点到多点：需要手动修改，以组播发报文(.5)，不需要DR，Hello定时器30s，邻居失效时间120s。

## OSPF报文
OSPF五种报文：
1. `Hello`报文：发现维护邻居关系，包含定时器、DR、BDR和已知邻居
2. `DD`报文：数据库描述报文，**描述本地LSDB中LSA摘要，进行主从关系协商**，用于路由器间LSDB同步
3. `LSR(Request)`报文：链路请求报文，向对方请求所需LSA（通过比对DD报文知道自己缺哪些LSA）
4. `LSU(Update)`报文：链路状态更新报文，向对方发送所要求的LSA
5. `LSAck`报文：链路状态确认报文，对收到的LSA进行确认


## OSPF邻居建立维护与状态机
邻居建立与维护：
1. 组播发送Hello报文（.5），双方协商参数，若验证、区域等都相同，则表示邻居发现
2. 邻居周期交换Hello报文，若邻居失效时间超时未收到Hello则认为邻居失效，将该邻居从邻居表中删除

DR/BDR选举：
目的：减少邻接关系的数量，所有路由信息都发给DR（指定路由器），再由DR发LSA
若不设置DR/BDR，则邻接关系数量`R=n(n-1)/2`个
若设置DR/BDR，则邻接关系数量`R=2(n-2)+1`个

BDR是DR的备份。若DR失效，BDR立刻成为DR。
DR/BDR选举原则：
1. 首先比较Hello报文中的优先级，最高的为DR，次高的为BDR，若为0不参加选举。
2. 优先级相同则比较RouterID，大的优
3. 选举完毕后，即使有更优的路由器加入区域，也不会更换DR/BDR（可以在用户视图重置ospf进程，使ospf重新选举）
4. 只有广播和NBMA网络选举DR/BDR
5. 剩余路由器成为DRother，只与DR、BDR建立邻接关系

邻接关系建立：
1. 初始状态，A的邻居为`Down`，由于邻居表为空，所以DR字段置为`0.0.0.0`，发送Hello报文，B收到Hello报文后，将A添加进邻居表中，邻居状态变为`Init`，两个路由器比较RouterID，大的（假设A）会在后面的Hello报文中将DR字段设为自己的RouterID。
2. B收到Hello报文，发现邻居表中有自己的RouterID，于是将邻居表中A状态变为`2-way`。B也收到后，同理。若当前两台路由器都是DRother，则邻接状态就会维持在`2-way`。只有其中一个是DR或BDR，才会继续建立关系
3. 若进一步建立邻接关系，A会将B状态设为`ExStart`，并发送一个不包含LSA的DD报文，开始主从协商。
其中DD报文包含MS位，最开始该MS位置1，表示路由器以自己为Master。Master路由器的作用就是在交换DD报文时，主动发送DD报文，并控制报文的序列号。Slave路由器仅能接受Master指定的序列号并被动发送DD。
4. B收到DD后，将发送方的状态设为`ExStart`。对比RouterID，若大（假设A）就在DD报文中将MS位也置为1，表明自己是Master，并回复。B收到DD报文后，同意A为Master，将MS位置0，表明自身Slave，采用A规定的序列号向A发DD报文，此时DD报文中包含LSA摘要，A收到后将B状态改为`Exchange`。B收到A的DD报文后也将A状态改为`Exchange`。
5. A与B都对DD报文的LSA与LSDB进行比对，若LSA信息在LSDB中都存在，就直接进入`Full`状态。若一方LSDB不完全包含LSA，则向另一方请求，并将对方状态置为`Loading`，发送LSR。另一方收到后根据LSR返回LSU。再次比对后相同就进入`Full`。

OSPF状态机
其中有三个稳定状态：`Down`、`2-way`、`Full`
* `down`：未启动ospf
* `init`：收到对方hello包，但hello包中的邻居表没有自己
* `2-way`：收到对方hello包，且在hello包中看到自己
* `exstart`：互相发送空的DD协商主从报文，以决定谁发DD报文
* `exchange`：交换真正的DD报文
* `loading`：交互路由信息
* `full`：路由学习完毕，邻接关系建立

{% asset_img 1.png %}

影响OSPF建立邻接关系的因素：
1. area是否一致
2. 接口是否开启OSPF
3. 接口是否开启验证
4. 是否启用了静默接口，或开启过滤
5. 是否处于特殊区域
6. Hello/Dead定时器是否一致
7. Router-id是否不同
8. 链路两端接口掩码是否不同（广播类型链路hello会携带掩码信息）
9. 两端MTU是否不同（若不同会一直在Exstart状态）

### 链路状态广播LSA
LSA老化时间3600s（1小时），每1800s（半小时）ospf就会泛洪一次全部路由信息

报文字段：
1. `LS age`：LSA产生后经过的时间（单位秒）
2. `LS type`：LSA类型（1-11）
3. `Link State ID`：LSA链路ID，根据LSA类型而定
4. `Advertising Router`：始发LSA的路由器ID，也称LSA通告路由器
**`LS type`、`Link State ID`、`Advertising Router`三个参数唯一标识一个LSA**
5. `LSA sequence number`：LSA序列号，用于判断是否是最新的LSA
6. `LS checksum`：LSA信息的校验和
7. `length`：LSA总长度

LSDB更新过程：收到一条LSA更新报文，在LSDB中查找该LSA，若未找到就将这条LSA加入LSDB，若找到，就对比LSA的序列号，若该条的大，就更新，否则不更新。

LSA类型：
* 一类：`Router LSA`，描述区域内部与路由器直连的链路信息，所有OSPF路由器始发，仅在区域内传播。不携带掩码信息
* 二类：`Network LSA`，记录广播或NBMA上所有路由器RouterID，DR始发，仅在区域内传播。携带网段掩码信息，和一类LSA共同计算网段
  **一类和二类LSA解决了区域内部的通信**
* 三类：`Network Summary LSA`，包含区域网段与开销，传播给相邻区域，ABR始发，区域间传播。实际就是收集一类和二类的LSA。每个三类LSA包含一个网段
  **一、二、三类LSA解决了区域内和区域间通信**
* 四类：`ASBR Summary LSA`，描述ASBR的RouterID和开销，传播给非ASBR区域，ABR始发。辅助五类LSA，实现到达ASBR。告诉OSPF内部路由器如何到达ASBR
* 五类：`AS External LSA`，描述到AS外部的路由，包含外部网段、开销等，传播给整个OSPF系统，ASBR始发。每个五类LSA包含一个网段。
* 七类：`NSSA Exteranl LSA`，只在NSSA中传播，描述到AS外部的路由，ASBR始发

路由聚合：ABR和ASBR可将具有相同前缀的路由聚合发布。

安全：
* 协议报文验证：通过验证的OSPF报文才能被接收（路由器+接口都要配置验证：Simple或MD5）
* 禁止端口发送OSPF报文：该端口成为被动端口（静默），不再发送Hello报文
* 过滤计算出的路由：通过过滤规则的路由才加入路由表
* 过滤三类LSA：设置规则过滤外部路由（本地有效）

## OSPF特殊区域
OSPF特殊区域：
1. `Stub`：不允许注入四、五类LSA。不能存在ASBR。虚连接不可穿过。若有多个ABR可能产生次优路由
2. `Totally Stub`：不允许注入三、四、五类LSA。虚连接不可穿过。ABR会产生一条0.0.0.0/0的三类LSA
3. `NSSA`：不允许四、五类LSA，允许七类LSA。虚连接不可穿过。该区域存在一个ASBR，该区域不希望接收其他ASBR的外部路由。七类默认路由LSA由ASBR产生，在NSSA中传播，当到达ABR时，会转换为五类LSA传到别的区域。
**Totally STub和NSSA都是Stub的变形或改进**
4. `Totally NSSA`：不允许注入三、四、五类LSA，而是用七类默认路由取代。虚连接不可穿过。