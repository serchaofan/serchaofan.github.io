---
title: TCP/IP基础笔记
date: 2019-03-21 19:00:08
tags: [TCP/IP, 网络]
---

本篇包含计算机网络和TCP/IP结构的重要知识点，以及华三设备的一些操作。

* [网络概述](#网络概述)
* [TCP与UDP概述](#TCP与UDP概述)
* [IP基本原理](#IP基本原理)
* [DHCP概述](#DHCP概述)
* [FTP概述](#FTP概述)
* [DNS概述](#DNS概述)
* [Telnet概述](#Telnet概述)
* [SSH概述](#SSH概述)
* [路由控制与转发](#路由控制与转发)



<!--more-->



# 网络概述

两种数据交换方式：

* 电路交换：基于电话网的电路交换

  主要通过交换机连接，两台计算机独占线路

* 分组交换：以分组为单位存储转发

  原理：将大数据分隔为一个一个包传输，每个包都打上报文头（标有分组序号、源目IP等），接收端收到后按照分组序号进行拼接

衡量计算机网络的指标：

* 带宽（一定时间内两个节点间数据量，单位bps）
* 延迟（数据在两个节点间传输的时间）



OSI七层模型：

1. 物理层：比特流传输，比特流与电子信号之间的转换，规定连接器与网线的规格

2. 数据链路层：协商比特流一致性，数据帧与比特流之间的转换，流量控制，差错校验，编帧与识别**帧**

3. 网络层：寻址，地址管理，路由选择，拥塞控制，异种网络互连

4. 传输层：端到端逻辑连接的建立维护与断开、差错重传、数据排序、多路复用、流量控制、对应用层数据进行分段与封装

5. 会话层：通信管理。主机间通信、建立维护及终止程序间会话、决定连接方式（SQL、NFS、RPC等）

6. 表示层：定义数据格式与结构、协议上层数据格式、将设备固有的数据格式转化为网络标准传输格式（编码格式、图片格式等）

7. 应用层：为程序进程提供网络服务，针对特定应用



可路由协议：**定义**数据包内各个字段格式与用途，对数据进行网络层**封装**（即IP协议）

路由协议：在路由器间传递信息，计算并形成路由表，为可路由协议选择路径（RIP、OSPF、BGP）

面向连接的服务（可靠连接）：

1. 通信前建立连接，完成后断开连接  
2. 有序传递  
3. 应答确认  
4. 差错重传

无连接服务（不可靠连接）：

1. 尽力而为  
2. 无需建立连接  
3. 无序列号机制
4. 无确认机制
5. 无重传机制



TCP/IP模型：

1. 网络接口层：物理线路与链路层通信

2. 网络层：数据包路由转发，路由表的维护 （IP、ICMP、IGMP）

3. 传输层：端到端通信，数据完整性校验，差错重传，数据排序 （TCP、UDP）

4. 应用层：处理特定应用细节 （Telnet、FTP、SMTP、HTTP等）



局域网CSMA/CD载波侦听机制：用于防止总线型局域网冲突。

实现：**先听后发，边听边发，冲突停发，退避再发**



广域网三种连接方式：

1. 专线：点到点永久独占线路，带宽固定，链路层使用SDLC、HDLC、PPP等协议

2. 电路交换：按需拨号建立连接，独占线路，带宽固定，链路层用PPP

3. 分组交换：通过虚电路连接到多个对端，如帧中继、ATM等



ARP（Address Resolution Protocol）地址解析协议，根据IP地址解析出MAC地址。

ARP原理：

* 请求：广播发送ARP请求报文，请求获取目标IP的MAC地址

* 应答：单播回应，将自身MAC发送给请求方

RARP：反向地址转换协议，根据MAC地址解析出IP地址

代理ARP：路由器充当ARP中间代理去广播ARP请求

ICMP协议：Internet控制报文协议，用于检测网络是否通畅、主机是否可达等



# TCP与UDP概述

## TCP

Transmission Control Protocol传输控制协议，协议号6

特点：

* 面向连接，可靠，基于字节流
* 确认机制：应答接收 
* 端口号：多路复用
* 序列号：丢失检测、乱序重排
* 完整性校验：差错校验 
* 窗口机制：流量控制
* 三次握手：可靠连接



TCP报文头：

{% asset_img 1.jpg %}

1. Source Port(16 bit)：源端口

2. Destination Port(16 bit) ：目的端口

3. Sequence Number(32 bit)：数据包中第一个字节的序列号，取值范围[0,2^32-1]，是mod2^32运算的值

4. Acknowledge Number(32 bit) ：确认序列号，期望收到对方下一报文的第一个数据字段的序号

5. Data Offset(4 bit) ：数据偏移，值为TCP头的长度除以4

6. 标志位(6 bit)  #主要字段：
   * URG：紧急，需要尽快传送
   * ACK：确认，建立连接后的报文确认
   * PSH：推送，接收方要尽快将此报文给上层处理
   * RST：复位，重新连接
   * SYN：同步，发起连接
   * FIN：终止，释放连接

7. Windows Size(16 bit)：接受缓冲区空闲空间，告诉对端自己能接收的最大数据长度

8. Checksum(16 bit)：校验和

常见服务：Telnet(23)、FTP(20\21)、SSH(22)、HTTP(80)、SMTP(25)



三次握手：连接建立

1. A向B发送SYN（seq=x），进入SYN_SEND状态

2. B收到SYN报文，回应SYN（seq=y）、ACK（ack=x+1）报文，进入SYN_RECV状态

3. A收到B的SYN报文，回应ACK（ack=y+1）进入Established状态，TCP连接建立

{% asset_img 2.jpg %}



四次挥手：连接终止

1. A向B发送FIN，表示数据传输完毕

2. B收到后执行被动关闭，确认回复ACK

3. B关闭套接字，向A发送FIN

4. A接收到后向B确认，发送ACK

{% asset_img 3.jpg %}

滑动窗口：限制每次发送的包数

1.A向B以默认发包数发送数据包

2.B回复ACK报文，其中除了ack外还带有win限制每次发送的数据长度

3.此后A便会按照要求长度发送数据包

{% asset_img 4.jpg %}



## UDP

User Datagram Protocol用户数据报协议，协议号17

特点：无连接，不可靠传输，无流量控制，直接封装应用层数据（不分段）

报文头：

{% asset_img 5.jpg %}

1. Source Port(16 bit)  #源端口

2. Destination Port(16 bit)  #目的端口

3. Length(16 bit)  #数据包长度

4. Checksum(16 bit)  #校验和

常见服务：DNS(53)、TFTP(69)、SNMP(161)、NFS、DHCP(67\68\546)



# IP基本原理

IP作用：

1. 标识结点与链路
   * 用唯一IP地址标识每个节点
   * 用唯一IP网络号标识每个链路

2. 寻址与转发
   * 确定节点所在网络位置进而确定节点位置
   * IP路由器选择适当路径将IP包转发到目的节点

3. 适应各种数据链路
   * 根据链路的MTU对IP包进行分片与重组（MTU：最大传输单元，能通过的最大数据包大小（以字节为单位））
   * 为了通过实际的数据链路传递信息，须建立IP地址到数据链路层地址的映射



IP头（20字节）

{% asset_img 6.jpg %}

1. Version(4 bit)：当前IP版本

2. IHL(4 bit) ：IP报文头长度，等同于数据字段的偏移量，最小为5（即5*32），最大为15

3. Type-of-Service(8 bit) ：上层协议对处理当前数据报所期望的服务质量，并对数据报按照重要性级别进行分配，分配优先级、延迟、吞吐量以及可靠性。

4. Total Length(16 bit) ：整个IP数据包的字节长度（数据+IP头），最大65535字节

5. Identification(16 bit)：用于识别当前数据包

6. Flags(3 bit)：低位控制分片，中位指出数据包是否可分片，高位保留

7. Fragment Offset(13 bit)：指出与源数据包的起始端相关的分片数据位置

8. Time-to-Live(8 bit) ：生存时间，每经过一节点就减少1直到为0

9. Protocol(8 bit) ：指出接收数据包的上层协议

10. Header Checksum(16 bit) ：头部校验和，保证IP头完整

11. Source Address(32 bit)：源IP

12. Destination Address(32 bit) ：目IP



VLSM：可变长子网掩码。使同一IP地址能划分为多个子网，能按照子网要求定制，每个子网都可自定义大小。

CIDR：无类域间路由。基于VLSM，CIDR使用网络前缀，可有各种长度，由掩码标识。可进行网段聚合。



# DHCP概述

UDP协议，采用C/S模式，服务器端口67，客户端端口68

三种分配方式：

1. 手动分配：静态绑定固定IP，这些IP固定给特定设备使用（打印机，DNS，web服务器等）

2. 自动分配：服务器给客户端分配**租期无限长**的IP地址，只有客户释放，其他客户才能使用该地址

3. 动态分配：服务器给客户端分配**租期有限长**的IP地址，一旦租期到期而未续约，地址就会释放。

**基本原则：尽可能为客户端分配原来使用的地址。**

分配顺序：

1. 静态分配的
2. 客户端曾经会用过的 
3. 最先找到的可用IP



DHCP报文：

1. Discover：客户端第一次向服务器发送的请求报文，广播发送

2. Offer：服务器对客户端Discover的回应，包含分配的IP、掩码、网关等信息，广播或单播发送

3. Request：客户端发送给服务器的请求报文，包括服务器的选择与租期更新等，单播或广播发送（根据客户端状态）

4. Release：客户端若想释放当前地址，则单播发送给服务器

5. Ack/Nak：服务器对客户端的回应，请求报文正确时回复Ack，否则回复Nak

6. Decline：客户端收到服务器的Ack后，对获取的IP进行确认，使用ARP，若发现该IP已被使用，则广播向服务器发送Decline报文，拒绝使用该IP。

7. Inform：当客户端通过其他方式已获取了IP，若还需要向服务器索取其他配置信息时，会向服务器发送Inform，若服务器能根据要求分配则会回复Ack，否则不操作。



DHCP续约：

1. 更新状态：使用时间达到租约的50%，客户端进入更新状态，单播向服务器发送Request，服务器若同意续约则回复Ack，否则回复Nak

2. 重新绑定状态：使用时间达到租约的87.5%，客户端进入重新绑定状态。客户端广播Request请求，请求对有效租期进行更新。

   进入该状态的原因：客户端未收到服务器对续约Request的回应。

   若Request未收到回应，客户端会在一定时间内重发Request报文，若直到租期结束也未更新租期，则被迫释放IP地址。



DHCP中继：DHCP只适用于客户端与服务器在同网段（原因：广播请求）。可以通过中继使客户端可向其他网段的DHCP服务器请求。

​	实现：中继路由器收到请求广播报文，便向服务器单播发送，同理服务器也单播回应中继，中继再广播回应客户端。



# FTP概述

TCP协议，采用C/S模式，控制连接端口21，数据连接端口20

控制连接：负责FTP客户端与服务器交互命令与信息的传输，在整个会话过程中始终打开。

数据连接：负责客户端与服务器数据的传输，传输完毕就会关闭



文件传输模式：

1. ASCII：默认模式，发送方将文件转为ASCII码传输，适合文本文件传输

2. 二进制：也称图像文件传输模式，按比特流传输，适合程序文件传输

数据传输方式：

1. 主动PORT

   过程：

   1. 首先客户端（随机端口）与服务器（21端口）TCP三次握手建立连接，建立控制连接通道
   2. 客户端向服务器发送PORT命令，告知服务器使用主动模式。

   其中PORT命令携带参数（客户端IP地址, P1, P2），P1与P2用于标识客户端数据连接的临时端口号，具体为256*P1+P2，IP地址也是四段，每段用逗号分隔

   3. 服务器收到PORT命令后按照参数用20端口与客户端指定端口三次握手建立数据传输通道。
   4. 数据传输完毕，发送方发送FIN报文，关闭数据连接

   **问题：若客户端在防火墙内部网络，主动方式会出现问题，因为客户端提供的端口是随机的，防火墙若未放行该端口，则无法建立FTP连接。**

   **此时需要使用被动方式建立连接**

2. 被动PASV

   过程：

   1. 首先客户端（随机端口）与服务器（21端口）TCP三次握手建立连接，建立控制连接通道
   2. 客户端向服务器发送PASV命令，参数与PORT一致。但IP是服务器的，标识的是服务器端的临时端口号。
   3. 客户端用随机端口与服务器的指定临时端口TCP三次握手建立数据连接通道。
   4. 数据传输完毕，发送方发送FIN报文，关闭数据连接



## TFTP简单文件传输协议

UDP协议，端口69

特点：

1. 仅提供简单文件传输功能（上传，下载）
2. 无存取授权与认证机制，无目录功能
3. 由客户端发起



下载过程：

1. 客户端向服务器发送读请求  

2. 服务器根据请求回应数据报文（块编号从1开始）

3. 客户端收到数据后回应确认报文。

   重复2.3步直至完成下载

上传过程：

1. 客户端向服务器发送写请求 

2. 服务器回应确认报文（块编号为0）  

3. 客户端发送数据报文（块编号从1开始） 

4. 服务器收到后回应确认报文。

   重复3.4步直至上传完成



文件传输时，将文件分成多个文件块，封装到数据报文中并打上文件块编号

传输文件模式：

1. netASCII：对应FTP的ASCII模式   
2. octet：对应FTP二进制模式

协议报文：

1. RRQ读请求  
2. WRQ写请求  
3. 数据报文 
4. 确认正确/错误报文

报文的头两个字节是操作码字段，1为读请求，2为写请求，3为数据报文，4为确认正确，5为错误。

文件传输过程中读写出错就发送差错报文，数据传输就停止，差错报文不会被确认也不会重传

TFTP每次传输的数据报文中文件块大小固定为512字节，若文件大小刚好是512字节的整数倍，则传完文件后还要再发一个空文件块的数据报文表明文件传输完成。



# DNS概述

TCP或UDP（基本是UDP）协议，端口号53，采用C/S模式，解析域名与IP映射。

查询方式：

1. 递归：服务器收到请求时，若不能解析，则把请求转发到下一台服务器直到有一台解析成功

{% asset_img 7.png %}

2. 迭代：服务器收到请求时，若不能解析，则按根域 -> 一级域名 -> 二级域名 -> 三级域名依次询问，直到解析成功

{% asset_img 8.png %}



反向查询：根据IP解析域名，使用特殊域in-addr.arpa域，该域的子域是按照点分十进制表示法编号的IP地址相反顺序构造，即IP地址的四段倒置形成该域。

域名服务器类型：

1. 本地域名服务器：自行管理的域名服务器，与客户端很近

2. 根域名服务器：管理顶级域，本身不对域名解析，但知道相关域名服务器的地址

3. 授权域名服务器：每个主机都必须在某个授权域名服务器上注册，通常该服务器就是本地域名服务器，最好有两个以防单点故障

4. 主域名服务器：完成一个或多个域的域名解析的主用域名服务器

5. 辅助域名服务器：协助主域名服务器，分担主服务器的压力，且能作为冗余服务器，本身不建立区域地址信息文件，而是获取主服务器上最新副本（两种获取方式：1.辅服务器启动或配置刷新时间到期后主动向主服务器获取  2.主服务器启动通知功能，区域数据变化后，将变化通知给辅服务器，辅服务器更新副本）



DNS既可以TCP查询也可以UDP查询的原因：

DNS响应报文中有特殊位--删减标志位TC，当响应报文采用UDP封装且长度大于512字节时，服务器仅回复前512字节，同时TC置位，表示报文进行了删减。当客户端收到TC置位的报文，客户端将用TCP重新封装请求报文并发送，此时服务器返回TCP封装的回应。



DNS特性

1. 静态域名解析

   设备上手动建立域名与IP的映射关系

2. 动态域名解析

   设备查询DNS服务器，由服务器完成解析

3. DNS代理

   在客户端与服务器间转发DNS请求与应答报文。客户端将DNS代理当做服务器，代理再将请求转发给服务器，应答同理。



# Telnet概述

基于TCP，端口号23，采用C/S模式。使用Telnet进行远程访问设备进行配置维护。

telnet安全问题：无安全认证机制，数据以明文传输。

实现Telnet的条件：

* 服务器端：
  1. 内核命令行接口：操作系统内核与虚拟终端间的适配层
  2. 虚拟终端：类似实体终端的驱动程序。通过虚拟终端与内核交换信息
  3. Telnet服务器进程
  4. TCP/IP协议栈

* 客户端：
  1. Telnet客户端程序 
  2. TCP/IP协议栈

工作过程：

1. 客户端与设备端23端口进行TCP连接
2. 系统将客户端命令以NVT网络虚拟终端格式传送到服务器并执行
3. 服务器端将NVT格式的命令执行结果再转化为客户端接受的格式传回客户端
4. 客户端发送命令进行TCP断开连接。



*华三路由器的Telnet默认关闭。*



## 华三设备操作

实验环境：两台交换机（需要配IP地址）或路由器

{% asset_img 10.png %}

SW2作为telnet server，SW1作为telnet client

```
SW2:
[sw2]interface Vlan-interface 1
[sw2-Vlan-interface1]ip address 192.168.1.2 24

SW1:
[sw1]interface Vlan-interface 1
[sw1-Vlan-interface1]ip address 192.168.1.1 24
```

配置telnet

```
SW2:
[sw2]telnet server enable        # 开启telnet
[sw2]user-interface vty 0 10     # vty用户界面。
# 两个数字是确定vty号的范围第一个数字范围0-63，第二个范围1-63
[sw2-line-vty0-10]authentication-mode scheme  # 设置验证方式，这里选了用户名密码方式
[sw2-line-vty0-10]set authentication password simple 123456 #设置验证密码
[sw2-line-vty0-10]user-role level-3   # 设置用户权限，权限等级0-15
[sw2]local-user zhangsan    # 创建用户zhangsan
New local user added.
[sw2-luser-manage-zhangsan]service-type telnet    # 设置为telnet服务，不设置无法登录
[sw2-luser-manage-zhangsan]password simple 123456 # 设置提权密码
```

从SW1登录SW2

```
telnet 192.168.1.2
```



# SSH概述

基于TCP，端口号22，安全的远程登录协议

特点：

1. 数据机密性：支持DES、3DES加密算法，会对用户名与密码及数据进行加密。
2. 支持多种认证方式：支持公钥验证方式（必支持）、密码验证方式（可选支持）、不验证方式（可选）
3. 支持RSA认证：RSA非对称加密

SSH协议基本框架：

主要包含三个协议：1.传输层协议  2.用户认证协议  3.连接协议

{% asset_img 9.jpg %}



连接建立过程：

1. 版本号协商：
   1. 客户端与服务器端22端口TCP连接。连接建立后，服务器向客户端发送报文，包含版本标志字符串（SSH-<主协议版本号>.<次协议版本号>-<软件版本号>）
   2. 客户端收到后解析报文，若版本号比自己的低，就使用低版本号
   3. 客户端回应服务器，包含客户端决定的协议版本号
   4. 服务器端比较版本号，若协商成功，则进入密钥算法协商阶段，否则断开TCP连接

2. 密钥与算法协商：
   1. 客户端与服务器端互相交换密钥算法协商报文，包含支持的公钥算法列表、加密算法列表、MAC（消息验证码）算法列表、压缩算法列表
   2. 通过对比双方都得出最终使用的算法
   3. 双方通过DH算法交换，生成会话密钥与会话ID

3. 认证：

   1. 客户端向服务器发送认证请求，包含用户名、认证方式等
   2. 服务器端对客户端进行认证，若失败发送失败信息，包含可再次认证的方法列表
   3. 失败的情况下：客户端从认证方法中选一种再次认证
   4. 直到认证成功或次数达到上限服务器关闭连接为止

   两种认证方式：

   1. password认证：客户端向服务器发送password认证请求并将用户名密码加密后发送，服务器收到解密并比对，返回成功或失败信息
   2. publickey认证：采用数字签名认证。

4. 会话请求：

   认证通过后，客户端向服务器发送会话请求，服务器若成功处理请求就回复SUCCESS包，否则回复FAILURE包

5. 交互会话：

   会话请求通过后，进行双向数据传输，客户端发送加密的命令，服务器接收解密处理命令，将结果加密返回



SFTP：安全文件传输协议。建立在SSH基础上，默认采用加密方式传输数据。

