---
title: LDAP学习笔记
date: 2018-11-24 09:22:47
tags: [LDAP, 验证]
---

* [LDAP概述](#LDAP概述)
* [LDAP简单部署](#LDAP简单部署)



<!--more-->



# LDAP概述

## 目录服务

**目录**是一类为了浏览和搜索数据而设计的特殊数据库，按照**树状**形式存储信息，目的包含基于属性的描述性信息，支持高级过滤功能。

目录不支持大多数事务型数据库支持的高吞吐量和复杂更新操作。**目录服务适合的业务应用于大量查询与搜索操作，而不是大量写入操作。目录服务器还能提供主从服务器同步目录数据功能。**

> DNS就是一个典型的大范围分布式目录服务

目录服务器功能：

* 按照网络管理员指令，强制实施安全策略，保证目录信息安全
* 目录数据库可分布在一个网络的多台计算机上，提高响应速度
* 复制目录，使更多用户可使用目录，提高可靠性和稳定性
* 将目录划分为多个数据源（存储区），以存储大量对象



## X.500

X.500是构成全球分布式的名录服务系统的协议，描述了用户信息的存储和访问方式，X.500不是一个协议，而是一个协议族，包括从X.501到X.525等一系列完整的目录服务协议。X.500采用层次结构（类似DNS）。

X.500相关协议或机制：

* **DAP目录访问协议**：控制服务器和客户端之间的通信
* DSA目录系统代理：用于存储目录信息的数据库，采用分层格式，提供快速高效的搜索功能，与目录信息树DIT连接。**DSA之间通过链操作实现分布式访问。**
* DUA目录用户代理：用于访问一个或多个DSA的用户接口程序
* DSP目录系统协议：控制两个或多个DSA间、DUA与DSA间的交互
* DISP目录信息映像协议：定义了如何将选定的信息在服务器间进行复制
* DOP目录操作绑定协议：定义了服务器间自动协商连接配置的机制
* X.501：模型定义，定义目录服务的基本模型和概念
* X.509：认证框架，定义如何处理目录服务中客户和服务器的认证
* X.511：抽象服务定义，定义X.500提供的服务原语
* X.518：分布式操作过程定义，定义如何跨平台处理目录服务
* X.520：定义属性类型和数据元素
* X.521：定义了对象类
* X.525：定义在多个服务器间的复制操作
* X.530：定义目录管理系统的使用



X.500的OSI模型：

独立的目录信息树DIT，采用层级化节点结构，每个节点都有一个唯一名称标识DN（也称唯一辨别名），唯一名称由相对唯一名称RDN（也称相对辨别名）标识和父节点标识组成。

X.500特征：

* 分散维护：运行X.500的每个站点只负责本地目录，可立刻进行更新和维护
* 搜索性能：X.500有强大的搜索功能，支持用户建立复杂查询
* 单一全局命名空间：为用户提供单一同性命名空间（Single Homogeneous Namespace），类似DNS，但比DNS灵活且可扩展。
* 结构化信息结构：目录中定义了信息结构，允许本地扩展
* 基于标准的目录服务：请求应用目录信息的应用（邮件、资源分配器等）能访问重要且有价值的信息
* 基于OSI协议，需要在会话层和表示层进行许多连接的建立和包处理



## LDAP

LDAP就是活动目录在Linux上的一个实现。

LDAP（Lightweight Directory Access Protocol）轻量目录访问协议，基于X.500标准，支持TCP/IP。

LDAP支持一主多从、多主多从以及分布式。

DAP是一个重量级的协议，在整个OSI协议栈上操作，需要占用大量计算资源，而LDAP设计在TCP/IP上，以小得多的资源消耗实现了大多数DAP功能。LDAP 服务器可当做网关访问X.500服务器，但基本都是在X.500服务器上直接实现LDAP。

{% asset_img 2.png %}

单独的LDAP守护程序slapd，可看做是轻量级X.500服务器。LDAP就是轻量级的DAP。



LDAP与X.500的相同点：

* 都实现了通用的平台结构
* 信息模型上，都使用了项、对象类、属性等概念描述信息
* 命名空间上，都使用了目录信息树结构和层次命名模型
* 功能模型上，都使用了相似操作命令
* 认证框架上，都实现了用户名密码、安全加密认证
* 灵活性上，目录规模都可大可小
* 分布性上，目录信息都可分布在多个目录服务器上，服务器由各组织管理，保证目录信息总体结构一致



LDAP常用名词：

* dc：Domain Component，域名部分，会将完整域名分成几部分。如example.com会分为dc=example,dc=com
* uid：User id，用户ID。最常见的uid是从`/etc/passwd`中转来的条目。
* ou：Organization Unit，组织单位，类似文件系统的子目录，是一个容器对象，可包含其他各种对象。
* cn：Common Name，公共名称。最常见的cn是从`/etc/group`中转来的条目
* sn：Surname，姓
* dn：Distinguished Name，唯一辨别名，类似文件系统的绝对路径，每个对象都有一个唯一名称。
* rdn：Relative dn：相对辨别名，类似文件系统的相对路径，是与目录树结构无关的部分。
* c：Country，国家。如CN、US
* o：Organization，组织。如Inc

{% asset_img 1.png %}



LDAP目录结构与信息：

* 目录数据库以目录信息树DIT为存储方式的。
* DIT由条目（Entry）构成，条目相当于关系数据库中的表的记录。
* 条目又由DN的键值对（Attribute-Value）组成
* LDAP允许通过objectClass来控制哪些属性是条目必须的，objectClass的值是条目必须遵从的方案schema定义的。
* LDAP目录的根称为BaseDN
* ou下是真正的用户条目
* LDAP数据导入导出的格式是LDIF，LDIF是LDAP数据库信息的一种文本格式。



LDAP特点总结：

* 跨平台
* 树型结构，无需SQL语句维护
* 静态数据快速查询
* 使用基于推拉的复制信息技术
* 支持多种安全协议（SASL、SSL、TLS）和多种访问控制
* 支持异类数据存储（存储文件可以是文本或图片）
* C/S模型

LDAP常见应用：

* 数字证书管理、授权管理、单点登录
* 分布式计算环境DCE、统一描述发现与集成协议UDDI
* MAIL、DNS、网络用户管理、电话号码簿
* 内网组织信息服务、电子政务目录、人口基础库



LDAP目录数据文件：

LDIF（LDAP Data Interchange Format，轻量级目录交换格式）是一种ASCII文件格式，能够向目录导入与修改信息。

LDIF文件注意点：

- 空行分割一个条目或定义
- #注释
- 属性: 属性值
- 属性可被重复赋值
- 每行结尾不能有空格
- 每条记录必须有至少一个objectClass属性



### LDAP的配置模式

* 基本的目录查询服务：slapd仅为本地域提供目录服务，不会以任何方式与别的目录服务器交互。

  {% asset_img 3.png %}

* 目录查询代理服务：带有指针（Refferals），类似DNS，若本地的LDAP无法处理，则会返回一个指针，指向更高级的服务器地址。

  {% asset_img 4.png %}

* 异机复制数据，即主从同步：LDAP的slurpd守护进程是用于将slapd上的改变传播到一个或多个从的slapd上。可以通过inotify+rsync方案实现简单的同步。

  {% asset_img 5.png %}



# LDAP简单部署

实验环境：

* Master：192.168.60.134
* Slave：192.168.60.135

要安装的软件：安装的ldap版本2.4

* `openldap`：ldap库
* `openldap-servers`：ldap服务器
* `openldap-clients`：ldap客户端
* `openldap-devel`：ldap开发库与头文件
* `nss`：网络安全服务，类似Openssl，是底层密码库



OpenLDAP的配置目录：`/etc/openldap/`

```
/etc/openldap/
├── certs
├── check_password.conf
├── ldap.conf       # ldap默认的全局配置
├── schema          # 存放LDAP的schema
└── slapd.d         # 存放ldap的配置文件
老版本还有slapd.conf，作为主配置文件，记录根域信息、管理员信息等。2.3以后已不再使用，但目前仍然支持。
```

OpenLDAP 2.3及更高版本已转换为使用动态运行时配置引擎slapd-config

* 完全启用LDAP
* 使用标准LDAP操作进行管理
* 将其配置数据存储在LDIF数据库中，通常位于`/etc/openldap/slapd.d`目录中。
* 允许所有slapd的配置选项在运行中进行更改，通常无需重新启动服务器即可使更改生效。

OpenLDAP监听的端口：

* 389：默认监听端口，是传输明文数据的
* 636：加密监听端口，默认启动时不开启，是传输密文数据的



OpenLDAP的配置文件目录结构：`/etc/openldap/slapd.d`

```
slapd.d/
└── cn=config
    └── cn=schema
```

slapd-config配置树具有非常特定的结构。 树的根名为`cn = config`并包含全局配置设置。`cn = config`中包含的指令通常适用于整个服务器。 其中大多数是面向系统或连接，而不是数据库相关。 此条目必须具有`olcGlobal`的objectClass。





> 参考资料
>
> Linux服务器架设指南
>
> Linux就该这么学
>
> Linux企业应用案例精解
>
> Linux系统管理大全
>
> 百度百科——X.500
>
> 百度百科——LDAP