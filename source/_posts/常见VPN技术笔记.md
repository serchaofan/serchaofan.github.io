---
title: 常见VPN技术笔记
date: 2018-06-18 09:00:37
tags: [vpn,网络]
---
**华三网络学习笔记（理论）**

本篇包含以下知识点
* [VPN概述](#VPN概述)
* [GRE-VPN](#GRE-VPN)
* [L2TP-VPN](#L2TP-VPN)
* [IPSEC-VPN](#IPSEC-VPN)
  * [GRE-OVER-IPSEC](#GRE-OVER-IPSEC)
  * [IPSEC-OVER-GRE](#IPSEC-OVER-GRE)
* [MPLS](#MPLS)
* [BGP-MPLS-VPN](#BGP-MPLS-VPN)
* [SSL-VPN](#SSL-VPN)
<!-- more -->

## VPN概述
Virtual Private Network虚拟私有网，利用共享公共网络仿真WAN设施，构建私有的专用网络。基于IP的VPN体系的核心是使用Tunnel隧道技术。

**VPN的优势**
* 快速构建，降低部署周期
* 与私有网络一样的安全性、可靠性与可管理性
* 提高了基础资源的利用率
* 简化了用户端的配置和维护工作

{% asset_img 1.png %}

**概念术语**
* 承载协议：在公网传输时使用的协议
* 封装协议：用于标识承载协议中封装的数据包，放置在承载协议头与载荷协议头间
* 载荷协议：最初封装数据包的协议
* 隧道协议：决定如何实现隧道的协议

{% asset_img 2.png %}

**主要VPN技术**
L2 VPN技术
* L2TP VPN：二层隧道协议，可实现拨号VPN与专线VPN
* PPTP VPN：点到点隧道协议，支持PPP在IP网络上的隧道封装，使用增强GRE技术为传输的PPP报文提供流控与拥塞控制的封装
* MPLS L2 VPN：多协议标签交换
L3 VPN技术
* GRE VPN：通用路由封装，可在任意协议中封装任意协议的封装方法
* IPSEC VPN：IP安全，并不是单个协议，而是一系列协议组成的数据安全体系，包括AH、ESP、IKE等，实现对数据私密性、完整性保护与源校验
* BGP/MPLS VPN：多协议BGP，利用MPLS与MP-BGP技术
* SSL VPN：安全套接字层，使用SSL协议实现远程VPN

## GRE-VPN
Generic Routing Encapsulation通用路由封装，是一种能在任意协议中封装任意协议的封装方法，可以直接使用GRE封装建立GRE隧道，为IP协议，协议号47。以下为
GRE封装包的格式。

{% asset_img 3.jpg %}

GRE头包含了2字节的`Protocol Type`，用于指示载荷协议类型，`IP`协议为`0x0800`。此外还有扩展GRE头，增加了`Key`和`Sequence Number`，具备标识数据流和分组次序的能力。
IP协议使用协议号47标识GRE头，说明IP头后跟着GRE头。而GRE头中protocol type若为0x0800，说明GRE头后跟着IP头。

{% asset_img 4.png %}

双方通过Tunnel接口（逻辑接口）建立隧道，再通过实际物理接口进行转发。tunnel口为载荷协议服务，物理口为承载协议服务。
{% asset_img 5.png %}

GRE隧道通信过程：
1. 隧道起点路由查找：隧道两端的路由器必须是私网边界路由器。收到数据包时查找ip路由表
2. 加封装：查找路由表确认下一跳为tunnel口，则进行GRE封装。
3. 承载协议路由转发：对封装后的包进行公网路由查询。
4. 中途转发：即公网转发
5. 解封装：到达对端私网边界路由器后，该路由器检查IP地址，若是自己则解开IP头，发现有GRE头，就交给目标Tunnel口，tunnel口解开GRE头
6. 隧道终点路由转发：解开GRE头后，发现私网IP目的地址，然后查表转发。

每个运行GRE的路由器只有一个路由表，公网和私网之间只能通过不同的路由加以区分，因此公网私网IP地址能重复，且公网私网必须采用不同策略。
* 连接到私网的物理接口和Tunnel口属于私网路由AS，采用一致的私网路由策略。
* 连接到公网的物理接口属于公网路由AS，必须和公网采用一致的路由策略。

优点：
1. 支持多种协议  
2. 支持IP路由协议和组播 

缺点：
1. 点对点隧道  
2. 静态配置隧道  
3. 缺乏安全性  
4. 不可分配地址空间  
5. 部署复杂

静态路由配置：配置到达目的IP的私网网段路由，下一跳为对端Tunnel口的地址。
动态路由配置：将隧道和私网作为一个AS看待，动态路由需要将Tunnel口和私网都包括。

Tunnel口虚假状态：GRE本身不对隧道状态维护，系统默认根据接口状态设置Tunnel状态，即若物理链路中出现故障，物理口仍为UP，则隧道口也为UP，而此时隧道却不通。只存在于静态配置时。
解决：tunnel口keepalive机制：允许路由器探测隧道口的实际状态。路由器会从tunnel口周期发keepalive消息，默认周期10s，若连续3次未收到，则认为隧道不通，会自动删除该tunnel口为出接口的静态路由。

## L2TP-VPN
对PPP协议链路提供隧道，允许二层链路端点和PPP会话点驻留在不同设备上，并采用分组交换技术进行信息交互。使用PSTN/ISDN拨号、xDSL直接连接到ISP位于本地的POP（存在点），或直接连接到Internet获得IP通信服务，然后ISP设备或用户设备建立L2TP通道连接对端。

L2TP特点：
* L2TP支持对用户和隧道的验证，和对客户端的动态地址分配。可使用PPP验证，也可使用LAC提供的AAA验证
* 具备点到网络特性。适合单个或少量接入
* 不提供加密，但可结合IPSec等加密
* 面向连接，为信息提供一定的可靠性

L2TP组件：
* LAC：L2TP访问集中器，隧道就在LAC和LNS间建立
* LNS：L2TP网络服务器
* NAS：网络访问服务器，抽象概念，是远程访问的接入点，可以是LAC或LNS

两种拓扑方式：
1. 独立LAC：ISP提供LAC，不依赖IP接入点。
条件：ISP支持L2TP，验证系统支持VPDN属性
特点：终端用户不需要配置VPN拨号软件，只需要执行普通拨号，登录一次就可以接入企业网。
2. 客户LAC：远程系统安装VPDN客户端，直接对LNS发起连接请求。不依赖LAC，验证只能由LNS执行
条件：远程系统必须接入Internet，远程系统需要安装专用客户端软件并配置
特点：只需配置VPN软件即可与企业网建立VPN连接。对用户的验证只能由LNS端执行。

L2TP封装：
L2TP以UDP/IP为承载协议，UDP端口号为1701。
{% asset_img 6.png %}
L2TP头中`Type`字段标识消息类型，若为1表示控制消息，若为0表示数据消息。
`Tunnel ID`字段标识L2TP控制连接，即隧道标识符，是在隧道建立时通过`Assigned Tunnel ID AVP`交换的。
`Session ID`字段用于标识一个隧道中的各个会话，是在隧道建立时通过`Assigned Session ID AVP`交换的。
> 控制连接：在L2TP隧道内部，建立维护和释放会话与隧道
控制消息：LAC与LNS间交换的隧道内消息，用于对隧道操作。包含AVP（属性值对，通过发送AVP对隧道建立维护或释放，即管理隧道和会话）

L2TP协议操作：
1. 建立控制连接：由PPP触发
（1）LAC使用任意UDP端口向LNS的UDP1701端口发起连接（`SCCRQ`打开控制连接请求）
（2）LNS将连接重定向到一个随机UDP端口并回应（`SCCRP`打开控制连接应答）
（3）LAC收到后返回确认（`SCCCN`打开控制连接已确认）
（4）LNS收到后再确认，隧道建立（`ZLB`零长度体）
若要执行隧道验证，可在`SCCRQ`或`SCCRP`中加上`Challenge AVP`（挑战AVP）发起验证，接收方要在回应中加上`Challenge Response AVP`（挑战响应AVP）。
2. 建立会话：前提为控制连接的建立。由PPP模块触发
LAC发起：
（1）LAC向LNS发送`ICRQ`（入呼叫请求）发起会话建立
（2）LNS收到请求后返回`ICRP`（入呼叫应答）
（3）LAC收到应答后返回`ICCN`（入连接已连接）
（4）LNS再回应`ZLB`，会话建立
LNS发起：
（1）LNS发送`OCRQ`（出呼叫请求）发起会话建立
（2）LAC收到后返回`OCRP`（出呼叫应答）
（3）LAC执行呼叫，返回`OCCN`（出呼叫已连接）
（4）LNS收到后回应`ZLB`，会话建立
会使用`Tunnel ID`和`Session ID`区分不同隧道和会话
3. 隧道状态维护
LAC与LNS互发`Hello`消息维持会话，默认周期60s，若三次未收到对方的Hello消息，则认为隧道断开。
4. 关闭会话与控制链接
关闭会话：
（1）LAC发送`CDN`（呼叫断开通知），通知LNS关闭会话
（2）LNS收到后返回`ZLB`，并关闭会话
关闭控制连接：
（1）LAC发送`StopCCN`（停止控制连接通知），通知LNS关闭控制连接
（2）LNS收到后回应`ZLB`，并关闭控制连接
5. L2TP验证
  1.对拨入的远程系统PPP验证
  2.LAC与LNS间隧道验证
  3.LNS对远程系统再次PPP验证。方式分为三种：
	1）代理验证：LAC将从远程系统得到的验证信息和自身的验证信息都发给LNS
	2）强制CHAP验证：LNS直接对远程系统进行CHAP验证
	3）LCP重协商：LNS与远程系统重新进行LCP协商，采用相应虚拟模板接口上配置的验证方式进行验证

LAC端对远程系统用户的AAA验证包括：
* 本地验证：需要LAC端配置本地用户名、密码、服务类型等信息，与用户输入的通过对比进行验证。
* 远程验证：需要与RADIUS或TACACS服务器协同验证，需要在RADIUS或TACACS服务器上配置用户验证信息，LAC将用户输入的信息发送给验证服务器进行验证。

<center>下图为：独立LAC隧道会话建立</center>
{% asset_img 7.png %}

<center>下图为：客户LAC隧道会话建立</center>
{% asset_img 8.png %}

## IPSEC-VPN
一种网络层安全保障机制。可实现访问控制、机密性、完整性校验、数据源校验、拒绝重播报文等。IPSec是可扩展的体系，不受限于任何一种特定算法，可引入多种验证算法、加密算法、密钥管理机制。
缺点：复杂，消耗大量资源、数据延迟、点对点、不支持组播

### IPSec SA
IPSec SA：IPSec安全联盟，安全服务通过SA实现。
SA是双方的安全协定，包括协议、算法、密钥。SA是单向的，入站和出站数据流分别由入站SA和出站SA处理。

SA的三元组：
1. SPI：安全参数索引，32位数值
2. IP目的地址：对方IP地址
3. 安全协议标识符：标识AH或ESP

SA建立方式：
1. 手工配置：两端手动设置参数
2. 自动协商：双方通过IKE生成维护

SA具有生存时间，有两种方式：
1. 时间：每隔定时长更新SA
2. 流量：每传输一定流量更新SA

SA协商信息存放在SPD（安全策略数据库），SPD的项指向SAD（安全联盟数据库）相应项

### IKE
IKE：因特网密钥交换。基于UDP协议，端口号500，为IPSec提供自动协商交换密钥、建立SA服务，实际提供安全服务的是IPSec，采用DH算法交换密钥（精髓）。且可以定时更新密钥和SA，提供了完善的前向安全性。可以为IPSec自动重新建立SA，允许IPSec提供抗重播服务（通过SPI值）。

采用ISAKMP的密钥交换框架体系
**IKE安全机制：**
1. 身份验证：预共享密钥（默认）、RSA数字签名、DES数字签名
2. DH密钥交换
3. PFS完善前向安全性：通过在第二阶段再进行一次DH交换，使IKE SA密钥与IPSec SA密钥无派生关系

**协商两个阶段：**
* 阶段1：建立一个IKE SA，为阶段2提供保护
分为主模式main和野蛮模式aggressive

主模式：强制实现的阶段1交换模式。共三步，六条消息
1. 策略协商：A向B发送本地IKE策略，B查找匹配的策略，并确认
其中协商属性包括：加密算法，散列算法（MD5、SHA等），验证方法（预共享密钥、DSS、RSA），DH组信息（默认MODP 768），DH公共值，IKE生存时间，身份信息
2. DH交换：A向B发起密钥生成信息，B生成密钥并回应。
3. ID交换验证：A向B发送身份和验证数据，B回应身份验证。
{% asset_img 13.png %}

野蛮模式：远程拨号时，由于拨号用户IP无法确定，可以使用野蛮模式
1. A向B发送本地IKE策略，开始DH交换
2. B查找匹配策略，回应验证信息
3. A接收确认信息并验证，生成密钥，向B发送验证载荷
4. B验证
{% asset_img 14.png %}

* 阶段2：在IKE SA的保护下完成IPSec SA的协商。采用快速模式

> 野蛮模式安全性差于主模式，但过程简单快速。
在不知道对端IP且需要使用预共享密钥的情况下，必须用野蛮模式。

### IPSec包处理流程
**出站包处理：**
1. 查找SPD，三种结果：丢弃、旁路安全服务：直接转发、提供安全服务：查找IPSec SA
2. 若第一步结果是提供安全服务，就在SAD中找IPsec SA，若找到就根据参数提供安全服务，若找不到就查找IKE SA
3. 若找到IKE SA，就只要创建IPSec SA，若找不到IKE SA，就要先创建IKE SA，再创建IPSec SA。

**入站包处理：**
1. 检查目的地址是否本地，若是则检查数据包是否被IPSec保护
2. 若被IPSec保护，则查找IPSec SA，若不被IPSec 保护，则交给上层
3. 若找到IPSec SA，则解封装，若未找到则丢弃

### 安全协议
* AH：验证头，提供完整性保护、数据源验证、抗重播服务。不支持机密性保护。IP协议，协议号51。
  AH头格式：
    `Next Header`：8位，指示AH头后的载荷协议类型
    `Payload Length`：8位，指示AH的长度并减2，单位为32位
    `SPI`：32位任意数值，用于和目的IP地址和安全协议标识结合，唯一标示一个SA
    `Sequence Number`：32位无符号整数，SA建立时为0，随着数据包发送而增大，接收方通过该值确定数据包的序列
    `Authentication Data`：包含该数据包的完整性校验值`ICV`（使用HMAC算法对IP头+AH头+载荷+共享密钥加密计算），变长且必须是32位的整数倍。AH强制实现`HMAC-MD5-96`和`HMAC-SHA-1-96`两种验证算法
* ESP：封装安全载荷，有AH所有功能且支持加密。包含ESP头和ESP尾。IP协议，协议号50。
  ESP头格式：
    `Next Header`：同上。强制包含。
    `SPI`：同上
    `Sequence Number`：同上
    `Payload Data`：`Next Header`描述的数据，即载荷数据，长度为字节的整数倍。若加密，ESP强制实现了基础加密算法DES-CBC。强制包含。
    `Padding`：填充，使载荷数据达到指定长度。
    `Pad Length`：填充长度，范围为0到255。强制包含。
    `Authentication Data`：ICV，长度由验证算法决定。可选，验证服务开启时才包含。同样强制实现`HMAC-MD5-96`和`HMAC-SHA-1-96`
  ESP尾格式：`Padding`、`Pad Length`、`Next Header`

IPSec有两种工作模式：
* 传输模式：保护端到端安全，两个终端间直接运行IPSec，所有加解密、协商都是**端系统**完成，网络设备完全不参与IPSec，只进行正常路由转发。
* 隧道模式：保护站点到站点安全，两个**安全网关**间运行IPSec，整个数据包都计算AH或ESP头，AH或ESP头加上数据都被封装在一个新的IP包中。所有加解密、协商都是安全网关完成，终端主机不参与。

因此AH和ESP对两种工作模式分别有封装的方式：
* **AH**
  * **传输模式**
  原IP包、AH头与密钥通过散列函数（如RSA）生成校验值。
  将校验值封装在AH头中，再由TCP和原IP头封装。
  {% asset_img 9.png %}

  * **隧道模式**
  新IP头（根据隧道起点终点建立隧道IP头）、AH头与原IP包生成校验值。
  将校验值封装在AH头中，封装原IP包，再用新IP头封装。
  {% asset_img 10.png %}

* **ESP**
  * **传输模式**
  原IP包（不包括原IP头）、ESP尾与密钥加密（通过DES等算法）生成密文。
  将生成的密文与ESP头和验证密钥通过数字签名算法（通过RSA）生成校验值。
  最后将用ESP头和原IP头封装密文和校验值。
  {% asset_img 11.png %}

  * **隧道模式**
  将整个原IP包、ESP尾、加密密钥通过加密算法（如DES）生成密文。
  将密文与ESP头和验证密钥通过散列函数（如RSA）生成校验值。
  用ESP头和新IP头封装密文和校验值。
  {% asset_img 12.png %}

### GRE-OVER-IPSEC
使用`Gre Over IPsec`的原因：GRE不保证数据机密性与完整性，不能数据源验证。

| 特性       | GRE    | IPSec  |
| ---------- | ------ | ------ |
| 多协议     | 支持   | 不支持 |
| 虚接口     | 支持   | 不支持 |
| 组播       | 支持   | 不支持 |
| 路由协议   | 支持   | 不支持 |
| IP协议族   | 支持   | 支持   |
| 机密性     | 不支持 | 支持   |
| 完整性     | 不支持 | 支持   |
| 数据源验证 | 不支持 | 支持   |

封装：原始IP包被封装在GRE隧道包中。GRE隧道包被封装在IPSec包中。

{% asset_img 15.png %}

### IPSEC-OVER-GRE

## MPLS
Multi Protocol Labal Switching：多协议标签交换
MPLS使用定长标签封装网络层分组。标签位于数据链路层和网络层之间，称为2.5层。
多协议指：MPLS被多种二层协议封装，也可封装多种三层协议

两种工作模式：
1. 帧模式：用于PPP、以太网、帧中继  
2. 信元模式：作用于ATM

组成：
1. LSR：位于MPLS内部的核心交换机或路由器，提供标签交换和分发  
2. LER：位于MPLS网络边缘，提供标签映射、移除和分发

FEC：转发等价类，转发过程中以等价方式处理的一组数据分组，可根据IP地址、隧道、COS标识创建FEC
LSP：标签交换通道，属于同一个FEC的数据流在每个节点赋予一个确定的标签，按照一个确定的标签转发表项进行转发，每个FEC流会有固定的转发路径，该路径就成为该FEC的LSP

MPLS标签：4个字节。分为四个字段
1. Label：标签值，20位，标签转发表的关键索引
2. EXP：标识QoS优先级，3位
3. S：栈底标识，1位，若为1说明是最后一个标签，若为0说明后面还有MPLS标签。可实现多层MPLS标签嵌套
4. TTL：存活时间，8位，每经过一台LSR，TTL就减1
{% asset_img 16.png %}

链路层协议为MPLS分配的标识：
1. PPP：0x0281
2. 以太网或HDLC：0x8847
3. 帧中继：0x0080

标签分配协议：用于在LSR间分配标签，建立LSP。有以下四种：
1. LDP标签分发协议：最通用
2. CR-LDP基于路由受限的标签分发协议：可进行路由约束、QoS，用于流量工程
3. RSVP-TE基于流量工程扩展的资源预留协议：用于流量工程中MPLS标签分配
4. MP-BGP多协议扩展BGP协议：为BGP路由分配MPLS标签

LDP消息类型：
1. 发现`Discover`消息：LDP邻居的发现维护
2. 会话`Session`消息：LDP邻居会话的建立维持与终止
3. 通告`Advertisement`消息：向LDP邻居宣告Label、地址等信息
4. 通知`Notification`消息：向LDP邻居通知事件或错误

> 所有LDP消息都采用TLV结构，具有扩展性（TLV：Type-Length-Value 类型-长度-值）

LDP会话建立维护：
1. 邻居发现：互发`Hello`消息，组播地址`224.0.0.2`，UDP端口646
2. TCP连接：LSR-ID大的，即IP地址大的一方主动发起，TCP端口646
3. 会话建立：Master发出初始化Initialization消息，携带协商参数。协商成功Session建立
4. 会话维持：互发Keepalive消息维持会话。LSR之间发送Label mapping消息，形成标签转发表。期间若收到任何差错消息都会关闭会话，断开TCP连接。

LDP邻居状态机：
**两台LDP邻居间建立`LDP Session`后，状态会维持在`Operational`**
{% asset_img 17.png %}

标签分配过程：
上下游根据数据转发方向而定。`LDP Session`建立后路由器根据路由表分配标签，生成MPLS标签转发表
标签转发表包含：入标签`IN`，出标签`OUT`，出接口`next-hop`
标签为随机生成，16以下系统保留

标签分配模式：
1. DOD下游按需标记分配：上游LSR向下游LSR发送标签请求信息。下游LSR为此FEC分配标签，通过标签映射消息反馈给上游LSR。原则：下游设备需要收到上游的标签请求才能分配标签
2. DU下游自主标记分配：下游LSR在LDP会话建立后主动向上游LSR发布标签映射消息，不需等待上游请求

标签控制模式：
1. 有序：只有最下游设备能分发标签，上游设备只有收到了下游的标签映射消息，才能再向上游发送标签映射信息。使得MPLS的转发是端到端的
2. 独立：不管是不是最下游，不管是否收到下游的标签映射信息，都向上游发送标签映射信息。任何的数据流经过MPLS网络都可进行MPLS转发

标签保持方式：收到下游的标签映射后，是否记录标签信息的原则
1. 保守：只保留下一跳邻居的标签，丢弃所有非下一跳邻居发来的标签
  优点：节约空间
  缺点：当网络故障时，LSP收敛较慢
2. 自由：保留来自邻居的所有标签。
  优点：网络故障后，路由切换时收敛快
  缺点：消耗空间

> 常用组合：DU + 有序 + 自由

**MPLS转发：**
第一阶段：标签PUSH：报文进入MPLS网络，LER设备发现报文目的IP地址有关联的标签，对报文进行压标签。该报文就变为了MPLS报文
第二阶段：标签SWAP：报文在MPLS网络内进行标签交换。
第三阶段：标签POP：报文转出MPLS网络时，在最后一跳弹出标签。倒数第二跳的设备上标签表的出标签为3，说明此为倒数第二跳。一旦包查找到出标签为3，就直接弹出标签。

## BGP-MPLS-VPN
解决了传统VPN的问题：1.实现隧道动态建立  2.解决本地地址冲突问题  3.VPN私网路由易于控制

### 多VPF组网
多VRF技术用于解决同一台设备（PE）上地址冲突问题。
存在以下路由器角色：
* CE：直接与ISP相连的用户设备
* PE：公网边缘路由器，与CE相连，负责VPN接入
* P：公网核心路由器，负责路由与快速转发

实现：将一台路由器划分为多个VRF，每个VRF相互独立，拥有各自的路由表、端口、协议，每个VRF类似一台虚拟路由器。未划分VRF的路由在公网路由表中。各个VRF与各自的网络运行一个实例，该实例学到的路由只能加入该VPN路由表。实例与所属VPN进行绑定。并且，端口与VPN绑定，与VRF绑定的接口只会出现在该VRF对应的路由表中，当报文从该接口进入路由器后只能查询该VRF对应的路由表。确保了不同VRF数据间不会冲突。
{% asset_img 18.png %}

多VRF与路由协议多实例：各VRF与各自用户网络之间运行一个路由实验，该路由实例学习到的路由只能加入该VPN的路由表。各个路由实例与所属VPN绑定，互相独立，只能学到各自的邻居信息。

### MP-BGP
MP-BGP（Multi　Protocol BGP，多协议BGP）是对BGP根据特性（TCP连接、TLV扩展属性位）进行扩展的协议。
MP-BGP相对于BGP的新增特性：
* 普通BGP只能传递IPv4信息，MP-BGP能承载多个协议路由信息。
* 新增了`MP_REACH_NLRI`和`MP_UNREACH_NLRI`两个属性，并新增了扩展团体属性（Extended_Communities）。
* MP-BGP可传递BGP MPLS VPN、L2VPN、6PE等路由信息。

> `MP_REACH_NLRI`和`MP_UNREACH_NLRI`两个属性都是路由更新消息属性。
`MP_REACH_NLRI`代替了原BGP更新消息中的`NLRI`和`Next-hop`。增加了地址族的描述Address-Family、私网Label和RD，包含原有的Next-hop。
若地址族描述为VPNv4，则NLRI包含两个部分，一个是私网标签（一个MPLS标签），第二部分是VPNv4地址（RD+IPv4地址）
`MP_UNREACH_NLRI`代替了原BGP更新消息中的`Withdrawn Routes`。可撤销通过`MP_REACH_NLRI`发布的各种地址族的路由。包含`Address-Family`和`Withdrawn Routes`。

**VPNv4地址族主要用于PE路由器间传递VPN路由，并只存在于MP-BGP路由信息和PE设备的私网路由表中，即只出现在路由的发布学习过程中，在穿越ISP公网时，数据包头是没有VPNv4地址的。**

<center>下图为MP_REACH_NLRI属性</center>
{% asset_img 20.png %}
<center>下图为MP_UNREACH_NLRI属性</center>
{% asset_img 21.png %}

BGP的扩展团体属性：RT（Route Target）路由目标。本质是每个VPN实例表达自己的路由取舍方式。
RT的格式有三种，都表示RT。
{% asset_img 22.png %}
* `0x0002`：2字节的AS号，加上4字节的用户自定义数字，如`100:1`、`200:1`
* `0x0102`：4字节的IP地址，加上2字节的用户自定义数字，如`192.168.1.1:1`、`10.1.1.1:2`
* `0x0202`：4字节的AS号，加上2字节的用户自定义数字

>　通常设置为冒号后的数字设置为VPN实例编号。

RT由两个部分组成：`Export Target`和`Import Target`。MP-BGP在PE间交互私网路由时，需要遵循以下规则：
* 在PE设备上，发送某一个VPN用户的私网路由给BGP邻居时，需要在扩展团体属性区域中增加该VPN的`Export Target`属性。
* 在PE设备上，需要将收到的MP-BGP路由的扩展团体属性中携带的RT值与本地每个VPN的`Import Target`对比，若存在交集，则可以将该路由添加进实例的路由表。

通过对RT的操作可实现两种模式：`Hub-Spoke`和`Extranet`。
`Hub-Spoke`模式：用户总部可与每个分布互通，但每个VPN分布之间禁止互通。
`Extranet`模式：使指定的节点可以与其他节点互通。
{% asset_img 23.png %}

RD（Route Distinguisher）路由区分。本质就是用于私网路由的撤销，因为在撤销路由时是不能携带属性值的（包括RT），PE在删除路由时无法判断撤销哪个VPN的路由。长度6字节。
RD有两种格式：
* 2字节的AS号，加上4字节用户自定义数，如`100:1`
* 4字节的IP地址，加上2字节用户自定义数，如`192.168.1.1:1`

只要保证存在相同地址的两个VPN实例的RD不同即可，但最好为每个VPN实例配置一个RD。若两个VPN实例中存在相同IP地址，则这两个实例一定不能互访，间接互访也不行。

私网标签Label，用于帮助PE判断该报文前往的VPN，是通过MPLS的多标签嵌套实现的。

BGP MPLS VPN实现分为以下步骤：
* 公网隧道建立：公网IGP协议开启，PE间互通。
* 本地VPN建立：PE上设置本地VPN并设置RD、RT属性，然后将VPN与接口绑定，即配置VRF。
* 私网路由的学习：PE与CE间运行路由协议多实例，各VPN实例进行路由学习。PE间建立MP-BGP邻居，下游LSR分配标签，建立标签转发表。并会生成一条MP-BGP更新消息，包含VPNv4路由前缀（即IP地址）、下一跳地址、RT属性、私网标签。PE设备会对比RT值，若通过就会记录该路由信息并发布给本地VPN。
* 私网数据转发：数据会根据标签转发表进行转发。