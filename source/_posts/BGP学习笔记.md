---
title: BGP学习笔记
date: 2018-07-31 09:19:44
tags: [BGP,网络]
---

**基于华三网络学习笔记（理论）**

本篇包含以下内容

* [BGP特性与基本术语](#BGP特性与基本术语)
* [BGP消息与状态机](#BGP消息与状态机)
* [BGP路由属性](#BGP路由属性)
* [BGP选路规则](#BGP选路规则)
<!-- more -->

## BGP特性与基本术语
Border Gateway Protocol边界网关协议。用于自治系统间，进行不同AS间路由传递。
* 路径矢量路由协议
* 基于TCP，端口号179
* EGP协议，优先级255
* 支持路由聚合与CIDR
* 只发送增量路由
* 路由信息中携带经过的所有AS路径表
* 支持CIDR和路由聚合
* 丰富的路由属性、强大的路由过滤和路由策略
* 可传输大量路由（基于TCP的可靠传输和滑动窗口）
* 只能点对点连接（TCP的点对点）

**基本术语**
* BGP发言者：发送BGP消息的路由器
* Router ID：32位，在AS中唯一标识一台主机，必须配置
* BGP对等体Peer：相互交换消息的BGP发言者互为对等体，也可称BGP邻居。
  * IBGP对等体：处于同一AS的对等体，不需要直连
    **从IBGP获得的路由不会向其他IBGP邻居发布（为了防环）
    从IBGP获得的路由是否发个EBGP邻居与是否同步有关（为了防止路由黑洞）**
    全连接：为解决部分连接导致的无法学习路由，每两个路由器都建立IBGP邻居则可以保持AS内的所有BGP路由器路由信息相同
  * EBGP对等体：处于不同AS的对等体，且通常要求直连
    从EBGP获得的路由会发布给所有IBGP邻居
    EBGP的TTL=1，所以只能是直连对端接口，不可跨设备（可修改TTL实现跨设备）
    而IBGP的TTL=255可与AS内任意BGP路由器建邻居

BGP防环：
1. 对于EBGP：使用AS-PATH
2. 对于IBGP：禁止将从IBGP邻居学到的路由发布出去。缺点：有路由器学不到路由。解决：全连接

BGP同步：IBGP与IGP之间同步，避免转发黑洞。收到IBGP邻居发布的路由后，会查看该路由是否在IGP表中，只有IGP表中存在，才会置为有效并发布，否则无效不发布。路由器默认关闭同步。

## BGP消息与状态机
BGP所有消息都是消息头+消息体，消息头长度19字节，包含以下字段：
* Marker：16字节，用于BGP验证的计算，不使用验证时所有位都置为1
* Length：2字节，BGP消息总长度（包括报文头）
* Type：1字节，BGP消息的类型，取值为1到5，分别表示Open、Update、Notification、Keepalive、Route-Refresh

BGP消息种类：
1. Open：用于建立BGP邻居。TCP连接后的第一个消息，进行参数协商。包含以下字段：
  * BGP版本
  * AS号
  * routerID
  * Hold Time：保存时间，若超时仍未收到对端的Keepalive或Update消息，则认为BGP连接中断。建立对等体时要协商该参数并保持一致
  * 认证信息或多协议扩展等功能
2. Update：在邻居间交换路由信息（发布或撤销）。可通告一类相同属性的可达路由和不可达路由。包含以下字段：
  * 不可达路由字段长度。单位字节，若为0表示没有`Withdrawn Routes`
  * Withdrawn Routes不可达路由列表，即存放被撤销的路由
  * 路径属性字段长度。单位字节，若为0表示没有`Path Attibutes`
  * Path Attibutes，存放与NLRI相关的所有路径属性列表，每个路径属性由一个TLV三元组构成。
  * NLRI可达路由的前缀和前缀长度二元组，存放一类相同属性的可达路由
3. Notification：错误通知（消息错误或断开BGP连接）。包含以下字段：
  * 差错码，指定错误类型
  * 差错字码，提示错误类型的详细信息
  * 数据，出错部分的数据。用于辅助发现错误的原因，依赖于差错码和差错子码
4. Keepalive：维护邻居关系或对Open消息回应。只有消息头。周期发送，默认周期30s。
5. Route-refresh：要求对等体重新发送指定地址族的路由

BGP状态机：
1. Idle：空闲。初始状态，等待Start事件。一旦有Start，就向邻居发起TCP建立请求
2. Connect：连接。等待TCP建立完成。若TCP完成，状态改为Open-sent。若失败，状态改为Active。
3. Active：活跃。TCP未成功建立。若超时，会返回Connect。若成功，进入Open-sent状态。
4. Open-sent：Open消息已发送。已发出Open消息，等待邻居的Open消息。若收到邻居的Open消息且无错误，进入OpenConfirm状态，并发送Keepalive。否则，进入Notification。
5. OpenConfirm：Open消息已确认。Keepalive已发送，等待邻居的Keepalive。若收到邻居的Keepalive，则进入Established状态。若收到Notification，则断开连接
6. Established：BGP连接建立。可发送Update交换路由，发送Keepalive维护连接，若收到Notification则断开连接

{% asset_img 1.png %}

## BGP路由属性
1. 公认必遵属性：BGP路由器必须识别，必须存在于Update
  * ORIGIN：定义路由信息来源
    类型：IGP--路由产生于AS内   EGP--路由通过EGP学到  Incomplete--路由来源不确定
    **优先级：IGP>EGP>Incomplete**
  * AS_PATH：路由更新经过的AS路径列表，保证AS间无环。可用于路由选择和过滤
    当BGP将一条路由通告到其他AS时，会把本地AS号添加到AS-PATH最前
    优先选择AS-PATH最短的路由。
    若向EBGP邻居发送路由更新修改，IBGP间不修改
  * NEXT_HOP：路由下一跳
    向邻居发布路由时，会将下一跳设为自己与对端连接的端口
    从EBGP邻居得到的路由发给IBGP邻居时，不会修改下一跳
2. 公认可选属性：BGP路由器必须识别，不必须存在于Update
  * LOCAL_PREF：用于IBGP选择**离开AS时**的路由，表明BGP路由器的优先级
    仅在IBGP对等体间交换。默认值100
3. 可选传递属性：在AS间可传递，路由器可不支持，仍可接收并通告
  * COMMUNITY
  * AGGREGATOR
4. 可选非传递属性：若BGP路由器不支持，属性会被忽略，且不通告
  * MED：度量值。告诉EBGP邻居**进入AS**的路由。
    仅在相邻AS间交换，收到MED的AS不会再通告给其他AS
    通常只比较来自同一AS的MED
5. 私有BGP属性：
  * Preferred-value：对从邻居学习到的路由分配优先级
    本地有效，不通告。初始为0

对于BGP路由处理：
1. 接收BGP路由
2. 路由过滤、属性设置
3. 路由优选
4. 发布策略
5. 发布路由过滤、属性设置、路由聚合

## BGP选路规则
路由选路优先级（高到低）：
1. 丢弃下一跳不可达的路由
2. Preferred-value选大
3. LOCAL_PREF选大
4. 聚合路由，本地路由
5. AS_PATH选小
6. ORIGIN按优先级选
7. MED选小
8. 依次选从EBGP、联盟、IBGP学到的路由
9. 下一跳度量值最低
10. CLUSTER_LIST选短
11. ORIGINATOR_ID最小
12. RouterID最小路由器发布的路由
13. 地址最小的邻居发布的路由

BGP一定能选出唯一的最优路由，且可以负载分担
路由下一跳不一定是直连邻居，原因：IBGP发布路由不改变下一跳。路由器会查找直连可达地址，到达要发布路由的下一跳（去往该下一跳的路由为依赖路由，过程为路由迭代）。路由器支持基于迭代的负载分担。

BGP路由发布策略：
* 只发布最优路由
* 只发布自己使用的路由
* 发布所有从EBGP邻居学到的路由给所有BGP邻居（IBGP和EBGP）
* 不把从IBGP邻居学到的路由发布给IBGP邻居
* IBGP路由发到EBGP：BGP同步关--直接发布。BGP同步开--IGP也发布时才发布
* **BGP连接建立后，发布所有BGP路由**

BGP下一跳原则：
若从EBGP邻居学到的路由传给IBGP邻居时下一跳不变，可能会导致BGP设备因为下一跳不可达而不加入路由表。解决：应在EBGP路由传给IBGP邻居时将下一跳改为自身

BGP路由不优的原因：1.同步打开，但网络不满足同步要求   2.下一跳不可达

BGP源IP地址原则：BGP设备收到一个BGP报文，会检查报文源IP地址，若与peer所指IP地址一致，则设备接收该报文，若不一致，则丢弃报文，在建环回口建立BGP关系时，要修改BGP报文源

默认情况，BGP使用到达对等体的最佳路由作为出接口作为与对等体建TCP连接的源接口
将建立TCP的源接口配置为环回口，在网络中存在冗余链路时不会因为某个接口或链路故障而使BGP，提高了可靠性和稳定性

### 控制BGP路由
常用属性：`preferred-value`、`Local-preference`、`MED`、`next-hop-local`
路由首选值`Preferred-value`：优选大的。默认从对等体学来的路由首选值为0
本地优先级`Local-preference`：判断离开AS的最佳路由
AS路径过滤表`AS_PATH list`：一个基于AS表的ACL，使用正则表达式对路由携带的AS路径属性域进行匹配

正则表达式：
* `^` 匹配字符串的开始
* `$` 匹配字符串的结束
* `*` 匹配`*`前的字符（串）0或多次
* `+` 匹配+前的字符（串）1或多次
* `.` 通配符，匹配任何一个字符
* `_` 下划线，匹配一个符号
* `-` 连接符，连接两个字母或数值
* `( )` 字符组，一般与`-`连用
* `[ ]` 匹配`[ ]`中任意一个字符

常用正则组合：
* `^$`只匹配本地路由
* `.*`匹配所有路由
* `^100`匹配AS100、1001等邻居的路由
* `^100_`只匹配AS100邻居发的路由
* `_100$`匹配AS100始发的路由
* `_100_`匹配经过AS100的路由

## BGP补充知识点
BGP对等体组peer group：具有某些相同属性的对等体集合，可分为IBGP或EBGP对等体组

BGP团体属性：一组具有相同特征目的地址的集合，与所在AS无关，一条路由可以有多个团体属性。

公认团体属性
INTERNET：有这一属性的路由可以被通告给所有对等体。路由缺省属于该团体
NO_EXPORT：该团体路由不能被发布到本地AS外，若使用联盟，不能发布到联盟外
NO_ADVERTISE：不能被通告任何BGP对等体
NO_EXPORT_SUBCONFED：不能被发布到任何其他AS

BGP聚合
两种聚合：手动、自动
自动：聚合为自然路由。只能引入IGP子网路由聚合，不能对BGP邻居学来的或network发布的路由进行聚合。
手动：手动配置灵活的聚合，可以对从BGP邻居学习的、引入IGP的、network生成的路由聚合

BGP反射
作用：可代替IBGP对等体全连接
原理：允许设备从IBGP对等体接收到的路由信息发布给特定IBGP对等体，这些网络设备称为路由反射器。